using Compal.MESComponent;
using System;
using System.Collections;
using System.Collections.Generic;
using System.Data;
using sDEM2100.Utils;
using System.Globalization;
using System.Data.SqlClient;
using System.Linq;
using System.Text;

namespace sDEM2100.DataGateway
{
    class FPYDeepDiveOperator
    {
        private InfoLightDBTools mDBTools;
        private InfoLightDBTools mDCDBTools;
        private object[] mClientInfo;
        public FPYDeepDiveOperator(object[] clientInfo, string dbName)
        {
            mDBTools = new InfoLightDBTools(clientInfo, dbName);
            mDCDBTools = new InfoLightDBTools(clientInfo, "DC");
            mClientInfo = clientInfo;
            //       mDBmsTools = new InfoLightMSTools(clientInfo, "WARROOM");
        }
        public DataTable GetFpyDataByLob(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            return GetFpyDataByLob(vPlant, vSapPlant, vDateType, vQCond, "FPY", "DESC", 10);
        }
        public DataTable GetFpyDataByLob(string vPlant, string vSapPlant, string vDateType, string vQCond, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";

            string sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select a.model_serial as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a  
                                 where a.plant_code like :sap and a.bu_code='PCBG' and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql +
                                 @"    and a.process='FATP'                                                                    
                                 group by a.model_serial) x,
                                (select a.model_serial as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                      and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql +
                                 @"   and a.process='FATP' " + getSubProcess("FATP", strCust) + @"                                      
                                      group by a.model_serial) y                                       
                                where x.catalogy=y.catalogy  ";
            if (vOrderBy == "FPY")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input  ";
            sql += vOrderAsc + @" ) a where fpy >0 and rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLobMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,x.error_input,                                   
                                   case
                                     when y.input = 0 then
                                      0 
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select a.model_serial as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG' and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql +
                                 @"    and a.process='FATP'                                      
                                 group by a.model_serial) x,
                                (select a.model_serial as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                      and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql +
                                 @"   and a.process='FATP'  " + getSubProcess("FATP", strCust) + @"                                       
                                      group by a.model_serial) y                                       
                                where x.catalogy=y.catalogy  ";
            if (vOrderBy == "FPY")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input  ";
            sql += vOrderAsc + @" ) a where rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLobSMT(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            return GetFpyDataByLobSMT(vPlant, vSapPlant, vDateType, vQCond, "", "FPY", "DESC", 10);
        }
        public DataTable GetFpyDataByLobSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
            {
                if (vLine.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                sql1 += @" and a.line_name = :line ";
            }
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            string sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select a.model_serial as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a
                                 where a.plant_code like :sap and a.bu_code='PCBG'  " + sql1 + strExSql +
                                 @"    and a.process='SMT'                                 
                                 group by a.model_serial) x,
                                (select a.model_serial as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                      " + sql1 + strExSql +
                                 @"   and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @" 
                                      group by a.model_serial) y                                       
                                where x.catalogy=y.catalogy  ";
            if (vOrderBy == "FPY")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input  ";
            sql += vOrderAsc + @" ) a where fpy >0 and rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLobSMTMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
            {
                if (vLine.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                sql1 += @" and a.line_name = :line ";
            }
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            string sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,x.error_input,                                 
                                   case
                                     when y.input = 0 then
                                      0 
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select a.model_serial as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG'  " + sql1 + strExSql +
                                 @"    and a.process='SMT'                                  
                                 group by a.model_serial) x,
                                (select a.model_serial as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                      " + sql1 + strExSql +
                                 @"   and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @" 
                                      group by a.model_serial) y                                       
                                where x.catalogy=y.catalogy  ";
            if (vOrderBy == "FPY")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input  ";
            sql += vOrderAsc + @" ) a where rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLobInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            return GetFpyDataByLobInsightSMT(vPlant, vSapPlant, vDateType, vQCond, "", "FPY", "DESC", 10);
        }
        public DataTable GetFpyDataByLobInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
            {
                if (vLine.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                sql1 += @" and a.line_name = :line ";
            }
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            string sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end Insightfpy 
                                from                             
                                (select a.model_serial as catalogy,  
                                   NVL(sum(a.gap_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG'  " + sql1 + strExSql +
                                 @"    and a.process='SMT'                                       
                                 group by a.model_serial) x,
                                (select a.model_serial as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                      " + sql1 + strExSql +
                                 @"   and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @" 
                                      group by a.model_serial) y                                       
                                where x.catalogy=y.catalogy  ";
            if (vOrderBy == "FPY")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input  ";
            sql += vOrderAsc + @" ) a where Insightfpy >0 and rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLobInsightSMTMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
            {
                if (vLine.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                sql1 += @" and a.line_name = :line ";
            }
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            string sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,x.error_input,                                 
                                   case
                                     when y.input = 0 then
                                      0 
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end Insightfpy 
                                from                             
                                (select a.model_serial as catalogy,  
                                   NVL(sum(a.gap_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG'  " + sql1 + strExSql +
                                 @"    and a.process='SMT'                                         
                                 group by a.model_serial) x,
                                (select a.model_serial as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                      " + sql1 + strExSql +
                                 @"   and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @" 
                                      group by a.model_serial) y                                       
                                where x.catalogy=y.catalogy  ";
            if (vOrderBy == "FPY")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input  ";
            sql += vOrderAsc + @" ) a where rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataGapInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", sqlType1 = "", sqlType2 = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
            {
                sqlType1 = " a.work_date ";
                sqlType2 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType1 = " to_char(to_date(a.work_date,'YYYYMMDD'),'IYYYIW') ";
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
            }
            else
            {
                sqlType1 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
                sqlType2 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
            }
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
                sql1 += @" and a.line_name = :line ";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            string sql = @"select catalogy,fpy,insightfpy,(fpy-insightfpy) as gap from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy ,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     else
                                      round((1 - x.gap_input / y.input) * 100, 2)
                                   end insightfpy 
                                from                             
                                (select " + sqlType1 + @" as ordercata, " + sqlType2 + @" as catalogy,
                                   NVL(sum(a.gap_qty), 0) as gap_input,NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG'  " + sql1 + strExSql +
                                 @"    and a.process='SMT'                                                                      
                                 group by " + sqlType1 + "," + sqlType2 + @") x,
                                (select " + sqlType1 + @" as ordercata, " + sqlType2 + @" as catalogy,
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                      " + sql1 + strExSql +
                                 @"   and a.process='SMT' " + getSubProcess("SMT", strCust) + @"                                      
                                      group by " + sqlType1 + "," + sqlType2 + @") y                                       
                                where x.catalogy=y.catalogy and x.ordercata=y.ordercata ";
            sql += " order by y.ordercata  ";
            sql += vOrderAsc + @" ) a where rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                ht.Add("qcond", DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-6).ToString("yyyyMMdd"));
                ht.Add("qcond2", vQCond);
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-49);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.AddDays(-49).ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
            {
                ht.Add("qcond", DateTime.ParseExact(vQCond.Replace("M", "") + "01", "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-6).ToString("yyyyMMdd"));
                ht.Add("qcond2", vQCond.Replace("M", "") + "31");
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataGapInsightSMTMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", sqlType1 = "", sqlType2 = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
            {
                sqlType1 = " a.work_date ";
                sqlType2 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType1 = " to_char(to_date(a.work_date,'YYYYMMDD'),'IYYYIW') ";
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
            }
            else
            {
                sqlType1 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
                sqlType2 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
            }
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
                sql1 += @" and a.line_name = :line ";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            string sql = @"select catalogy,input,error_input,gap_input,fpy,insightfpy,(fpy-insightfpy) as gap from 
                            (select x.catalogy,
                                   y.input as input,x.error_input, x.gap_input,                               
                                   case
                                     when y.input = 0 then
                                      0 
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy ,
                                   case
                                     when y.input = 0 then
                                      0 
                                     else
                                      round((1 - x.gap_input / y.input) * 100, 2)
                                   end insightfpy  
                                from                             
                                (select " + sqlType1 + @" as ordercata, " + sqlType2 + @" as catalogy,
                                   NVL(sum(a.gap_qty), 0) as gap_input,NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG'  " + sql1 + strExSql +
                                 @"    and a.process='SMT'                                                                            
                                 group by " + sqlType1 + "," + sqlType2 + @") x,
                                (select " + sqlType1 + @" as ordercata, " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                      " + sql1 + strExSql +
                                 @"   and a.process='SMT' " + getSubProcess("SMT", strCust) + @"                                       
                                      group by " + sqlType1 + "," + sqlType2 + @") y                                       
                                where x.catalogy=y.catalogy and x.ordercata=y.ordercata ";
            sql += " order by y.ordercata  ";
            sql += vOrderAsc + @" ) a where rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                ht.Add("qcond", DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-6).ToString("yyyyMMdd"));
                ht.Add("qcond2", vQCond);
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-49);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.AddDays(-49).ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
            {
                ht.Add("qcond", DateTime.ParseExact(vQCond.Replace("M", "") + "01", "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-6).ToString("yyyyMMdd"));
                ht.Add("qcond2", vQCond.Replace("M", "") + "31");
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLobInsight(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            return GetFpyDataByLobInsight(vPlant, vSapPlant, vDateType, vQCond, "", "FPY", "DESC", 10);
        }
        public DataTable GetFpyDataByLobInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
                sql1 += @" and a.line_name = :line ";

            string sql = @"select * from 
                            (select x.catalogy,                             
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end Insightfpy, 
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.fpy_error_input then
                                      0
                                     else
                                      round((1 - x.fpy_error_input / y.input) * 100, 2)
                                   end fpy,
                                   x.error_input,
                                   y.input as input 
                                from                             
                                (select a.model_serial as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) as error_input, NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as fpy_error_input
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0  and a.bu_code='PCBG'  " + sql1 + strExSql +
                                 @"    and a.process='FATP'                                       
                                 group by a.model_serial) x,
                                (select a.model_serial as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 + strExSql +
                                 @"   and a.process='FATP' ";
            if (vLine == "")
                sql += getSubProcess(strMProcess, strCust);
            sql += @"        group by a.model_serial) y                                       
                                where x.catalogy=y.catalogy  ";
            if (vOrderBy == "FPY")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input  ";
            sql += vOrderAsc + @" ) a where Insightfpy >0 and rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLobInsightMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
                sql1 += @" and a.line_name = :line ";

            string sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,x.error_input,                                 
                                   case
                                     when y.input = 0 then
                                      0 
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end Insightfpy , 
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.fpy_error_input then
                                      0
                                     else
                                      round((1 - x.fpy_error_input / y.input) * 100, 2)
                                   end fpy
                                from                             
                                (select a.model_serial as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) as error_input, NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as fpy_error_input  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG'  " + sql1 + strExSql +
                                 @"    and a.process='FATP' and instr(:cust,a.cust_no ) > 0                                    
                                 group by a.model_serial) x,
                                (select a.model_serial as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0
                                      and a.bu_code='PCBG' 
                                      " + sql1 + strExSql +
                                 @"   and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @" 
                                      group by a.model_serial) y                                       
                                where x.catalogy=y.catalogy  ";
            if (vOrderBy == "FPY")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input  ";
            sql += vOrderAsc + @" ) a where rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataByLobPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            return GetFpyDataByLobPcbLrr(vPlant, vSapPlant, vDateType, vQCond, "", "LRR", "DESC", 10);
        }
        public DataTable GetFpyDataByLobPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows, bool bFloor = false)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
                sql1 += @" and a.line_name = :line ";

            string sql = @"select * from 
                            (select x.catalogy,  
                                    y.input as input ,                           
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end pcblrr,                                  
                                   x.error_input
                                from                             
                                (select a.model_serial as catalogy,  
                                   NVL(sum(a.qty), 0) as error_input 
                                 from (";
            if (bFloor)
                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name)||'-'||b.DISPLAY_LINE as model_serial from sfism4.R_DAILY_PCBALRR_T a,sfis1.C_LINE_DEF_T b WHERE a.test_line=b.mes_line
                                          AND b.DISPLAY_LINE IN ('2F','3F')";
            else
                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a";
            sql += @")a 
                                 where a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                 @"  group by a.model_serial) x,
                                (select a.model_serial as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (";
            if (bFloor)
                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name)||'-'||b.DISPLAY_LINE as model_serial from sfism4.r_kpi_fpy_t a,sfis1.C_LINE_DEF_T b WHERE a.LINE_NAME=b.mes_line
                                          AND b.DISPLAY_LINE IN ('2F','3F')";
            else
                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a";
            sql += @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 + strExSql +
                                 @"   and a.process='FATP' ";
            if (vLine == "")
                sql += getSubProcess(strMProcess, strCust);
            sql += @"        group by a.model_serial) y                                       
                                where x.catalogy=y.catalogy order by ";
            if (bFloor)
                sql += @"SUBSTR(x.catalogy,INSTR(x.catalogy,'-',-1)+1),x.catalogy,";
            if (vOrderBy == "LRR")
                sql += @"          case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " y.input  ";
            sql += vOrderAsc + @" ) a where pcblrr >0 and rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLobPcbLrrMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows, bool bFloor = false)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
                sql1 += @" and a.line_name = :line ";
            string sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,x.error_input,                                 
                                   case
                                     when y.input = 0 then
                                      0 
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end pcblrr 
                                from                             
                                (select a.model_serial as catalogy,  
                                   NVL(sum(a.qty), 0) as error_input 
                                 from (";
            if (bFloor)
                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name)||'-'||b.DISPLAY_LINE as model_serial from sfism4.R_DAILY_PCBALRR_T a,sfis1.C_LINE_DEF_T b WHERE a.test_line=b.mes_line
                                          AND b.DISPLAY_LINE IN ('2F','3F')";
            else
                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a";
            sql += @")a 
                                 where a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                 @"  group by a.model_serial) x,
                                (select a.model_serial as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (";
            if (bFloor)
                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name)||'-'||b.DISPLAY_LINE as model_serial from sfism4.r_kpi_fpy_t a,sfis1.C_LINE_DEF_T b WHERE a.LINE_NAME=b.mes_line
                                          AND b.DISPLAY_LINE IN ('2F','3F')";
            else
                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a";
            sql += @")a 
                                where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0
                                      and a.bu_code='PCBG' 
                                      " + sql1 + strExSql +
                                 @"   and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @" 
                                      group by a.model_serial) y                                       
                                where x.catalogy=y.catalogy order by ";
            if (bFloor)
                sql += @"SUBSTR(x.catalogy,INSTR(x.catalogy,'-',-1)+1),x.catalogy,";
            if (vOrderBy == "LRR")
                sql += @"          case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " y.input  ";
            sql += vOrderAsc + @" ) a where rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataPcbLrrIOP(string vPlant, string vSapPlant, string vDateType, string vQCond, string vType, string vOrderBy, string vOrderAsc, int vRows, bool bMinus)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strProcess = "ASSY";
            string strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //if (strExType == "DOCK")
                //    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                //else
                //    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            if (vSapPlant.IndexOf("-") > -1)
            {
                string[] bb = vSapPlant.Split('-');
                vSapPlant = bb[0];
            }
            strCust = getCust(vPlant);
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            //if (strShift != "ALL")
            //    sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vType.IndexOf("_") > -1)
            {
                string[] bb = vType.Split('_');
                vType = bb[0];
                strProcess = bb[1];
                //if (strExType == "DOCK")
                //    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                //else
                //    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }

            string sql = "";
            if (vType == "LOB")
                sql = @"SELECT catalogy,input,lrr as pcblrr,error_input FROM
                         (SELECT * FROM
                            (SELECT x.catalogy,y.input,
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end lrr,x.error_input FROM 
                                   (SELECT a.model_serial AS catalogy,sum(a.qty) AS error_input FROM 
                                   (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a)a,sfis1.C_DATA_DICTIONARY_T c  
                                   WHERE a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                        and instr(:cust,a.cust_no ) > 0  AND c.DATA_VALUE=:plant2" + sql1 + @"
                                   GROUP BY a.model_serial)x,
                                     (SELECT a.model_serial AS catalogy,sum(a.qty) AS INPUT FROM 
                                     (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_MB_IOP_T a)a,sfis1.C_PLANT_DEF_T b,sfis1.C_DATA_DICTIONARY_T c  
                                        WHERE a.from_plant=b.MES_PLANT AND a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND b.RMS_PLANT =:plant AND b.bu_code = 'PCBG'
                                                AND c.DATA_VALUE=:plant2 AND a.LINE_NAME NOT LIKE '%REP%' AND a.LINE_NAME NOT LIKE '%NPI%' AND a.LINE_NAME NOT LIKE '%TNB%' " + sql1 + @"
                                    GROUP BY a.model_serial)y
                                    WHERE x.catalogy=y.catalogy) a
                            order by a." + vOrderBy + " " + vOrderAsc + ") where rownum <=:rowcount";
            else if (vType == "LINE")
                sql = @"SELECT catalogy,input,lrr as pcblrr,error_input FROM
                         (SELECT * FROM
                            (SELECT x.catalogy,y.input,
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end lrr,x.error_input FROM 
                                   (SELECT a.test_line AS catalogy,sum(a.qty) AS error_input FROM 
                                   (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a)a,sfis1.C_DATA_DICTIONARY_T c,sfis1.c_line_def_t d    
                                   WHERE a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                            and d.mes_line=a.test_line and d.sub_process=:process and instr(:cust,a.cust_no ) > 0  AND c.DATA_VALUE=:plant2" + sql1 + @"
                                   GROUP BY a.test_line)x,
                                     (SELECT a.line_name AS catalogy,sum(a.qty) AS INPUT FROM 
                                     (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_MB_IOP_T a)a,sfis1.C_PLANT_DEF_T b,sfis1.C_DATA_DICTIONARY_T c,sfis1.c_line_def_t d    
                                        WHERE a.from_plant=b.MES_PLANT AND a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND b.RMS_PLANT =:plant AND b.bu_code = 'PCBG'  
                                            and d.mes_line=a.line_name and d.sub_process=:process AND c.DATA_VALUE=:plant2 AND a.LINE_NAME NOT LIKE '%REP%' AND a.LINE_NAME NOT LIKE '%NPI%' AND a.LINE_NAME NOT LIKE '%TNB%' " + sql1 + @"
                                    GROUP BY a.line_name)y
                                    WHERE x.catalogy=y.catalogy) a
                            order by a." + vOrderBy + " " + vOrderAsc + ") where rownum <=:rowcount";

            ht.Clear();
            ht.Add("plant2", vPlant.Replace("VN76", "VNP1"));
            ht.Add("plant", vSapPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vType == "LINE")
                ht.Add("process", strProcess);
            ht.Add("rowcount", vRows);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataGapInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", sqlType1 = "", sqlType2 = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
            {
                sqlType1 = " a.work_date ";
                sqlType2 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType1 = " to_char(to_date(a.work_date,'YYYYMMDD'),'IYYYIW') ";
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
            }
            else
            {
                sqlType1 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
                sqlType2 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
            }
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
                sql1 += @" and a.line_name = :line ";

            string sql = @"select catalogy,fpy,insightfpy,(fpy-insightfpy) as gap  from 
                            (select x.catalogy,                      
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy ,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     else
                                      round((1 - (x.gap_input + x.error_input) / y.input) * 100, 2)
                                   end insightfpy 
                                from                             
                                (select " + sqlType1 + @" as ordercata, " + sqlType2 + @" as catalogy,
                                   NVL(sum(a.gap_qty), 0) as gap_input,NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0 " + sql1 + strExSql +
                                 @"    and a.process='FATP'                                                                      
                                 group by " + sqlType1 + "," + sqlType2 + @") x,
                                (select " + sqlType1 + @" as ordercata, " + sqlType2 + @" as catalogy,
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0 
                                      " + sql1 + strExSql +
                                 @"   and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                                      
                                      group by " + sqlType1 + "," + sqlType2 + @") y                                       
                                where x.catalogy=y.catalogy and x.ordercata=y.ordercata ";
            sql += " order by y.ordercata  ";
            sql += vOrderAsc + @" ) a where rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                ht.Add("qcond", DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-6).ToString("yyyyMMdd"));
                ht.Add("qcond2", vQCond);
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-49);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.AddDays(-49).ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
            {
                ht.Add("qcond", DateTime.ParseExact(vQCond.Replace("M", "") + "01", "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-6).ToString("yyyyMMdd"));
                ht.Add("qcond2", vQCond.Replace("M", "") + "31");
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataGapInsightMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", sqlType1 = "", sqlType2 = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
            {
                sqlType1 = " a.work_date ";
                sqlType2 = " a.work_date ";
            }
            else if (vDateType == "Weekly" || vDateType == "Range")
            {
                sqlType1 = " to_char(to_date(a.work_date,'YYYYMMDD'),'IYYYIW') ";
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
            }
            else
            {
                sqlType1 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
                sqlType2 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
            }
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vLine != "")
                sql1 += @" and a.line_name = :line ";

            string sql = @"select catalogy,input,error_input,gap_input,fpy,insightfpy,(fpy-insightfpy) as gap from 
                            (select x.catalogy,
                                   y.input as input,x.error_input, x.gap_input,                               
                                   case
                                     when y.input = 0 then
                                      0 
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy ,
                                   case
                                     when y.input = 0 then
                                      0 
                                     else
                                      round((1 - (x.gap_input + x.error_input) / y.input) * 100, 2)
                                   end insightfpy  
                                from                             
                                (select " + sqlType1 + @" as ordercata, " + sqlType2 + @" as catalogy,
                                   NVL(sum(a.gap_qty), 0) as gap_input,NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0 " + sql1 + strExSql +
                                 @"    and a.process='FATP'                                                                            
                                 group by " + sqlType1 + "," + sqlType2 + @") x,
                                (select " + sqlType1 + @" as ordercata, " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0 
                                      " + sql1 + strExSql +
                                 @"   and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                                       
                                      group by " + sqlType1 + "," + sqlType2 + @") y                                       
                                where x.catalogy=y.catalogy and x.ordercata=y.ordercata ";
            sql += " order by y.ordercata  ";
            sql += vOrderAsc + @" ) a where rownum <=:rowcount ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vLine != "")
                ht.Add("line", vLine);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                ht.Add("qcond", DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-6).ToString("yyyyMMdd"));
                ht.Add("qcond2", vQCond);
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-49);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.AddDays(-49).ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
            {
                ht.Add("qcond", DateTime.ParseExact(vQCond.Replace("M", "") + "01", "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-6).ToString("yyyyMMdd"));
                ht.Add("qcond2", vQCond.Replace("M", "") + "31");
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByGroup(string vPlant, string vSapPlant, string vDateType, string vQCond, string vOrderBy, string vOrderAsc)
        {
            return GetFpyDataByGroup(vPlant, vSapPlant, vDateType, vQCond, "", "", "", vOrderBy, vOrderAsc);
        }
        public DataTable GetFpyDataByGroup(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            return GetFpyDataByGroup(vPlant, vSapPlant, vDateType, vQCond, "", "", "", "FPY", "ASC");
        }
        public DataTable GetFpyDataByGroup(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vOrderBy, string vOrderAsc)
        {
            return GetFpyDataByGroup(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", vOrderBy, vOrderAsc);
        }
        public DataTable GetFpyDataByGroup(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB)
        {
            return GetFpyDataByGroup(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", "FPY", "ASC");
        }
        public DataTable GetFpyDataByGroup(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc, bool bShowZero = true)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += " and a.model_serial = :lob ";
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
            {
                if (vLine.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                sql1 += " and a.line_name = :line ";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = "";
            if (vLOB != "")
            {
                sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end fpy from
                                  (select d.data_value as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty)+sum(a.refail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a    
                                    where a.plant_code like :sap
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'    
                                          and instr(:cust,a.cust_no ) >0  
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_code
                                          and d.data_type = 'FPY_GROUP' 
                                          and ((a.line_name not like '%REP%') or
                                         (a.line_name like '%REP%' and
                                         TRIM(a.group_name) not in
                                         ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL', 'TPDL_IN')))
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         and a.group_name not like '%OFF'
                                         and a.group_name not like '%_BR%'
                                         and a.line_name not like '%TNB%'
                                      group by d.data_value order by sum(a.fail_qty)+sum(a.refail_qty) desc) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG' 
                                              and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @" 
                                       ) y  ";
                if (vOrderBy == "FPY")
                    sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end ";
                else
                    sql += " order by NVL(x.fail_qty, 0)  ";
                sql += vOrderAsc + @" ) a where rownum <=10 ";
                if (!bShowZero)
                    sql += " and a.input > 0";
            }
            else
            {
                sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end fpy from
                                  (select d.data_value as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty)+sum(a.refail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a
                                    where a.plant_code like :sap                                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'                                          
                                          and instr(:cust,a.cust_no ) >0  
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_code
                                          and d.data_type = 'FPY_GROUP' 
                                          and ((a.line_name not like '%REP%') or
                                         (a.line_name like '%REP%' and
                                         TRIM(a.group_name) not in
                                         ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL', 'TPDL_IN')))
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         and a.group_name not like '%OFF'
                                         and a.group_name not like '%_BR%'
                                         and a.line_name not like '%TNB%'
                                      group by d.data_value order by sum(a.fail_qty)+sum(a.refail_qty) desc) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG' 
                                              and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                                
                                       ) y ";
                if (vOrderBy == "FPY")
                    sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end ";
                else
                    sql += " order by NVL(x.fail_qty, 0)  ";
                sql += vOrderAsc + @" ) a where rownum <=10  ";
                if (!bShowZero)
                    sql += " and a.input > 0";
            }
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataByGru(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB)
        {
            return GetFpyDataByGru(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", "FPY", "ASC", false);
        }
        public DataTable GetFpyDataByGru(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vOrderBy, string vOrderAsc)
        {
            return GetFpyDataByGru(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", vOrderBy, vOrderAsc, false);
        }
        public DataTable GetFpyDataByGru(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc, bool bShowZero = true)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += " and a.model_serial = :lob ";
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
            {
                if (vLine.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                sql1 += " and a.line_name = :line ";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = "";
            if (vLOB != "")
            {
                sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                case when x.fpy_grouping='STRU2' then NVL(x.fail_qty, 0)-nvl(z.fail_qty,0) else nvl(x.fail_qty, 0) end as input,                     
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  case when x.fpy_grouping='STRU2' then round((1 - (NVL(x.fail_qty, 0)-nvl(z.fail_qty,0)) / nvl(y.input, 0)) * 100, 2) 
                                     else round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                                   end 
                               end fpy from
                                  (select d.data_value as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty)+sum(a.refail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a    
                                    where a.plant_code like :sap
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'    
                                          and instr(:cust,a.cust_no ) >0  
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_code
                                          and d.data_type = 'FPY_GROUP' 
                                          and d.data_value not in ('AFT','KB AOI','SWDL','RUNIN','TPDL') 
                                          and ((a.line_name not like '%REP%') or
                                         (a.line_name like '%REP%' and
                                         TRIM(a.group_name) not in
                                         ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL', 'TPDL_IN')))
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         and a.group_name not like '%OFF'
                                         and a.group_name not like '%_BR%'
                                         and a.line_name not like '%TNB%'
                                      group by d.data_value) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG' 
                                              and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @" 
                                       ) y ,
                                        (select sum(a.fail_qty) as fail_qty                 
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a    
                                    where a.plant_code like :sap
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'    
                                          and instr(:cust,a.cust_no ) >0  
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name =  'STRU2_BR'   
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU_BR', 'STRU2_BR', 'AFT_BR', 'TFF_BR', 'TPDL_BR', 'TPDL_IN_BR')))   
                                            ) z";
                if (vOrderBy == "FPY")
                    sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  case when x.fpy_grouping='STRU2' then round((1 - (NVL(x.fail_qty, 0)-nvl(z.fail_qty,0)) / nvl(y.input, 0)) * 100, 2) 
                                     else round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                                   end 
                               end ";
                else
                    sql += " order by case when x.fpy_grouping='STRU2' then NVL(x.fail_qty, 0)-nvl(z.fail_qty,0) else nvl(x.fail_qty, 0) end ";
                sql += vOrderAsc + @" ) a where rownum <=10 ";
                if (!bShowZero)
                    sql += " and a.input > 0";
            }
            else
            {
                sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                case when x.fpy_grouping='STRU2' then NVL(x.fail_qty, 0)-nvl(z.fail_qty,0) else nvl(x.fail_qty, 0) end as input,     
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  case when x.fpy_grouping='STRU2' then round((1 - (NVL(x.fail_qty, 0)-nvl(z.fail_qty,0)) / nvl(y.input, 0)) * 100, 2) 
                                     else round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                                   end 
                               end fpy from
                                  (select d.data_value as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty)+sum(a.refail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a
                                    where a.plant_code like :sap                                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'                                          
                                          and instr(:cust,a.cust_no ) >0  
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_code
                                          and d.data_type = 'FPY_GROUP' 
                                          and d.data_value not in ('AFT','KB AOI','SWDL','RUNIN','TPDL') 
                                          and ((a.line_name not like '%REP%') or
                                         (a.line_name like '%REP%' and
                                         TRIM(a.group_name) not in
                                         ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL', 'TPDL_IN')))
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         and a.group_name not like '%OFF'
                                         and a.group_name not like '%_BR%'
                                         and a.line_name not like '%TNB%'
                                      group by d.data_value) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG' 
                                              and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                                
                                       ) y,
                                       (select sum(a.fail_qty) as fail_qty                 
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a
                                    where  a.plant_code like :sap
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'    
                                          and instr(:cust,a.cust_no ) >0  
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name =  'STRU2_BR'   
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU_BR', 'STRU2_BR', 'AFT_BR', 'TFF_BR', 'TPDL_BR', 'TPDL_IN_BR')))   
                                        ) z ";
                if (vOrderBy == "FPY")
                    sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  case when x.fpy_grouping='STRU2' then round((1 - (NVL(x.fail_qty, 0)-nvl(z.fail_qty,0)) / nvl(y.input, 0)) * 100, 2) 
                                     else round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                                   end 
                               end ";
                else
                    sql += " order by case when x.fpy_grouping='STRU2' then NVL(x.fail_qty, 0)-nvl(z.fail_qty,0) else nvl(x.fail_qty, 0) end  ";
                sql += vOrderAsc + @" ) a where rownum <=10  ";
                if (!bShowZero)
                    sql += " and a.input > 0";
            }
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataByGroupSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByGroupSMT(vPlant, vSapPlant, vDateType, vQCond, "", "", "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByGroupSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, int vRows)
        {
            return GetFpyDataByGroupSMT(vPlant, vSapPlant, vDateType, vQCond, "", "", "", "FPY", "DESC", vRows);
        }
        public DataTable GetFpyDataByGroupSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByGroupSMT(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByGroupSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, int vRows)
        {
            return GetFpyDataByGroupSMT(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", "FPY", "DESC", vRows);
        }
        public DataTable GetFpyDataByGroupSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += " and a.model_serial = :lob ";
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
            {
                sql1 += " and a.line_name = :line ";
                if (vLine.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = "";

            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            if (vLOB != "")
            {
                sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end fpy from
                                  (select d.data_value as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty)+sum(a.refail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a     
                                    where a.plant_code like :sap
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'     
                                          and a.from_db like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_code
                                          and d.data_type = 'FPY_GROUP_SMT' 
                                          and a.wo_master='YES'
                                          and a.group_name not like '%_BR'
                                          and a.group_name not like 'REPAIR%'
                                          and a.group_name not like 'OFFLINE%'
                                          and a.group_name NOT LIKE 'TNB%'
                                          and a.group_name NOT LIKE 'VE%'
                                          and a.group_name NOT LIKE 'VI%'
                                          and a.group_name NOT LIKE 'AI%'
                                          and a.group_name NOT LIKE 'SMT_VI%'
                                          and a.group_name NOT LIKE 'SUB%'  
                                          and a.group_name NOT LIKE 'SPI%' 
                                          and a.group_name NOT LIKE 'PRE_A%'                                        
                                          and a.line_name not like '%TNB%'
                                      group by d.data_value order by sum(a.fail_qty)+sum(a.refail_qty) desc) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG' 
                                                " + sql1 + strExSql + @"
                                              and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"     
                                       ) y  ";
                if (vOrderBy == "FPY")
                    sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end ";
                else
                    sql += " order by NVL(x.fail_qty, 0)  ";
                sql += vOrderAsc + @" ) a where rownum <= :rowcount  ";
            }
            else
            {
                sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end fpy from
                                  (select d.data_value as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty)+sum(a.refail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a     
                                    where a.plant_code like :sap                                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_code
                                          and d.data_type = 'FPY_GROUP_SMT' 
                                          and a.wo_master='YES'
                                         and a.group_name not like '%_BR'
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         AND a.GROUP_NAME NOT LIKE 'TNB%'
                                         AND a.GROUP_NAME NOT LIKE 'VE%'
                                         AND a.GROUP_NAME NOT LIKE 'VI%'
                                         AND a.GROUP_NAME NOT LIKE 'AI%'
                                         AND a.GROUP_NAME NOT LIKE 'SMT_VI%'
                                         AND a.GROUP_NAME NOT LIKE 'SUB%'  
                                         AND a.GROUP_NAME NOT LIKE 'SPI%' 
                                         AND a.GROUP_NAME NOT LIKE 'PRE_A%'                                        
                                         and a.line_name not like '%TNB%'
                                      group by d.data_value order by sum(a.fail_qty)+sum(a.refail_qty) desc) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG' 
                                                " + sql1 + strExSql + @"
                                              and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"                                          
                                       ) y ";
                if (vOrderBy == "FPY")
                    sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end ";
                else
                    sql += " order by NVL(x.fail_qty, 0)  ";
                sql += vOrderAsc + @" ) a where rownum <= :rowcount  ";
            }
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByGroupSMTMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
            {
                sql1 += " and a.line_name = :line ";
                if (vLine.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = "";

            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                nvl(x.fail_qty, 0) as input,nvl(x.fail_qty, 0) as error_input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0 
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end fpy from
                                  (select d.data_value as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty)+sum(a.refail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a     
                                    where a.plant_code like :sap                                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_code
                                          and d.data_type = 'FPY_GROUP_SMT' 
                                          and a.wo_master='YES'
                                         and a.group_name not like '%_BR'
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         AND a.group_name not like 'TNB%'
                                         AND a.group_name not like 'VE%'
                                         AND a.group_name not like 'VI%'
                                         AND a.group_name not like 'AI%'
                                         AND a.group_name not like 'SMT_VI%'
                                         AND a.group_name not like 'SUB%'  
                                         AND a.group_name not like 'SPI%' 
                                         AND a.group_name not like 'PRE_A%'                                        
                                         and a.line_name not like '%TNB%'
                                      group by d.data_value order by sum(a.fail_qty)+sum(a.refail_qty) desc) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG' 
                                                " + sql1 + strExSql + @"
                                              and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"                                           
                                       ) y ";
            if (vOrderBy == "FPY")
                sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end ";
            else
                sql += " order by NVL(x.fail_qty, 0)  ";
            sql += vOrderAsc + @" ) a where rownum <= :rowcount  ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByGroupByLineSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vProcess, string vGroup, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vGroup != "")
                sql1 += " and d.data_value= :groupname ";
            if (vProcess != "")
                sql1 += " and c.sub_process=:subprocess ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = "";

            sql = @"select a.* from (
                            select  
                                x.catalogy as catalogy,                           
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(x.output_qty, 0) = 0 then
                                  0
                                 when nvl(x.output_qty, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(x.output_qty, 0)) * 100, 2)
                               end fpy from
                                  (select a.line_name as catalogy,
                                         sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty)+sum(a.refail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty)+sum(a.refail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a ,sfis1.c_line_def_t c
                                    where a.plant_code like :sap                                    
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db like '%SMT%' 
                                          and a.line_name=c.mes_line
                                          and c.main_process='SMT' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_code
                                          and d.data_type = 'FPY_GROUP_SMT'                                          
                                          and a.wo_master='YES'
                                         and a.group_name not like '%_BR'
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         and a.group_name not like 'TNB%'
                                         and a.group_name not like 'VE%'
                                         and a.group_name not like 'VI%'
                                         and a.group_name not like 'AI%'
                                         and a.group_name not like'SMT_VI%'
                                         and a.group_name not like 'SUB%'  
                                         and a.group_name not like 'SPI%' 
                                         and a.group_name not like 'PRE_A%'                                        
                                         and a.line_name not like '%TNB%'                                         
                                      group by a.line_name order by sum(a.fail_qty)+sum(a.refail_qty) desc) x ";
            if (vOrderBy == "FPY")
                sql += @" order by case
                                 when nvl(x.output_qty, 0) = 0 then
                                  0
                                 when nvl(x.output_qty, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(x.output_qty, 0)) * 100, 2)
                               end ";
            else
                sql += " order by NVL(x.fail_qty, 0)  ";
            sql += vOrderAsc + @" ) a where rownum <= :rowcount  ";

            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vGroup != "")
                ht.Add("groupname", vGroup);
            if (vProcess != "")
                ht.Add("subprocess", vProcess);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByGroupInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByGroupInsightSMT(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByGroupInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, int vRows)
        {
            return GetFpyDataByGroupInsightSMT(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", "FPY", "DESC", vRows);
        }
        public DataTable GetFpyDataByGroupInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += " and a.model_serial = :lob ";
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
            {
                if (vLine.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                sql1 += @" and a.line_name = :line ";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = "";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            if (vLOB != "")
            {
                sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy from
                                  (select d.data_code as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'    
                                          and a.from_db like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_value
                                          and d.data_type = 'FPY_GROUP_INSIGHT_SMT' 
                                          and a.wo_master='YES'                                   
                                         and a.line_name not like '%TNB%'
                                      group by d.data_code order by sum(a.fail_qty) desc) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG' 
                                                " + sql1 + strExSql + @"
                                              and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"     
                                       ) y  ";
                if (vOrderBy == "FPY")
                    sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end ";
                else
                    sql += " order by NVL(x.fail_qty, 0)  ";
                sql += vOrderAsc + @" ) a where rownum <= :rowcount  ";
            }
            else
            {
                sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy from
                                  (select d.data_code as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a     
                                    where a.plant_code like :sap                                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_value 
                                          and d.data_type = 'FPY_GROUP_INSIGHT_SMT' 
                                          and a.wo_master='YES'                                     
                                         and a.line_name not like '%TNB%'
                                      group by d.data_code order by sum(a.fail_qty) desc) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG' 
                                                " + sql1 + strExSql + @"
                                              and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"                                          
                                       ) y ";
                if (vOrderBy == "FPY")
                    sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end ";
                else
                    sql += " order by NVL(x.fail_qty, 0)  ";
                sql += vOrderAsc + @" ) a where rownum <= :rowcount  ";
            }
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByGroupGapInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += " and a.model_serial = :lob ";
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
            {
                if (vLine.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                sql1 += @" and a.line_name = :line ";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = "";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            if (vLOB != "")
            {
                sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy from
                                  (select d.data_code as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a  
                                    where a.plant_code like :sap
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'     
                                          and a.from_db like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_value
                                          and d.data_type = 'FPY_GROUP_INSIGHT_SMT' 
                                          and a.wo_master='YES'                                   
                                         and a.line_name not like '%TNB%'
                                      group by d.data_code order by sum(a.fail_qty) desc) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG' 
                                                " + sql1 + strExSql + @"
                                              and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"      
                                       ) y  ";
                if (vOrderBy == "FPY")
                    sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end ";
                else
                    sql += " order by NVL(x.fail_qty, 0)  ";
                sql += vOrderAsc + @" ) a where rownum <= :rowcount  ";
            }
            else
            {
                sql = @"select a.* from 
                        (select t1.catalogy,nvl(t1.insightfpy,0) as insightfpy,nvl(t2.fpy,0) as fpy,(nvl(t2.fpy,0)-nvl(t1.insightfpy,0)) as gap from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy from
                                  (select d.data_code as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap                                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = d.data_value 
                                          and d.data_type = 'FPY_GROUP_INSIGHT_SMT' 
                                          and a.wo_master='YES'                                     
                                         and a.line_name not like '%TNB%'
                                      group by d.data_code order by sum(a.fail_qty) desc) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG' 
                                                " + sql1 + strExSql + @"
                                              and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"                                          
                                       ) y 
                                ) t1
                        left outer join
                                (  
                                select  
                                    x.fpy_grouping as catalogy,                           
                                    nvl(x.fail_qty, 0) as input,
                                   case
                                     when nvl(y.input, 0) = 0 then
                                      0
                                     when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                      0
                                     else
                                      round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                                   end fpy from
                                      (select d.data_value as fpy_grouping,
                                             sum(a.pass_qty+a.repass_qty) as pass_qty,
                                             sum(a.fail_qty) as fail_qty                 
                                        from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                        where a.plant_code like :sap                                          
                                              and a.date_type='D'    
                                              and a.mo_type = 'ZP01'        
                                              and a.from_db like '%SMT%' " + sql1 + strExSql + @"
                                              and a.group_name = d.data_code
                                              and d.data_type = 'FPY_GROUP_SMT' 
                                              and a.wo_master='YES'
                                             and a.group_name not like '%_BR'
                                             and a.group_name not like 'REPAIR%'
                                             and a.group_name not like 'OFFLINE%'
                                             AND a.GROUP_NAME NOT LIKE 'TNB%'
                                             AND a.GROUP_NAME NOT LIKE 'VE%'
                                             AND a.GROUP_NAME NOT LIKE 'VI%'
                                             AND a.GROUP_NAME NOT LIKE 'AI%'
                                             AND a.GROUP_NAME NOT LIKE 'SMT_VI%'
                                             AND a.GROUP_NAME NOT LIKE 'SUB%'  
                                             AND a.GROUP_NAME NOT LIKE 'SPI%' 
                                             AND a.GROUP_NAME NOT LIKE 'PRE_A%'                                        
                                             and a.line_name not like '%TNB%'
                                          group by d.data_value order by sum(a.fail_qty)+sum(a.refail_qty) desc) x,  
                                          (select NVL(sum(a.output_qty),0) as input
                                            from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                            where a.plant_code like :sap 
                                                  and a.bu_code='PCBG' 
                                                    " + sql1 + strExSql + @"
                                                  and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"                                          
                                           ) y
                                        ) t2
                                       on t1.catalogy = t2.catalogy";

                sql += vOrderAsc + @" ) a where rownum <= :rowcount order by a.gap desc  ";
            }
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByGroupByLineGapInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vProcess, string vStation, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sql3 = "", sql = "";
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
                sql1 += " and a.line_name = :line ";
            if (vProcess != "")
                sql1 += " and c.sub_process=:process ";
            if (vStation != "")
            {
                sql3 += " and d.data_value = :station ";
                sql2 += " and d.data_code = :station ";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            sql = @"select a.* from 
                        (select t1.catalogy,nvl(t1.insightfpy,0) as insightfpy,nvl(t2.fpy,0) as fpy,(nvl(t2.fpy,0)-nvl(t1.insightfpy,0)) as gap from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy from
                                  (select a.line_name as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a  ,sfis1.c_line_def_t c
                                    where a.plant_code like :sap                                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db like '%SMT%' " + sql1 + strExSql + sql2 + @"
                                          and a.group_name = d.data_value 
                                          and d.data_type = 'FPY_GROUP_INSIGHT_SMT' and a.line_name=c.mes_line and c.main_process='SMT' 
                                          and a.wo_master='YES'                                     
                                         and a.line_name not like '%TNB%'
                                      group by a.line_name order by sum(a.fail_qty) desc) x,  
                                      (select a.line_name as fpy_grouping,
                                              NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a ,sfis1.c_line_def_t c 
                                        where a.plant_code like :sap 
                                              and a.bu_code='PCBG'  and a.line_name=c.mes_line
                                                " + sql1 + strExSql + @"
                                              and a.process='SMT' " + @"                 
                                              group by a.line_name                                  
                                       ) y  where x.fpy_grouping=y.fpy_grouping
                                ) t1
                        left outer join
                                (  
                                select  
                                    x.fpy_grouping as catalogy,                           
                                    nvl(x.fail_qty, 0) as input,
                                   case
                                     when nvl(y.input, 0) = 0 then
                                      0
                                     when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                      0
                                     else
                                      round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                                   end fpy from
                                      (select a.line_name as fpy_grouping,
                                             sum(a.pass_qty+a.repass_qty) as pass_qty,
                                             sum(a.fail_qty) as fail_qty                 
                                        from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a  ,sfis1.c_line_def_t c
                                        where a.plant_code like :sap                                          
                                              and a.date_type='D'    
                                              and a.mo_type = 'ZP01'        
                                              and a.from_db like '%SMT%' " + sql1 + strExSql + sql3 + @"
                                              and a.group_name = d.data_code
                                              and d.data_type = 'FPY_GROUP_SMT' and a.line_name=c.mes_line and c.main_process='SMT' 
                                              and a.wo_master='YES'
                                             and a.group_name not like '%_BR'
                                             and a.group_name not like 'REPAIR%'
                                             and a.group_name not like 'OFFLINE%'
                                             and a.group_name not like 'TNB%'
                                             and a.group_name not like 'VE%'
                                             and a.group_name not like 'VI%'
                                             and a.group_name not like 'AI%'
                                             and a.group_name not like 'SMT_VI%'
                                             and a.group_name not like 'SUB%'  
                                             and a.group_name not like 'SPI%' 
                                             and a.group_name not like 'PRE_A%'                                        
                                             and a.line_name not like '%TNB%'
                                          group by a.line_name order by sum(a.fail_qty)+sum(a.refail_qty) desc) x,  
                                          (select a.line_name as fpy_grouping,
                                                  NVL(sum(a.output_qty),0) as input
                                            from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a ,sfis1.c_line_def_t c 
                                            where a.plant_code like :sap 
                                                  and a.bu_code='PCBG'  and a.line_name=c.mes_line
                                                    " + sql1 + strExSql + @"
                                                  and a.process='SMT' " + @"        
                                            group by a.line_name                                           
                                           ) y where x.fpy_grouping=y.fpy_grouping
                                        ) t2
                                       on t1.catalogy = t2.catalogy";

            sql += vOrderAsc + @" ) a where rownum <= :rowcount order by a.fpy   ";

            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);

            if (vProcess != "")
                ht.Add("process", vProcess);
            if (vStation != "")
                ht.Add("station", vStation);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByGroupInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByGroupInsight(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByGroupInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, int vRows)
        {
            return GetFpyDataByGroupInsight(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", "FPY", "ASC", vRows);
        }
        public DataTable GetFpyDataByGroupInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += " and a.model_serial = :lob ";
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
            {
                if (vLine.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                sql1 += @" and a.line_name = :line ";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = "";

            if (vLOB != "")
            {
                sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                x.fail_qty as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy from
                                  (select e.data_value as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0    
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'    
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = e.data_value                                           
                                          and e.data_type = 'FPY_GROUP_INSIGHT'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU_BR', 'STRU2_BR', 'AFT_BR', 'TFF_BR', 'TPDL_BR', 'TPDL_IN_BR')))                                     
                                          and a.line_name not like '%TNB%'     
                                      group by e.data_value 
                                      ) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0    
                                              and a.bu_code='PCBG' 
                                                " + sql1 + strExSql + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"     
                                       ) y  ";
                //sql = @"select a.* from (
                //            select  
                //                x.fpy_grouping as catalogy,                           
                //                y.input as input,
                //               case
                //                 when nvl(y.input, 0) = 0 then
                //                  0
                //                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                //                  0
                //                 else
                //                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                //               end Insightfpy from
                //                  (select e.data_code as fpy_grouping,
                //                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                //                         sum(a.fail_qty) as fail_qty                 
                //                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                //                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                //                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0    
                //                          and a.date_type='D'    
                //                          and a.mo_type = 'ZP01'    
                //                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                //                          and a.group_name = e.data_value                                           
                //                          and e.data_type = 'FPY_GROUP_INSIGHT'                                          
                //                          and((a.line_name not like '%REP%') or
                //                            (a.line_name like '%REP%' and
                //                            TRIM(a.group_name) not in
                //                            ('STRU_BR', 'STRU2_BR', 'AFT_BR', 'TFF_BR', 'TPDL_BR', 'TPDL_IN_BR')))                                     
                //                          and a.line_name not like '%TNB%'     
                //                      group by e.data_code order by sum(a.fail_qty) desc) x,  
                //                      (select NVL(sum(a.output_qty),0) as input
                //                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                //                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                //                        where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0    
                //                              and a.bu_code='PCBG' 
                //                                " + sql1 + strExSql + @"
                //                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"     
                //                       ) y  ";
                //sql = @"select a.* from (
                //            select  
                //                x.fpy_grouping as catalogy,                           
                //                y.input as input,
                //               case
                //                 when nvl(y.input, 0) = 0 then
                //                  0
                //                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                //                  0
                //                 else
                //                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                //               end Insightfpy from
                //                  (select TRIM(a.group_name) as fpy_grouping,
                //                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                //                         sum(a.fail_qty) as fail_qty                 
                //                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                //                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                //                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0    
                //                          and a.date_type='D'    
                //                          and a.mo_type = 'ZP01'    
                //                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"                                     
                //                          and((a.line_name not like '%REP%') or
                //                            (a.line_name like '%REP%' and
                //                            TRIM(a.group_name) not in
                //                            ('STRU_BR', 'STRU2_BR', 'AFT_BR', 'TFF_BR', 'TPDL_BR', 'TPDL_IN_BR')))                                     
                //                          and a.line_name not like '%TNB%'     
                //                      group by TRIM(a.group_name) order by sum(a.fail_qty) desc) x,  
                //                      (select NVL(sum(a.output_qty),0) as input
                //                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                //                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                //                        where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0    
                //                              and a.bu_code='PCBG' 
                //                                " + sql1 + strExSql + @"
                //                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"     
                //                       ) y  ";
                if (vOrderBy == "FPY")
                    sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end ";
                else
                    sql += " order by NVL(x.fail_qty, 0)  ";
                sql += vOrderAsc + @" ) a where rownum <= :rowcount  ";
            }
            else
            {
                sql = @"select a.* from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy from
                                  (select e.data_value as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a     
                                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0      
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = e.data_value                                           
                                          and e.data_type = 'FPY_GROUP_INSIGHT'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU_BR', 'STRU2_BR', 'AFT_BR', 'TFF_BR', 'TPDL_BR', 'TPDL_IN_BR')))                                     
                                          and a.line_name not like '%TNB%'     
                                      group by e.data_value
                                     ) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0     
                                              and a.bu_code='PCBG' 
                                                " + sql1 + strExSql + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                                          
                                       ) y ";
                //sql = @"select a.* from (
                //            select  
                //                x.fpy_grouping as catalogy,                           
                //                nvl(x.fail_qty, 0) as input,
                //               case
                //                 when nvl(y.input, 0) = 0 then
                //                  0
                //                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                //                  0
                //                 else
                //                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                //               end Insightfpy from
                //                  (select TRIM(a.group_name) as fpy_grouping,
                //                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                //                         sum(a.fail_qty) as fail_qty                 
                //                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                //                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a     
                //                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0      
                //                          and a.date_type='D'    
                //                          and a.mo_type = 'ZP01'        
                //                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"                                                                         
                //                          and((a.line_name not like '%REP%') or
                //                            (a.line_name like '%REP%' and
                //                            TRIM(a.group_name) not in
                //                            ('STRU_BR', 'STRU2_BR', 'AFT_BR', 'TFF_BR', 'TPDL_BR', 'TPDL_IN_BR')))                                     
                //                          and a.line_name not like '%TNB%'     
                //                      group by TRIM(a.group_name) order by sum(a.fail_qty) desc) x,  
                //                      (select NVL(sum(a.output_qty),0) as input
                //                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                //                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                //                        where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0     
                //                              and a.bu_code='PCBG' 
                //                                " + sql1 + strExSql + @"
                //                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                                          
                //                       ) y ";
                if (vOrderBy == "FPY")
                    sql += @" order by case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end ";
                else
                    sql += " order by NVL(x.fail_qty, 0)  ";
                sql += vOrderAsc + @" ) a where rownum <= :rowcount  ";
            }
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByGroupGapInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += " and a.model_serial = :lob ";
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
            {
                if (vLine.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                sql1 += @" and a.line_name = :line ";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = "";

            sql = @"select a.* from 
                        (select t1.catalogy,nvl(t1.insightfpy,0) as insightfpy,nvl(t2.fpy,0) as fpy,CASE
                                 WHEN t1.input = 0 THEN
                                  0
                                 ELSE
                                  ROUND(ABS(nvl(t3.gap_qty,0)) / t1.input * 100,2)
                               END AS gap,
                                t1.input,t1.fail_qty,nvl(t3.gap_qty,0) as gap_qty from (
                            select  
                                x.fpy_grouping as catalogy,                           
                                y.input as input,x.fail_qty,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy from
                                  (select e.data_code as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                          and a.group_name = e.data_value                                           
                                          and e.data_type = 'FPY_GROUP_INSIGHT'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                          and a.line_name not like '%TNB%'     
                                      group by e.data_code order by sum(a.fail_qty) desc) x,  
                                      (select NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0  
                                              and a.bu_code='PCBG' 
                                                " + sql1 + strExSql + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                                          
                                       ) y 
                                ) t1
                        left outer join
                                (  
                                select  
                                    x.fpy_grouping as catalogy,                           
                                    nvl(x.fail_qty, 0) as input,
                                   case
                                     when nvl(y.input, 0) = 0 then
                                      0
                                     when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                      0
                                     else
                                      round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                                   end fpy from
                                      (select e.data_code as fpy_grouping,
                                             sum(a.pass_qty+a.repass_qty) as pass_qty,
                                             sum(a.fail_qty) as fail_qty                 
                                        from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                        where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                           
                                              and a.date_type='D'    
                                              and a.mo_type = 'ZP01'        
                                              and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                              and a.group_name = e.data_value
                                          and e.data_type = 'FPY_GROUP_INSIGHT_FPY'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR'))) 
                                          and a.line_name not like '%TNB%'                              
                                          group by e.data_code order by sum(a.fail_qty)+sum(a.refail_qty) desc) x,  
                                          (select NVL(sum(a.output_qty),0) as input
                                            from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                            where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0  
                                                  and a.bu_code='PCBG' 
                                                    " + sql1 + strExSql + @"
                                                  and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                                          
                                           ) y
                                        ) t2
                                       on t1.catalogy = t2.catalogy  
                                left outer join
                                    (
                                        select  
                                            x.fpy_grouping as catalogy,                           
                                            x.fail_qty as br_qty,
                                            y.fail_qty as ff_qty, 
                                            nvl(x.fail_qty,0)-nvl(y.fail_qty,0) as gap_qty from
                                              (select e.data_code as fpy_grouping, 
                                                     sum(a.fail_qty) as fail_qty                 
                                                from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'             
                                                      ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                                where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                   
                                                      and a.date_type='D'    
                                                      and a.mo_type = 'ZP01'        
                                                      and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                                      and a.group_name = e.data_value and e.data_desc=:plant                                            
                                                      and e.data_type = 'FPY_GROUP_GAP_PASS'                                          
                                                      and((a.line_name not like '%REP%') or
                                                        (a.line_name like '%REP%' and
                                                        TRIM(a.group_name) not in
                                                        ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                                      and a.line_name not like '%TNB%'     
                                                  group by e.data_code order by sum(a.fail_qty) desc) x,  
                                                  (select e.data_code as fpy_grouping,
                                                     sum(a.fail_qty) as fail_qty                 
                                                from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'         
                                                      ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                                where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                      
                                                      and a.date_type='D'    
                                                      and a.mo_type = 'ZP01'        
                                                      and a.from_db not like '%SMT%' " + sql1 + strExSql + @"
                                                      and a.group_name = e.data_value and e.data_desc= :plant                                     
                                                      and e.data_type = 'FPY_GROUP_GAP_FAIL'                                          
                                                      and((a.line_name not like '%REP%') or
                                                        (a.line_name like '%REP%' and
                                                        TRIM(a.group_name) not in
                                                        ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                                      and a.line_name not like '%TNB%'     
                                                  group by e.data_code order by sum(a.fail_qty) desc                                   
                                                   ) y 
                                                  where X.fpy_grouping=y.fpy_grouping 
                                            ) t3 
                                             on t1.catalogy = t3.catalogy";
            sql += @" ) a where rownum <= :rowcount order by a.gap " + vOrderAsc;

            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataByGroupByLineGapInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vProcess, string vStation, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sql3 = "", sql = "", sql4 = "";
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
                sql1 += " and a.line_name = :line ";
            if (vProcess != "")
                sql4 += " and a.sub_process=:process ";
            if (vStation != "")
            {
                sql3 += " and d.data_value = :station ";
                sql2 += " and d.data_code = :station ";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";

            sql = @"select a.* from 
                        (select t1.catalogy,nvl(t1.insightfpy,0) as insightfpy,nvl(t2.fpy,0) as fpy,CASE
                         WHEN t1.input = 0 THEN
                          0
                         ELSE
                          ROUND(ABS(nvl(t3.gap_qty,0)) / t1.input * 100,2)
                       END AS gap from
                           (
                            select  
                                x.fpy_grouping as catalogy,                           
                                y.input as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy from
                                  (select a.line_name as fpy_grouping,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                            
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'  
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + sql2 + @" 
                                          and a.group_name = d.data_value                                           
                                          and d.data_type = 'FPY_GROUP_INSIGHT'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                          and a.line_name not like '%TNB%'        
                                      group by a.line_name order by sum(a.fail_qty) desc) x,  
                                      (select a.line_name as fpy_grouping,
                                              NVL(sum(a.output_qty),0) as input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0  
                                              and a.bu_code='PCBG'  
                                                " + sql1 + strExSql + sql4 + @"
                                              and a.process='FATP' " + @"                 
                                              group by a.line_name                                  
                                       ) y  where x.fpy_grouping=y.fpy_grouping
                                ) t1
                        left outer join
                                (  
                                select  
                                    x.fpy_grouping as catalogy,                           
                                    nvl(x.fail_qty, 0) as input,
                                   case
                                     when nvl(y.input, 0) = 0 then
                                      0
                                     when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                      0
                                     else
                                      round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                                   end fpy from
                                      (select a.line_name as fpy_grouping,
                                             sum(a.pass_qty+a.repass_qty) as pass_qty,
                                             sum(a.fail_qty) as fail_qty                 
                                        from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                        where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                            
                                              and a.date_type='D'    
                                              and a.mo_type = 'ZP01'
                                              and a.from_db not like '%SMT%' " + sql1 + strExSql + sql2 + @"
                                             and a.group_name = d.data_value
                                          and d.data_type = 'FPY_GROUP_INSIGHT_FPY'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR'))) 
                                          and a.line_name not like '%TNB%'                              
                                          group by a.line_name order by sum(a.fail_qty)+sum(a.refail_qty) desc) x,  
                                          (select a.line_name as fpy_grouping,
                                                  NVL(sum(a.output_qty),0) as input
                                            from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                            where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0  
                                                  and a.bu_code='PCBG'  
                                                    " + sql1 + strExSql + sql4 + @"
                                                  and a.process='FATP' " + @"        
                                            group by a.line_name                                           
                                           ) y where x.fpy_grouping=y.fpy_grouping
                                        ) t2
                                       on t1.catalogy = t2.catalogy
                                left outer join
                                (  
                                    select  
                                        x.fpy_grouping as catalogy,                           
                                        nvl(x.fail_qty,0)-nvl(y.fail_qty,0) as gap_qty from
                                          (select a.line_name as fpy_grouping,
                                                 sum(a.pass_qty+a.repass_qty) as pass_qty,
                                                 sum(a.fail_qty) as fail_qty                 
                                            from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                                  ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                            where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                            
                                                  and a.date_type='D'    
                                                  and a.mo_type = 'ZP01'  
                                                  and a.from_db not like '%SMT%' " + sql1 + strExSql + sql2 + @" 
                                                  and a.group_name = d.data_value and d.data_desc=:plant                                           
                                                  and d.data_type = 'FPY_GROUP_GAP_PASS'                                          
                                                  and((a.line_name not like '%REP%') or
                                                    (a.line_name like '%REP%' and
                                                    TRIM(a.group_name) not in
                                                    ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                                  and a.line_name not like '%TNB%'        
                                              group by a.line_name order by sum(a.fail_qty) desc) x,  
                                              (select a.line_name as fpy_grouping,
                                                 sum(a.pass_qty+a.repass_qty) as pass_qty,
                                                 sum(a.fail_qty) as fail_qty                 
                                            from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                                  ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                            where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                            
                                                  and a.date_type='D'    
                                                  and a.mo_type = 'ZP01'  
                                                  and a.from_db not like '%SMT%' " + sql1 + strExSql + sql2 + @" 
                                                  and a.group_name = d.data_value and d.data_desc=:plant                                        
                                                  and d.data_type = 'FPY_GROUP_GAP_FAIL'                                          
                                                  and((a.line_name not like '%REP%') or
                                                    (a.line_name like '%REP%' and
                                                    TRIM(a.group_name) not in
                                                    ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                                  and a.line_name not like '%TNB%'        
                                              group by a.line_name order by sum(a.fail_qty) desc                        
                                               ) y  where x.fpy_grouping=y.fpy_grouping
                                ) t3
                                on t1.catalogy = t3.catalogy
";

            sql += vOrderAsc + @" ) a where rownum <= :rowcount order by a.fpy   ";

            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);

            if (vProcess != "")
                ht.Add("process", vProcess);
            if (vStation != "")
                ht.Add("station", vStation);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByGroupPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vOrderBy, string vOrderAsc)
        {
            return GetFpyDataByGroupPcbLrr(vPlant, vSapPlant, vDateType, vQCond, "", "", "", vOrderBy, vOrderAsc);
        }
        public DataTable GetFpyDataByGroupPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            return GetFpyDataByGroupPcbLrr(vPlant, vSapPlant, vDateType, vQCond, "", "", "", "LRR", "DESC");
        }
        public DataTable GetFpyDataByGroupPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vOrderBy, string vOrderAsc)
        {
            return GetFpyDataByGroupPcbLrr(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", vOrderBy, vOrderAsc);
        }
        public DataTable GetFpyDataByGroupPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB)
        {
            return GetFpyDataByGroupPcbLrr(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", "LRR", "DESC");
        }
        public DataTable GetFpyDataByGroupPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1, strFloorSql1 = "", strFloorSql2 = "", strFloor = "";
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
            {
                sql1 += @" and a.model_serial=:lob ";
                if (vLOB.IndexOf("-2F") > -1 || vLOB.IndexOf("-3F") > -1)
                {
                    string[] bb = vLOB.Split('-');
                    for (int i = 0; i < bb.Length; i++)
                    {
                        if (i != bb.Length - 1)
                        {
                            if (i != 0)
                                vLOB += "-" + bb[i];
                            else
                                vLOB = bb[i];
                        }
                        else
                            strFloor = bb[i];
                    }
                    strFloorSql1 = " WHERE a.test_line IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                    strFloorSql2 = " WHERE a.line_name IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                }
            }
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
            {
                if (vLine.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                sql1 += " and a.line_name = :line ";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = @"select * from 
                            (select x.catalogy,  
                                    x.error_input as input ,                           
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end pcblrr,                                  
                                   y.input as output
                                from                             
                                (select a.test_group as catalogy,  
                                   NVL(sum(a.qty), 0) as error_input 
                                 from (select a.*,a.test_line as line_name,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a " + strFloorSql1 + @")a 
                                 where a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                               @"  group by a.test_group) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a " + strFloorSql2 + @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 + strExSql +
                               @"   and a.process='FATP' ";
            if (vLine == "")
                sql += getSubProcess(strMProcess, strCust);
            sql += @"  ) y ";
            if (vOrderBy == "LRR")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by x.error_input  ";
            sql += vOrderAsc + @" ) a where pcblrr >0 and rownum <=10 ";

            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            if (strFloor != "")
                ht.Add("floor", strFloor);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataByGroupPcbLrrMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1, strFloorSql1 = "", strFloorSql2 = "", strFloor = "";
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
            {
                sql1 += @" and a.model_serial=:lob ";
                if (vLOB.IndexOf("-2F") > -1 || vLOB.IndexOf("-3F") > -1)
                {
                    string[] bb = vLOB.Split('-');
                    for (int i = 0; i < bb.Length; i++)
                    {
                        if (i != bb.Length - 1)
                        {
                            if (i != 0)
                                vLOB += "-" + bb[i];
                            else
                                vLOB = bb[i];
                        }
                        else
                            strFloor = bb[i];
                    }
                    strFloorSql1 = " WHERE a.test_line IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                    strFloorSql2 = " WHERE a.line_name IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                }
            }
            if (vModel != "")
                sql1 += " and a.model_name = :model ";
            if (vLine != "")
            {
                if (vLine.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                sql1 += " and a.line_name = :line ";
            }
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = @"select * from 
                            (select x.catalogy,  
                                    x.error_input as error_input ,                                     
                                   y.input as input,                        
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end pcblrr
                                from                             
                                (select a.test_group as catalogy,  
                                   NVL(sum(a.qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a " + strFloorSql1 + @")a 
                                 where a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                @"  group by a.test_group) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a " + strFloorSql2 + @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 + strExSql +
                                @"   and a.process='FATP' ";
            if (vLine == "")
                sql += getSubProcess(strMProcess, strCust);
            sql += @"  ) y ";
            if (vOrderBy == "FPY")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by x.error_input  ";
            sql += vOrderAsc + @" ) a where pcblrr >0 and rownum <=10 ";

            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            if (strFloor != "")
                ht.Add("floor", strFloor);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataByLine(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, int vRows)
        {
            return GetFpyDataByLine(vPlant, vSapPlant, vDateType, vQCond, vQProcess, "", vRows);
        }
        public DataTable GetFpyDataByLine(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByLine(vPlant, vSapPlant, vDateType, vQCond, vQProcess, "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByLine(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, int vRows)
        {
            return GetFpyDataByLine(vPlant, vSapPlant, vDateType, vQCond, vQProcess, vLOB, "FPY", "DESC", vRows);
        }
        public DataTable GetFpyDataByLine(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, string vOrderBy, string vOrderAsc, int vRows, string vModel = "")
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vDateType == "Daily")
                sql1 = " and a.work_date= :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vQProcess != "")
                sql1 += @" and a.sub_process=:process ";
            if (vLOB != "")
            {
                sql1 += @" and a.model_serial=:lob ";
                if (vLOB.IndexOf("-2F") > -1 || vLOB.IndexOf("-3F") > -1)
                {
                    string[] bb = vLOB.Split('-');
                    for (int i = 0; i < bb.Length; i++)
                    {
                        if (i != bb.Length - 1)
                        {
                            if (i != 0)
                                vLOB += "-" + bb[i];
                            else
                                vLOB = bb[i];
                        }
                    }
                }
            }
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            string sql = @" select a.*
                            from 
                            (select a.line_name as catalogy,
                                   NVL(sum(a.output_qty), 0) as input,
                                   case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end fpy
                             from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a ,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                             where a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code 
                                   and a.plant_code like :sap
                                   and c.rms_plant=:plant " + sql1 + strExSql + @" and a.process='FATP'                                        
                            group by a.line_name ";
            if (vOrderBy == "FPY")
                sql += @"order by case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end ";
            else
                sql += "order by NVL(sum(a.output_qty), 0) ";
            sql += vOrderAsc + @" ) a where a.fpy>0 and rownum<= :rowcount ";

            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vQProcess != "")
                ht.Add("process", vQProcess);
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLineSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, int vRows)
        {
            return GetFpyDataByLineSMT(vPlant, vSapPlant, vDateType, vQCond, vQProcess, "", "", vRows);
        }
        public DataTable GetFpyDataByLineSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByLineSMT(vPlant, vSapPlant, vDateType, vQCond, vQProcess, "", "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByLineSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, int vRows)
        {
            return GetFpyDataByLineSMT(vPlant, vSapPlant, vDateType, vQCond, vQProcess, vLOB, "", "FPY", "DESC", vRows);
        }
        public DataTable GetFpyDataByLineSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, string vModel, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vDateType == "Daily")
                sql1 = " and a.work_date= :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vQProcess != "")
                sql1 += @" and a.sub_process=:process ";
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            string sql = @" select a.*
                            from 
                            (select a.line_name as catalogy,
                                   NVL(sum(a.output_qty), 0) as input,
                                   case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end fpy
                             from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a ,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                             where a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code 
                                   and a.plant_code like :sap
                                   and c.rms_plant=:plant " + sql1 + strExSql + @" and a.process='SMT'                                        
                            group by a.line_name ";
            if (vOrderBy == "FPY")
                sql += @"order by case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end ";
            else
                sql += "order by NVL(sum(a.output_qty), 0) ";
            sql += vOrderAsc + @" ) a where a.fpy>0 and rownum<= :rowcount ";

            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vQProcess != "")
                ht.Add("process", vQProcess);
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLineMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vDateType == "Daily")
                sql1 = " and a.work_date= :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vQProcess != "")
                sql1 += @" and a.sub_process=:process ";
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            string sql = @" select a.*
                            from 
                            (select a.line_name as catalogy,
                                   NVL(sum(a.output_qty), 0) as input,NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input,
                                   case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end fpy
                             from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a ,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                             where a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code 
                                   and a.plant_code like :sap
                                   and c.rms_plant=:plant " + sql1 + strExSql + @" and a.process='FATP'                                        
                            group by a.line_name ";
            if (vOrderBy == "FPY")
                sql += @"order by case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end ";
            else
                sql += "order by NVL(sum(a.output_qty), 0) ";
            sql += vOrderAsc + @" ) a where rownum<= :rowcount ";

            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vQProcess != "")
                ht.Add("process", vQProcess);
            if (vLOB != "")
                ht.Add("lob", vLOB);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLineSMTMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, string vModel, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vDateType == "Daily")
                sql1 = " and a.work_date= :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vQProcess != "")
                sql1 += @" and a.sub_process=:process ";
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            string sql = @" select a.*
                            from 
                            (select a.line_name as catalogy,
                                   NVL(sum(a.output_qty), 0) as input,NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input,
                                   case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0 
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end fpy
                             from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a ,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                             where a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code 
                                   and a.plant_code like :sap
                                   and c.rms_plant=:plant " + sql1 + strExSql + @" and a.process='SMT'                                        
                            group by a.line_name ";
            if (vOrderBy == "FPY")
                sql += @"order by case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end ";
            else
                sql += "order by NVL(sum(a.output_qty), 0) ";
            sql += vOrderAsc + @" ) a where rownum<= :rowcount ";

            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vQProcess != "")
                ht.Add("process", vQProcess);
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLineInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, int vRows)
        {
            return GetFpyDataByLineInsightSMT(vPlant, vSapPlant, vDateType, vQCond, vQProcess, "", "", vRows);
        }
        public DataTable GetFpyDataByLineInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByLineInsightSMT(vPlant, vSapPlant, vDateType, vQCond, vQProcess, "", "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByLineInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, int vRows)
        {
            return GetFpyDataByLineInsightSMT(vPlant, vSapPlant, vDateType, vQCond, vQProcess, vLOB, "", "FPY", "DESC", vRows);
        }
        public DataTable GetFpyDataByLineInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, string vModel, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vDateType == "Daily")
                sql1 = " and a.work_date= :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vQProcess != "")
                sql1 += @" and a.sub_process=:process ";
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            //select catalogy, fpy, insightfpy,(fpy - insightfpy) as gap from
            //                (select x.catalogy,
            //                       y.input as input,
            //                       case
            //                         when y.input = 0 then
            //                          0
            //                         when y.input < x.error_input then
            //                          0
            //                         else
            //                          round((1 - x.error_input / y.input) * 100, 2)
            //                       end fpy,
            //                       case
            //                         when y.input = 0 then
            //                          0
            //                         else
            //                          round((1 - x.gap_input / y.input) * 100, 2)
            //                       end insightfpy
            //                    from
            //                    (select " + sqlType1 + @" as ordercata, " + sqlType2 + @" as catalogy,
            //                       NVL(sum(a.gap_qty), 0) as gap_input, NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input

            string sql = @" select a.catalogy,a.input, a.insightfpy, a.fpy,(a.fpy - a.insightfpy) as gap 
                            from 
                            (select a.line_name as catalogy,
                                   NVL(sum(a.output_qty), 0) as input,
                                   case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.gap_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.gap_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end Insightfpy,
                                   case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end fpy 
                             from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a ,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                             where a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code  
                                   and a.plant_code like :sap
                                   and c.rms_plant=:plant " + sql1 + strExSql + @" and a.process='SMT'                                        
                            group by a.line_name ";

            sql += @" ) a where a.Insightfpy > 0 and rownum<= :rowcount ";
            if (vOrderBy == "FPY")
                sql += @"order by a.Insightfpy ";
            else if (vOrderBy == "GAP")
                sql += "order by (a.fpy - a.insightfpy) ";
            else
                sql += "order by a.input ";
            sql += vOrderAsc;
            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vQProcess != "")
                ht.Add("process", vQProcess);
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLineInsightSMTMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, string vModel, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vDateType == "Daily")
                sql1 = " and a.work_date= :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vQProcess != "")
                sql1 += @" and a.sub_process=:process ";
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            string sql = @" select a.*
                            from 
                            (select a.line_name as catalogy,
                                   NVL(sum(a.output_qty), 0) as input,NVL(sum(a.gap_qty), 0) as error_input,
                                   case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0 
                                     else
                                      round((1 - NVL(sum(a.gap_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end Insightfpy
                             from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a ,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                             where a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code 
                                   and a.plant_code like :sap
                                   and c.rms_plant=:plant " + sql1 + strExSql + @" and a.process='SMT'                                        
                            group by a.line_name ";
            if (vOrderBy == "FPY")
                sql += @"order by case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.gap_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.gap_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end ";
            else
                sql += "order by NVL(sum(a.output_qty), 0) ";
            sql += vOrderAsc + @" ) a where rownum<= :rowcount ";

            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vQProcess != "")
                ht.Add("process", vQProcess);
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLineInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, int vRows)
        {
            return GetFpyDataByLineInsight(vPlant, vSapPlant, vDateType, vQCond, vQProcess, "", "", vRows);
        }
        public DataTable GetFpyDataByLineInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByLineInsight(vPlant, vSapPlant, vDateType, vQCond, vQProcess, "", "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByLineInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, int vRows)
        {
            return GetFpyDataByLineInsight(vPlant, vSapPlant, vDateType, vQCond, vQProcess, vLOB, "", "FPY", "DESC", vRows);
        }
        public DataTable GetFpyDataByLineInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, string vModel, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vDateType == "Daily")
                sql1 = " and a.work_date= :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vQProcess != "")
                sql1 += @" and a.sub_process=:process ";
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";

            string sql = @" select a.catalogy,a.Insightfpy,a.fpy,(a.fpy-a.Insightfpy) as gap,a.input 
                            from 
                            (select a.line_name as catalogy,
                                   case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end Insightfpy,
                                   case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end fpy,
                                   NVL(sum(a.output_qty), 0) as input 
                             from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a ,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                             where a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code  
                                   and a.plant_code like :sap and instr(:cust,a.cust_no ) > 0  
                                   and c.rms_plant=:plant " + sql1 + strExSql + @" and a.process='FATP'                                        
                            group by a.line_name ";
            if (vOrderBy == "FPY")
                sql += @"order by case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end ";
            else
                sql += " order by NVL(sum(a.output_qty), 0) ";
            sql += vOrderAsc + @" ) a where a.Insightfpy>0 and rownum<= :rowcount ";

            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vQProcess != "")
                ht.Add("process", vQProcess);
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLineInsightMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, string vModel, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "";
            string strExSql = "", strExType = "", strCust = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vDateType == "Daily")
                sql1 = " and a.work_date= :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vQProcess != "")
                sql1 += @" and a.sub_process=:process ";
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";

            string sql = @" select a.*
                            from 
                            (select a.line_name as catalogy,
                                   NVL(sum(a.output_qty), 0) as input,NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) as error_input,
                                   case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0 
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end Insightfpy
                             from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a ,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                             where a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code 
                                   and a.plant_code like :sap and instr(:cust,a.cust_no ) > 0 
                                   and c.rms_plant=:plant " + sql1 + strExSql + @" and a.process='FATP'                                        
                            group by a.line_name ";
            if (vOrderBy == "FPY")
                sql += @"order by case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end ";
            else
                sql += "order by NVL(sum(a.output_qty), 0) ";
            sql += vOrderAsc + @" ) a where rownum<= :rowcount ";

            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vQProcess != "")
                ht.Add("process", vQProcess);
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLinePcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, int vRows)
        {
            return GetFpyDataByLinePcbLrr(vPlant, vSapPlant, vDateType, vQCond, vQProcess, "", "", vRows);
        }
        public DataTable GetFpyDataByLinePcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByLinePcbLrr(vPlant, vSapPlant, vDateType, vQCond, vQProcess, "", "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByLinePcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, int vRows)
        {
            return GetFpyDataByLinePcbLrr(vPlant, vSapPlant, vDateType, vQCond, vQProcess, vLOB, "", "LRR", "DESC", vRows);
        }
        public DataTable GetFpyDataByLinePcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, string vModel, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1, strFloorSql1 = "", strFloorSql2 = "", strFloor = "";
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vDateType == "Daily")
                sql1 = " and a.work_date= :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vQProcess != "")
                strExSql += @" and a.sub_process=:process ";
            if (vLOB != "")
            {
                sql1 += @" and a.model_serial=:lob ";
                if (vLOB.IndexOf("-2F") > -1 || vLOB.IndexOf("-3F") > -1)
                {
                    string[] bb = vLOB.Split('-');
                    for (int i = 0; i < bb.Length; i++)
                    {
                        if (i != bb.Length - 1)
                        {
                            if (i != 0)
                                vLOB += "-" + bb[i];
                            else
                                vLOB = bb[i];
                        }
                        else
                            strFloor = bb[i];
                    }
                    strFloorSql1 = " WHERE a.test_line IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                    strFloorSql2 = " WHERE a.line_name IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                }
            }
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            string sql = @"select * from 
                            (select x.catalogy,  
                                    y.input as input ,                           
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end pcblrr,                                  
                                   x.error_input
                                from                             
                                (select a.test_line as catalogy,  
                                   NVL(sum(a.qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a " + strFloorSql1 + @")a 
                                 where a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant =:plant and rownum <= 1) 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                  @"  group by a.test_line) x,
                                (select a.line_name as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a " + strFloorSql2 + @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 + strExSql +
                                  @"   and a.process='FATP' ";
            sql += @"        group by a.line_name) y                                       
                                where x.catalogy=y.catalogy  ";
            if (vOrderBy == "LRR")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input  ";
            sql += vOrderAsc + @" ) a where pcblrr >0 and rownum <=:rowcount ";

            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vQProcess != "")
                ht.Add("process", vQProcess);
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (strFloor != "")
                ht.Add("floor", strFloor);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByLinePcbLrrMinus(string vPlant, string vSapPlant, string vDateType, string vQCond, string vQProcess, string vLOB, string vModel, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1, strFloorSql1 = "", strFloorSql2 = "", strFloor = "";
            string strShift = "";
            string strExSql = "", strExType = "", strCust = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vDateType == "Daily")
                sql1 = " and a.work_date= :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vQProcess != "")
                strExSql += @" and a.sub_process=:process ";
            if (vLOB != "")
            {
                sql1 += @" and a.model_serial=:lob ";
                if (vLOB.IndexOf("-2F") > -1 || vLOB.IndexOf("-3F") > -1)
                {
                    string[] bb = vLOB.Split('-');
                    for (int i = 0; i < bb.Length; i++)
                    {
                        if (i != bb.Length - 1)
                        {
                            if (i != 0)
                                vLOB += "-" + bb[i];
                            else
                                vLOB = bb[i];
                        }
                        else
                            strFloor = bb[i];
                    }
                    strFloorSql1 = " WHERE a.test_line IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                    strFloorSql2 = " WHERE a.line_name IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                }
            }
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";

            string sql = @"select * from 
                            (select x.catalogy,  
                                    y.input as input ,                           
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end pcblrr,                                  
                                   x.error_input
                                from                             
                                (select a.test_line as catalogy,  
                                   NVL(sum(a.qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a " + strFloorSql1 + @")a 
                                 where a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                   @"  group by a.test_line) x,
                                (select a.line_name as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a " + strFloorSql2 + @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 + strExSql +
                                   @"   and a.process='FATP' ";
            sql += @"        group by a.line_name) y                                       
                                where x.catalogy=y.catalogy  ";
            if (vOrderBy == "LRR")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input  ";
            sql += vOrderAsc + @" ) a where pcblrr >0 and rownum <=:rowcount ";

            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            ht.Add("rowcount", vRows);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vQProcess != "")
                ht.Add("process", vQProcess);
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (strFloor != "")
                ht.Add("floor", strFloor);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataByModel(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vOrderBy, string vOrderAsc)
        {
            return GetFpyDataByModel(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", vOrderBy, vOrderAsc);
        }
        public DataTable GetFpyDataByModel(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB)
        {
            return GetFpyDataByModel(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "FPY", "DESC");
        }
        public DataTable GetFpyDataByModel(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vOrderBy, string vOrderAsc)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            strCust = getCust(vPlant);
            string sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select a.model_name as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap  and a.bu_code='PCBG' 
                                       and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql + @"
                                       and a.process='FATP'                                                                          
                                 group by a.model_name) x,
                                (select a.model_name as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' 
                                      and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql + @"
                                      and a.process='FATP'  " + getSubProcess("FATP", strCust) + @"                          
                                      group by a.model_name) y                                       
                                where x.catalogy=y.catalogy ";
            if (vOrderBy == "FPY")
                sql += @" order by 
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input ";
            sql += vOrderAsc + @" ) a where fpy >0 and rownum <=10  ";
            ht.Clear();
            ht.Add("cust", strCust);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByModelSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByModelSMT(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByModelSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, int vRows)
        {
            return GetFpyDataByModelSMT(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", "FPY", "DESC", vRows);
        }
        public DataTable GetFpyDataByModelSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLine != "")
            {
                sql1 += @"  and a.line_name = :line ";
                if (vLine.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
            }
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            strCust = getCust(vPlant);
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            string sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select a.model_name as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap  and a.bu_code='PCBG' 
                                        " + sql1 + strExSql + @"
                                       and a.process='SMT'                                                                              
                                 group by a.model_name) x,
                                (select a.model_name as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' 
                                       " + sql1 + strExSql + @"
                                      and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"                              
                                      group by a.model_name) y                                       
                                where x.catalogy=y.catalogy ";
            if (vOrderBy == "FPY")
                sql += @" order by 
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input ";
            sql += vOrderAsc + @" ) a where fpy >0 and rownum <= :rowcount  ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("rowcount", vRows);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByModelInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByModelInsightSMT(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByModelInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, int vRows)
        {
            return GetFpyDataByModelInsightSMT(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", "FPY", "DESC", vRows);
        }
        public DataTable GetFpyDataByModelInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLine != "")
            {
                if (vLine.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                sql1 += @" and a.line_name = :line ";
            }
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            strCust = getCust(vPlant);
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }

            string sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end Insightfpy 
                                from                             
                                (select a.model_name as catalogy,  
                                   NVL(sum(a.gap_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap  and a.bu_code='PCBG' 
                                        " + sql1 + strExSql + @"
                                       and a.process='SMT'                                                                         
                                 group by a.model_name) x,
                                (select a.model_name as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' 
                                       " + sql1 + strExSql + @"
                                      and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"                        
                                      group by a.model_name) y                                       
                                where x.catalogy=y.catalogy ";
            if (vOrderBy == "FPY")
                sql += @" order by 
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input ";
            sql += vOrderAsc + @" ) a where Insightfpy >0 and rownum <= :rowcount  ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("rowcount", vRows);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByModelInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vOrderBy, string vOrderAsc, int vRows)
        {
            return GetFpyDataByModelInsight(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", vOrderBy, vOrderAsc, vRows);
        }
        public DataTable GetFpyDataByModelInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, int vRows)
        {
            return GetFpyDataByModelInsight(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", "FPY", "DESC", vRows);
        }
        public DataTable GetFpyDataByModelInsight(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vLine, string vOrderBy, string vOrderAsc, int vRows)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLine != "")
            {
                if (vLine.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                sql1 += @" and a.line_name = :line ";
            }
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            strCust = getCust(vPlant);

            string sql = @"select * from 
                            (select x.catalogy,                                 
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end Insightfpy,
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.fpy_error_input then
                                      0
                                     else
                                      round((1 - x.fpy_error_input / y.input) * 100, 2)
                                   end fpy,
                                    x.error_input,  
                                   y.input as input 
                                from                             
                                (select a.model_name as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) as error_input, NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as fpy_error_input
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap  and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                        " + sql1 + strExSql + @"
                                       and a.process='FATP'                                                                         
                                 group by a.model_name) x,
                                (select a.model_name as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0   
                                      and a.bu_code='PCBG' 
                                       " + sql1 + strExSql + @"
                                      and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                        
                                      group by a.model_name) y                                       
                                where x.catalogy=y.catalogy ";
            if (vOrderBy == "FPY")
                sql += @" order by 
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input ";
            sql += vOrderAsc + @" ) a where Insightfpy >0 and rownum <= :rowcount  ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            ht.Add("rowcount", vRows);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataByModelPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vOrderBy, string vOrderAsc)
        {
            return GetFpyDataByModelPcbLrr(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", vOrderBy, vOrderAsc);
        }
        public DataTable GetFpyDataByModelPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB)
        {
            return GetFpyDataByModelPcbLrr(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "FPY", "DESC");
        }
        public DataTable GetFpyDataByModelPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vModel, string vOrderBy, string vOrderAsc)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1, strFloorSql1 = "", strFloorSql2 = "", strFloor = "";
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
            {
                sql1 += @" and a.model_serial=:lob ";
                if (vLOB.IndexOf("-2F") > -1 || vLOB.IndexOf("-3F") > -1)
                {
                    string[] bb = vLOB.Split('-');
                    for (int i = 0; i < bb.Length; i++)
                    {
                        if (i != bb.Length - 1)
                        {
                            if (i != 0)
                                vLOB += "-" + bb[i];
                            else
                                vLOB = bb[i];
                        }
                        else
                            strFloor = bb[i];
                    }
                    strFloorSql1 = " WHERE a.test_line IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                    strFloorSql2 = " WHERE a.line_name IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                }
            }
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = @"select * from 
                            (select x.catalogy,  
                                    y.input as input ,                           
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end pcblrr,                                  
                                   x.error_input
                                from                             
                                (select a.model_name as catalogy,  
                                   NVL(sum(a.qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a " + strFloorSql1 + @")a 
                                 where a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                @"  group by a.model_name) x,
                                (select a.model_name as catalogy,  
                                    NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a " + strFloorSql2 + @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 + strExSql +
                                @"   and a.process='FATP' " + getSubProcess("FATP", strCust) + @"";
            sql += @"        group by a.model_name) y
                                where x.catalogy = y.catalogy  ";
            if (vOrderBy == "LRR")
                sql += @" order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end ";
            else
                sql += " order by y.input  ";
            sql += vOrderAsc + @" ) a where pcblrr >0 and rownum <=10 ";
            ht.Clear();
            ht.Add("cust", strCust);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (strFloor != "")
                ht.Add("floor", strFloor);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDuty(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vType)
        {
            return GetFpyDuty(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", vType);
        }
        public DataTable GetFpyDuty(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vTypeCond, string vType)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1, sqlType2;
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vType == "PARTS")
            {
                sqlType2 = " w.location_code ";
                if (vTypeCond != "")
                    sql1 += @" and a.line_name=:typecond ";
            }
            else if (vType == "LINE")
            {
                sqlType2 = " a.line_name ";
                if (vTypeCond != "")
                {
                    sql1 += @" and a.line_name=:typecond ";
                    if (vTypeCond.IndexOf("PACK") > -1)
                        strMProcess = "PACK";
                }
            }
            else if (vType == "LOB")
            {
                sqlType2 = " a.model_serial  ";
            }
            else if (vType == "MODEL")
            {
                sqlType2 = " a.model_name  ";
                if (vTypeCond != "")
                    sql1 += @" and a.model_name=:typecond ";
            }
            else
            {
                sqlType2 = " a.model_serial  ";
            }
            string sql = "";
            if (vType == "ERROR")
            {
                sql = @"select * from 
                            (select x.catalogy ,                                   
                                   x.percents,                                                           
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input)*100,2)
                                   end error_rate,  
                                   y.input,    
                                   x.error_input                                    
                                from 
                            (
                                select catalogy, 
                                       count(0) error_input,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                 from (
                                select case when b.error_type ='E' then 'EE' when b.error_type='A' or b.error_type='C' or b.error_type='F' then 'ME' else 'NA' END as  catalogy 
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t b 
                                 where a.process='FATP' and a.test_code=b.error_code 
                                   and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + @"        
                                   and a.plant_code like :sap ";
                if (strCust != "A76")
                    sql += " and a.FPY_FLAG = 'Y' ";
                sql += @"       )
                                    where catalogy in ('ME','EE')                          
                                    group by catalogy
                              ) x,";
                sql += @"        (select NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                      and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + @"          
                                      and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"      
                                       ) y 
                                 order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end desc
                                ) a   ";
            }
            else
            {
                sql = @"select * from 
                            (select x.catalogy ,
                                   x.duty_type,  
                                   x.percents,  
                                   y.input,    
                                   x.error_input,                                                           
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end fpy                                     
                                from 
                            (select " + sqlType2 + @" as catalogy,     
                                       g.data_value as duty_type,
                                       count(0) error_input,
                                       round(ratio_to_report(count(0)) over(partition by " + sqlType2 + @"), 4) * 100 percents
                                  from sfis1.c_data_dictionary_t g,sfism4.r_repair_info_t w, 
                                       (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where a.serial_number = w.serial_number
                                   and a.item_no = w.item_no and a.process='FATP'
                                   and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + @"        
                                   and a.plant_code like :sap ";
                if (strCust != "A76")
                    sql += " and a.FPY_FLAG = 'Y' ";
                sql += @"          and w.duty_type=g.data_code and g.data_type='DUTY_TYPE'
                                 group by " + sqlType2 + @",g.data_value) x,";
                if (vType == "PARTS")
                {
                    sql += @"   (select NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                      and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + @"          
                                      and a.process = 'FATP' ";
                    if (vTypeCond == "")
                        sql += getSubProcess(strMProcess, strCust);
                    sql += @"       ) y
                                 order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end desc
                                ) a  ";
                }
                else if (vType == "LINE")
                    sql += @"        (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                      and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + @"          
                                      and a.process = 'FATP'     
                                      group by " + sqlType2 + @") y
                                where x.catalogy = y.catalogy order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end desc
                                ) a  ";
                else
                    sql += @"        (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                      and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + @"          
                                      and a.process = 'FATP'  " + getSubProcess(strMProcess, strCust) + @"    
                                      group by " + sqlType2 + @") y
                                where x.catalogy = y.catalogy order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end desc
                                ) a   ";
            }
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vTypeCond != "")
                ht.Add("typecond", vTypeCond);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDutySMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vType)
        {
            return GetFpyDutySMT(vPlant, vSapPlant, vDateType, vQCond, vLOB, vType, "");
        }
        public DataTable GetFpyDutySMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vType, string vTypeCond)
        {
            return GetFpyDutySMT(vPlant, vSapPlant, vDateType, vQCond, vLOB, vType, vTypeCond, "", "", "", "");
        }
        public DataTable GetFpyDutySMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vType, string vTypeCond, string vType2, string vTypeCond2)
        {
            return GetFpyDutySMT(vPlant, vSapPlant, vDateType, vQCond, vLOB, vType, vTypeCond, vType2, vTypeCond2, "", "");
        }
        public DataTable GetFpyDutySMT(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vType, string vTypeCond, string vType2, string vTypeCond2, string vType3, string vTypeCond3)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sqlType2 = "";
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }

            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vType == "PARTS")
            {
                sqlType2 = " w.location_code ";
                if (vTypeCond != "")
                    sql1 += @" and a.line_name=:typecond ";
            }
            else if (vType == "LINE")
            {
                sqlType2 = " a.line_name ";
                if (vTypeCond != "")
                {
                    sql1 += @" and a.line_name=:typecond ";
                    if (vTypeCond.IndexOf("PCB") > -1)
                        strMProcess = "PCB";
                }
            }
            else if (vType == "LOB")
            {
                sqlType2 = " a.model_serial  ";
            }
            else if (vType == "MODEL")
            {
                sqlType2 = " substr(a.model_name,0,5) ";
                if (vTypeCond != "")
                    sql1 += @" and substr(a.model_name,1,5)=:typecond ";
            }
            else
            {
                sqlType2 = " a.model_serial  ";
            }
            if (vTypeCond2 != "")
            {
                if (vType2 == "LINE")
                    sql1 += @" and a.line_name=:typecond2 ";
                else if (vType2 == "LOB")
                    sql1 += @" and a.model_serial =:typecond2 ";
                else if (vType2 == "MODEL")
                    sql1 += @" and substr(a.model_name,1,5) =:typecond2 ";
            }
            if (vTypeCond3 != "")
            {
                if (vType3 == "LINE")
                    sql1 += @" and a.line_name=:typecond3 ";
                else if (vType3 == "LOB")
                    sql1 += @" and a.model_serial =:typecond3 ";
                else if (vType3 == "MODEL")
                    sql1 += @" and substr(a.model_name,1,5) =:typecond3 ";
            }
            string sql = "";
            sql = @"select * from 
                            (select x.catalogy ,
                                   x.duty_type,  
                                   x.percents,  
                                   y.input,        
                                   x.error_input,                                                       
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end fpy                                     
                                from 
                            (select " + sqlType2 + @" as catalogy,     
                                       g.data_value as duty_type,
                                       count(0) error_input,
                                       round(ratio_to_report(count(0)) over(partition by " + sqlType2 + @"), 4) * 100 percents
                                  from sfis1.c_data_dictionary_t g,sfism4.r_repair_info_t w, 
                                       (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where d.model_name=substr(a.model_name,0,5) and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where a.serial_number = w.serial_number
                                   and a.item_no = w.item_no and a.process='SMT'
                                    " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap ";
            if (strCust != "A76")
                sql += " and a.FPY_FLAG = 'Y' ";
            sql += @"              and w.duty_type=g.data_code and g.data_type='DUTY_TYPE' 
                                 group by " + sqlType2 + @",g.data_value) x,";
            if (vType == "PARTS")
            {
                sql += @"        (select NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                       " + sql1 + strExSql + @"          
                                      and a.process = 'SMT' ";
                if (vTypeCond == "")
                    sql += getSubProcess(strMProcess, strCust);
                sql += @"               ) y
                                 order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end desc
                                ) a  ";
            }
            else if (vType == "LINE")
                sql += @"        (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                       " + sql1 + strExSql + @"          
                                      and a.process = 'SMT'    
                                      group by " + sqlType2 + @") y
                                where x.catalogy = y.catalogy order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end desc
                                ) a  ";
            else
                sql += @"        (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                       " + sql1 + strExSql + @"          
                                      and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"      
                                      group by " + sqlType2 + @") y
                                where x.catalogy = y.catalogy order by case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end desc
                                ) a   ";

            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vTypeCond != "")
                ht.Add("typecond", vTypeCond);
            if (vTypeCond2 != "")
                ht.Add("typecond2", vTypeCond2);
            if (vTypeCond3 != "")
                ht.Add("typecond3", vTypeCond3);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataDutyPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB)
        {
            return GetFpyDataDutyPcbLrr(vPlant, vSapPlant, vDateType, vQCond, vLOB, "", "", "");
        }
        public DataTable GetFpyDataDutyPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vLine, string vModel, string vStation)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string strFloorSql1 = "", strFloorSql2 = "", strFloor = "";
            string sql1 = "", sql2 = "";
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "", strMProcess = "FATP";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
            {
                sql1 += @" and a.model_serial=:lob ";
                if (vLOB.IndexOf("-2F") > -1 || vLOB.IndexOf("-3F") > -1)
                {
                    string[] bb = vLOB.Split('-');
                    for (int i = 0; i < bb.Length; i++)
                    {
                        if (i != bb.Length - 1)
                        {
                            if (i != 0)
                                vLOB += "-" + bb[i];
                            else
                                vLOB = bb[i];
                        }
                        else
                            strFloor = bb[i];
                    }
                    strFloorSql1 = " WHERE a.test_line IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                    strFloorSql2 = " WHERE a.line_name IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                }
            }
            if (vModel != "")
                sql1 += @" and a.model_name=:model ";
            if (vStation != "")
                sql2 += @" and a.test_group=:station ";
            if (vLine != "")
            {
                if (vLine.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                sql1 += " and a.line_name = :line ";
            }
            string sql = @"select * from 
                            (select x.catalogy,  
                                    y.input as input ,                           
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end pcblrr,                                  
                                   x.error_input,x.percents
                                from                             
                                (select a.duty_party as catalogy,  
                                   NVL(sum(a.qty), 0) as error_input, 
                                   round(ratio_to_report(SUM(a.qty)) over(), 4) * 100 percents  
                                 from (select a.*,a.test_line as line_name,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a " + strFloorSql1 + @")a 
                                 where a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 + sql2 +
                                @"  group by a.duty_party) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a " + strFloorSql2 + @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 + strExSql +
                                @"   and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"";
            sql += @"        ) y ";
            sql += @" order by x.percents desc ";

            sql += @" ) a where rownum <=10 ";
            ht.Clear();
            ht.Add("cust", strCust);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vModel != "")
                ht.Add("model", vModel);
            if (vLine != "")
                ht.Add("line", vLine);
            if (vStation != "")
                ht.Add("station", vStation);
            if (strFloor != "")
                ht.Add("floor", strFloor);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataDutyIOP(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vLine, string vDuty)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "";
            string strShift = "", strCust = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (vLOB != "")
                sql1 += @" and a.model_serial=:lob ";
            if (vLine != "")
                sql1 += " and a.line_name = :line ";
            string sql = @"select * from 
                            (select x.catalogy,  
                                    y.input as input ,                           
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end pcblrr,                                  
                                   x.error_input,x.percents
                                from                             
                                (select a.duty_party as catalogy,  
                                   NVL(sum(a.qty), 0) as error_input, 
                                   round(ratio_to_report(SUM(a.qty)) over(), 4) * 100 percents  
                                 from (select a.*,a.test_line as line_name,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a)a,sfis1.C_DATA_DICTIONARY_T c 
                                 where a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                        and instr(:cust,a.cust_no ) > 0 AND c.DATA_VALUE=:plant2 " + sql1 +
                                @"  group by a.duty_party) x,
                                (select NVL(sum(a.qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_MB_IOP_T a)a ,sfis1.C_PLANT_DEF_T b,sfis1.C_DATA_DICTIONARY_T c  
                                where a.from_plant=b.MES_PLANT AND a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND b.RMS_PLANT =:plant AND b.bu_code = 'PCBG'  
                                             AND c.DATA_VALUE=:plant2 AND a.LINE_NAME NOT LIKE '%REP%' AND a.LINE_NAME NOT LIKE '%NPI%' AND a.LINE_NAME NOT LIKE '%TNB%' " + sql1 + @"";
            sql += @"        ) y ";
            sql += @" order by x.percents desc ";
            sql += @" ) a where rownum <=10 ";
            ht.Clear();
            ht.Add("cust", strCust);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("plant2", vDuty.Replace("VN76", "VNP1"));
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vLine != "")
                ht.Add("line", vLine);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDutyDPPM(string vPlant, string vSapPlant, string vDateType, string vSDate, string vEDate, string vTypeCond, string vType, string vDuty)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sqlType2 = "", sqlType3 = "";
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            if (vDateType == "Daily")
            {
                sqlType2 = " a.work_date ";
                sqlType3 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
                sqlType3 = " to_char(to_date(a.work_date,'YYYYMMDD'),'YYYYIW') ";
            }
            else
            {
                sqlType2 = "substr(a.work_date,1,4)||  'M'|| substr(a.work_date,5,2) ";
                sqlType3 = "substr(a.work_date,1,4)||  'M'|| substr(a.work_date,5,2) ";
            }
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vType == "PARTS")
            {
                if (vTypeCond != "")
                    sql2 += @" and w.location_code=:typecond ";
            }
            else if (vType == "LINE")
            {
                if (vTypeCond != "")
                    sql1 += @" and a.line_name=:typecond ";
            }
            else if (vType == "LOB")
            {
                if (vTypeCond != "")
                    sql1 += @" and a.model_serial =:typecond ";
            }
            else if (vType == "MODEL")
            {
                if (vTypeCond != "")
                    sql1 += @" and a.model_name=:typecond ";
            }
            else
            {
                if (vTypeCond != "")
                    sql1 += @" and a.model_serial =:typecond ";
            }
            if (vDuty != "")
            {
                if (vDuty == "ST" || vDuty == "FM" || vDuty == "NTF")
                    sql2 += @" and g.data_value=:duty ";
                else
                    sql2 += @" and g.data_code=:duty ";
            }
            string sql = @"select catalogy,nvl(percents,0) as percents,nvl(DPPM,0) as DPPM from 
                            (select y.catalogy ,                                    
                                   x.percents,                                                                 
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 1000000)
                                   end DPPM                                 
                                from 
                            (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,     
                                       g.data_value as duty_type,
                                       count(0) error_input,
                                       round(ratio_to_report(count(0)) over(partition by " + sqlType2 + @"), 4) * 100 percents
                                  from sfis1.c_data_dictionary_t g,sfism4.r_repair_info_t w, 
                                       (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where a.serial_number = w.serial_number
                                   and a.item_no = w.item_no  and a.process='FATP'
                                   and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap";
            if (strCust != "A76")
                sql += " and a.FPY_FLAG = 'Y' ";
            sql += @"              and w.duty_type=g.data_code and g.data_type='DUTY_TYPE'
                                 group by " + sqlType3 + "," + sqlType2 + @",g.data_value) x
                                 right outer join ";
            if (vType == "PARTS")
                sql += @"        (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                      and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + @"          
                                      and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"       
                                      group by " + sqlType3 + "," + sqlType2 + @") y
                                on x.catalogy = y.catalogy and x.ordercata=y.ordercata order by y.ordercata,y.catalogy,x.error_input desc
                                ) a  ";
            else if (vType == "LINE")
                sql += @"        (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                      and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + @"          
                                      and a.process = 'FATP'      
                                      group by " + sqlType3 + "," + sqlType2 + @") y
                                on x.catalogy = y.catalogy and x.ordercata=y.ordercata order by y.ordercata,y.catalogy,x.error_input desc
                                ) a  ";
            else
                sql += @"        (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                      and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + @"          
                                      and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"     
                                      group by " + sqlType3 + "," + sqlType2 + @") y
                                on x.catalogy = y.catalogy and x.ordercata=y.ordercata order by y.ordercata,y.catalogy,x.error_input desc
                                ) a   ";

            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            ht.Add("qcond", vSDate);
            ht.Add("qcond2", vEDate);

            if (vTypeCond != "")
                ht.Add("typecond", vTypeCond);
            if (vDuty != "")
            {
                if (vDuty == "ST" || vDuty == "FM")
                    ht.Add("duty", "PCBA LRR");
                else
                    ht.Add("duty", vDuty);
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDutyDPPMSMT(string vPlant, string vSapPlant, string vDateType, string vSDate, string vEDate, string vTypeCond, string vType, string vDuty)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sqlType2 = "", sqlType3 = "";
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            if (vDateType == "Daily")
            {
                sqlType2 = " a.work_date ";
                sqlType3 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
                sqlType3 = " to_char(to_date(a.work_date,'YYYYMMDD'),'YYYYIW') ";
            }
            else
            {
                sqlType2 = "substr(a.work_date,1,4)||  'M'|| substr(a.work_date,5,2) ";
                sqlType3 = "substr(a.work_date,1,4)||  'M'|| substr(a.work_date,5,2) ";
            }
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vType == "PARTS")
            {
                if (vTypeCond != "")
                    sql2 += @" and w.location_code=:typecond ";
            }
            else if (vType == "LINE")
            {
                if (vTypeCond != "")
                    sql1 += @" and a.line_name=:typecond ";
            }
            else if (vType == "LOB")
            {
                if (vTypeCond != "")
                    sql1 += @" and a.model_serial =:typecond ";
            }
            else if (vType == "MODEL")
            {
                if (vTypeCond != "")
                    sql1 += @" and a.model_name=:typecond ";
            }
            else if (vType == "LINE_LOB")
            {
                if (vTypeCond != "")
                {
                    if (vTypeCond.IndexOf("_") > -1)
                    {
                        string[] bb = vTypeCond.Split('_');
                        if (bb[0] != "")
                            sql1 += @" and a.line_name=:typecond ";
                        if (bb[1] != "")
                            sql1 += @" and a.model_serial =:typecond2 ";
                    }
                    else
                        sql1 += @" and a.line_name=:typecond ";
                }
            }
            else if (vType == "LINE_MODEL")
            {
                if (vTypeCond != "")
                {
                    if (vTypeCond.IndexOf("_") > -1)
                    {
                        string[] bb = vTypeCond.Split('_');
                        if (bb[0] != "")
                            sql1 += @" and a.line_name=:typecond ";
                        if (bb[1] != "")
                            sql1 += @" and a.model_name =:typecond2 ";
                    }
                    else
                        sql1 += @" and a.line_name=:typecond ";
                }
            }
            else
            {
                if (vTypeCond != "")
                    sql1 += @" and a.model_serial =:typecond ";
            }
            if (vDuty != "")
            {
                if (vDuty == "ST" || vDuty == "FM" || vDuty == "複判OK" || vDuty == "組包造成" || vDuty.IndexOf("不良") > -1)
                    sql2 += @" and g.data_value=:duty ";
                else
                    sql2 += @" and g.data_code=:duty ";
            }
            string sql = @"select catalogy,nvl(percents,0) as percents,nvl(DPPM,0) as DPPM from 
                            (select y.catalogy ,                                    
                                   x.percents,                                                                 
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 1000000)
                                   end DPPM                                      
                                from 
                            (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,     
                                       g.data_value as duty_type,
                                       count(0) error_input,
                                       round(ratio_to_report(count(0)) over(partition by " + sqlType2 + @"), 4) * 100 percents
                                  from sfis1.c_data_dictionary_t g,sfism4.r_repair_info_t w, 
                                       (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where d.model_name=substr(a.model_name,0,5) and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where a.serial_number = w.serial_number
                                   and a.item_no = w.item_no  and a.process='SMT'
                                    " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap";
            if (strCust != "A76")
                sql += " and a.FPY_FLAG = 'Y' ";
            sql += @"              and w.duty_type=g.data_code and g.data_type='DUTY_TYPE'                                  
                                 group by " + sqlType3 + "," + sqlType2 + @",g.data_value) x
                                 right outer join ";
            if (vType == "PARTS")
                sql += @"        (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                       " + sql1 + strExSql + @"          
                                      and a.process = 'SMT' " + getSubProcess("SMT", strCust) + @"   
                                      group by " + sqlType3 + "," + sqlType2 + @") y
                                on x.catalogy = y.catalogy and x.ordercata=y.ordercata order by y.ordercata,y.catalogy,x.error_input desc
                                ) a  ";
            else if (vType == "LINE")
                sql += @"        (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                       " + sql1 + strExSql + @"          
                                      and a.process = 'SMT'      
                                      group by " + sqlType3 + "," + sqlType2 + @") y
                                on x.catalogy = y.catalogy and x.ordercata=y.ordercata order by y.ordercata,y.catalogy,x.error_input desc
                                ) a  ";
            else
                sql += @"        (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                       " + sql1 + strExSql + @"          
                                      and a.process = 'SMT' " + getSubProcess("SMT", strCust) + @"    
                                      group by " + sqlType3 + "," + sqlType2 + @") y
                                on x.catalogy = y.catalogy and x.ordercata=y.ordercata order by y.ordercata,y.catalogy,x.error_input desc
                                ) a   ";

            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            ht.Add("qcond", vSDate);
            ht.Add("qcond2", vEDate);
            if (vTypeCond != "")
            {
                if (vType == "LINE_LOB" || vType == "LINE_MODEL")
                {
                    if (vTypeCond.IndexOf("_") > -1)
                    {
                        string[] bb = vTypeCond.Split('_');
                        if (bb[0] != "")
                            ht.Add("typecond", vTypeCond.Split('_')[0]);
                        if (bb[1] != "")
                            ht.Add("typecond2", vTypeCond.Split('_')[1]);
                    }
                    else
                        ht.Add("typecond", vTypeCond);
                }
                else
                    ht.Add("typecond", vTypeCond);
            }
            if (vDuty != "")
            {
                if (vDuty == "複判OK")
                    ht.Add("duty", "NTF");
                else if (vDuty == "組包造成")
                    ht.Add("duty", "AFTP");
                else if (vDuty == "ST" || vDuty == "FM")
                    ht.Add("duty", "PCBA LRR");
                else
                    ht.Add("duty", vDuty.Replace("不良", ""));
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDutyDPPMInsightSMT(string vPlant, string vSapPlant, string vDateType, string vSDate, string vEDate, string vTypeCond, string vType, string vDuty)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sqlType2 = "", sqlType3 = "";
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            if (vDateType == "Daily")
            {
                sqlType2 = " a.work_date ";
                sqlType3 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
                sqlType3 = " to_char(to_date(a.work_date,'YYYYMMDD'),'YYYYIW') ";
            }
            else
            {
                sqlType2 = "substr(a.work_date,1,4)||  'M'|| substr(a.work_date,5,2) ";
                sqlType3 = "substr(a.work_date,1,4)||  'M'|| substr(a.work_date,5,2) ";
            }
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vType == "PARTS")
            {
                if (vTypeCond != "")
                    sql2 += @" and w.location_code=:typecond ";
            }
            else if (vType == "LINE")
            {
                if (vTypeCond != "")
                    sql1 += @" and a.line_name=:typecond ";
            }
            else if (vType == "LOB")
            {
                if (vTypeCond != "")
                    sql1 += @" and a.model_serial =:typecond ";
            }
            else if (vType == "MODEL")
            {
                if (vTypeCond != "")
                    sql1 += @" and a.model_name=:typecond ";
            }
            else if (vType == "LINE_LOB")
            {
                if (vTypeCond != "")
                {
                    if (vTypeCond.IndexOf("_") > -1)
                    {
                        string[] bb = vTypeCond.Split('_');
                        if (bb[0] != "")
                            sql1 += @" and a.line_name=:typecond ";
                        if (bb[1] != "")
                            sql1 += @" and a.model_serial =:typecond2 ";
                    }
                    else
                        sql1 += @" and a.line_name=:typecond ";
                }
            }
            else if (vType == "LINE_MODEL")
            {
                if (vTypeCond != "")
                {
                    if (vTypeCond.IndexOf("_") > -1)
                    {
                        string[] bb = vTypeCond.Split('_');
                        if (bb[0] != "")
                            sql1 += @" and a.line_name=:typecond ";
                        if (bb[1] != "")
                            sql1 += @" and a.model_name =:typecond2 ";
                    }
                    else
                        sql1 += @" and a.line_name=:typecond ";
                }
            }
            else
            {
                if (vTypeCond != "")
                    sql1 += @" and a.model_serial =:typecond ";
            }
            if (vDuty != "")
            {
                if (vDuty == "ST" || vDuty == "FM" || vDuty == "複判OK" || vDuty == "組包造成" || vDuty.IndexOf("不良") > -1)
                    sql2 += @" and g.data_value=:duty ";
                else
                    sql2 += @" and g.data_code=:duty ";
            }

            string sql = @"select catalogy,nvl(percents,0) as percents,nvl(DPPM,0) as DPPM from 
                            (select y.catalogy ,                                    
                                   x.percents,                                                                 
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 1000000)
                                   end DPPM                                      
                                from 
                            (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,     
                                       g.data_value as duty_type,
                                       count(0) error_input,
                                       round(ratio_to_report(count(0)) over(partition by " + sqlType2 + @"), 4) * 100 percents
                                  from sfis1.c_data_dictionary_t g,sfism4.r_repair_info_t w, 
                                       (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where d.model_name=substr(a.model_name,0,5) and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where a.serial_number = w.serial_number
                                   and a.item_no = w.item_no  and a.process='SMT'
                                    " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap";
            if (strCust != "A76")
                sql += " and a.FPY_FLAG = 'Y' ";
            sql += @"              and w.duty_type=g.data_code and g.data_type='DUTY_TYPE'                                  
                                 group by " + sqlType3 + "," + sqlType2 + @",g.data_value) x
                                 right outer join ";
            if (vType == "PARTS")
                sql += @"        (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                       " + sql1 + strExSql + @"          
                                      and a.process = 'SMT' " + getSubProcess("SMT", strCust) + @"   
                                      group by " + sqlType3 + "," + sqlType2 + @") y
                                on x.catalogy = y.catalogy and x.ordercata=y.ordercata order by y.ordercata,y.catalogy,x.error_input desc
                                ) a  ";
            else if (vType == "LINE")
                sql += @"        (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                       " + sql1 + strExSql + @"          
                                      and a.process = 'SMT'   
                                      group by " + sqlType3 + "," + sqlType2 + @") y
                                on x.catalogy = y.catalogy and x.ordercata=y.ordercata order by y.ordercata,y.catalogy,x.error_input desc
                                ) a  ";
            else
                sql += @"        (select " + sqlType3 + " as ordercata," + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty), 0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code = 'PCBG'
                                       " + sql1 + strExSql + @"          
                                      and a.process = 'SMT' " + getSubProcess("SMT", strCust) + @"     
                                      group by " + sqlType3 + "," + sqlType2 + @") y
                                on x.catalogy = y.catalogy and x.ordercata=y.ordercata order by y.ordercata,y.catalogy,x.error_input desc
                                ) a   ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            ht.Add("qcond", vSDate);
            ht.Add("qcond2", vEDate);
            if (vTypeCond != "")
            {
                if (vType == "LINE_LOB" || vType == "LINE_MODEL")
                {
                    if (vTypeCond.IndexOf("_") > -1)
                    {
                        string[] bb = vTypeCond.Split('_');
                        if (bb[0] != "")
                            ht.Add("typecond", vTypeCond.Split('_')[0]);
                        if (bb[1] != "")
                            ht.Add("typecond2", vTypeCond.Split('_')[1]);
                    }
                    else
                        ht.Add("typecond", vTypeCond);
                }
                else
                    ht.Add("typecond", vTypeCond);
            }
            if (vDuty != "")
            {
                if (vDuty == "複判OK")
                    ht.Add("duty", "NTF");
                else if (vDuty == "組包造成")
                    ht.Add("duty", "AFTP");
                else if (vDuty == "ST" || vDuty == "FM")
                    ht.Add("duty", "PCBA LRR");
                else
                    ht.Add("duty", vDuty.Replace("不良", ""));
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataIOPPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
            }
            strCust = getCust(vPlant);
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            //if (strShift != "ALL")
            //    sql1 += " and a.shift_period = :shift "; 

            //string sql = @"SELECT x.plant_code as catalogy,x.error_input,
            //                        case
            //                         when y.input = 0 then
            //                          0
            //                         when y.input < x.error_input then
            //                          0
            //                         else
            //                          round((x.error_input / y.input) * 100, 2)
            //                       end pcblrr,x.from_plant,y.input FROM 
            //                        (SELECT a.from_plant,c.DATA_VALUE AS plant_code,sum(a.fail_qty) AS error_input FROM sfism4.R_DAILY_MB_IOP_T a,sfis1.C_PLANT_DEF_T b,sfis1.C_DATA_DICTIONARY_T c  
            //                            WHERE a.from_plant=b.MES_PLANT AND a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND b.RMS_PLANT =:plant" + sql1 + @"
            //                        GROUP BY a.from_plant,c.DATA_VALUE)x,
            //                        (SELECT a.from_plant, sum(a.qty) AS input FROM sfism4.R_DAILY_MB_IOP_T a,sfis1.C_PLANT_DEF_T b 
            //                            WHERE a.from_plant=b.MES_PLANT AND b.RMS_PLANT =:plant" + sql1 + @"
            //                        GROUP BY a.from_plant)y order by x.plant_code ";
            //string sql = @" SELECT x.catalogy,y.input,
            //                        case
            //                         when y.input = 0 then
            //                          0
            //                         when y.input < x.error_input then
            //                          0
            //                         else
            //                          round((x.error_input / y.input) * 100, 2)
            //                       end pcblrr,x.error_input FROM 
            //                       (SELECT c.DATA_VALUE AS catalogy,sum(a.qty) AS error_input FROM sfism4.R_DAILY_PCBALRR_T a,sfis1.C_DATA_DICTIONARY_T c  
            //                       WHERE a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
            //                            and instr(:cust,a.cust_no ) > 0 AND a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' " + sql1 + @" 
            //                       GROUP BY c.DATA_VALUE)x,
            //                         (SELECT c.DATA_VALUE AS catalogy,sum(a.qty) AS INPUT FROM sfism4.R_DAILY_MB_IOP_T a,sfis1.C_PLANT_DEF_T b,sfis1.C_DATA_DICTIONARY_T c  
            //                            WHERE a.from_plant=b.MES_PLANT AND a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND b.bu_code = 'PCBG' AND b.RMS_PLANT =:plant" + sql1 + @"
            //                        GROUP BY a.from_plant,c.DATA_VALUE)y
            //                        WHERE x.catalogy=y.catalogy ";
            //string sql = @" SELECT x.catalogy,y.input,
            //                        case
            //                         when y.input = 0 then
            //                          0
            //                         when y.input < x.error_input then
            //                          0
            //                         else
            //                          round((x.error_input / y.input) * 100, 2)
            //                       end pcblrr,x.error_input FROM 
            //                       (SELECT c.DATA_VALUE AS catalogy,sum(a.fail_qty) AS error_input FROM sfism4.R_DAILY_MB_IOP_T a,sfis1.C_PLANT_DEF_T b,sfis1.C_DATA_DICTIONARY_T c  
            //                       WHERE a.plant_code=b.MES_PLANT AND a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND b.bu_code = 'PCBG' AND b.RMS_PLANT =:plant" + sql1 + @"
            //                       GROUP BY c.DATA_VALUE)x,
            //                         (SELECT c.DATA_VALUE AS catalogy,sum(a.qty) AS INPUT FROM sfism4.R_DAILY_MB_IOP_T a,sfis1.C_PLANT_DEF_T b,sfis1.C_DATA_DICTIONARY_T c  
            //                            WHERE a.from_plant=b.MES_PLANT AND a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND b.bu_code = 'PCBG' AND b.RMS_PLANT =:plant" + sql1 + @"
            //                        GROUP BY a.from_plant,c.DATA_VALUE)y
            //                        WHERE x.catalogy=y.catalogy ";
            string sql = @" SELECT y.catalogy,y.input,
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < y.error_input then
                                      0
                                     else
                                      round((y.error_input / y.input) * 100, 2)
                                   end pcblrr,y.error_input FROM                                  
                                     (SELECT c.DATA_VALUE AS catalogy,sum(a.qty) AS INPUT,sum(a.fail_qty) AS error_input FROM sfism4.R_DAILY_MB_IOP_T a,sfis1.C_PLANT_DEF_T b,sfis1.C_DATA_DICTIONARY_T c  
                                        WHERE a.from_plant=b.MES_PLANT AND a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND b.bu_code = 'PCBG' AND b.RMS_PLANT =:plant 
                                                 AND a.LINE_NAME NOT LIKE '%REP%' AND a.LINE_NAME NOT LIKE '%NPI%' AND a.LINE_NAME NOT LIKE '%TNB%' " + sql1 + @"
                                    GROUP BY a.from_plant,c.DATA_VALUE)y ";
            ht.Clear();
            //if (strShift != "ALL")
            //    ht.Add("shift", strShift);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            //   ht.Add("cust", strCust);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetErrorTableExtend(string vPlant, string vSapPlant, string vDateType, string vQCond, string vProcess, string vTestCode)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            bool bInsight = false;
            string sql1 = "", sql2 = "";
            string strPlant = "", strShift = "", strCust = "", strProcess = "FATP", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //  strExSql = " and a.model_serial like :ex1 ";
                if (strExType.IndexOf("_") > -1)
                {
                    vPlant = vPlant + "_" + strExType.Split('_')[1];
                    strExType = strExType.Split('_')[0];
                }
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vPlant.IndexOf("_") > -1)
            {
                strPlant = vPlant.Split('_')[0];
                string strTempProcess = vPlant.Split('_')[1];
                bInsight = true;
                if (strTempProcess.IndexOf("InsightSMT") > -1)
                {
                    strProcess = "SMT";
                    strMProcess = "SMT";
                }
                else
                {
                    strProcess = "FATP";
                    strMProcess = "FATP";
                }
            }
            else
                strPlant = vPlant;
            strCust = getCust(strPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vTestCode != "")
            {
                //if (bInsight)
                //    sql2 += " and a.error_code = :test ";
                //else
                sql2 += " and a.test_code = :test ";
            }
            if (strMProcess == "SMT" && strPlant == "VNP1")
                strExSql += @"     and instr(:cust,a.cust_no ) >0 ";
            string sql = "";
            if (strProcess == "FATP")
            {
                if (bInsight)
                {
                    #region Insight
                    sql = @"select x.group_name as GNAME,
                                       x.qty,
                                       x.percents,
                                       case when (y.input>0) then
                                       round(x.qty / y.input, 4) * 100 
                                       else 
                                       0 
                                       end as FR
                          from (select a.group_name as group_name,  
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_plant_def_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;

                    sql += @"      and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT'  ";
                    sql += @"      and a.plant_code = p.mes_plant and a.process='FATP' and p.bu_code='PCBG' and p.rms_plant=:plant                 
                                 group by a.group_name) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"      
                                   ) y  
                                order by x.qty desc ";
                }
                #endregion
                else
                {
                    #region FATP FPY                   
                    #endregion
                }
            }
            else
            {
                if (bInsight)
                {
                    #region Insight SMT
                    sql = @"select x.group_name as GNAME,
                                       x.qty,
                                       x.percents,
                                       case when (y.input>0) then
                                       round(x.qty / y.input, 4) * 100 
                                       else 
                                       0 
                                       end as FR
                          from (select a.group_name as group_name,  
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_plant_def_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;

                    sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                    sql += @"      and a.plant_code = p.mes_plant and a.process='SMT' and p.bu_code='PCBG' and p.rms_plant=:plant                 
                                 group by a.group_name) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"      
                                   ) y  
                                order by x.qty desc ";
                }
                #endregion
                else
                {
                    #region SMT
                    #endregion
                }
            }
            ht.Clear();
            if ((strProcess == "FATP") || (strMProcess == "SMT" && strPlant == "VNP1"))
                ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", strPlant.Replace("VN76", "VNP1"));

            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vTestCode != "")
                ht.Add("test", vTestCode);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetErrorTableExtendModel(string vPlant, string vSapPlant, string vDateType, string vQCond, string vProcess, string vTestCode, string vModel = "", string vTypes = "MODEL", string vLineType = "", int iTop = 0)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            bool bInsight = false;
            string sql1 = "", sql2 = "", sqlType = "model_name";
            string strPlant = "", strShift = "", strCust = "", strProcess = "FATP", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //  strExSql = " and a.model_serial like :ex1 ";
                if (strExType.IndexOf("_") > -1)
                {
                    vPlant = vPlant + "_" + strExType.Split('_')[1];
                    strExType = strExType.Split('_')[0];
                }
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vPlant.IndexOf("_") > -1)
            {
                strPlant = vPlant.Split('_')[0];
                string strTempProcess = vPlant.Split('_')[1];
                if (strTempProcess.IndexOf("Insight") > -1)
                    bInsight = true;
            }
            else
                strPlant = vPlant;
            strProcess = vProcess;
            strMProcess = vProcess;
            strCust = getCust(strPlant);
            if (vTypes == "LINE")
                sqlType = @"line_name";
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vTestCode != "")
            {
                //if (bInsight)
                //    sql2 += " and a.error_code = :test ";
                //else
                sql2 += " and a.test_code = :test ";
                //      sql2 += " and a."+ sqlType+" = :test ";              
            }
            if (strMProcess == "SMT" && strPlant == "VNP1")
                strExSql += @"     and instr(:cust,a.cust_no ) >0 ";
            string sql = "";
            if (strProcess == "FATP")
            {
                if (bInsight)
                {
                    #region Insight FATP
                    sql = @"select * from 
                               (select x.group_name as test_code,
                                max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                                x.qty,
                                x.percents,
                                case when (y.input>0) then
                                round(x.qty / y.input, 4) * 100 
                                else 
                                0 
                                end as FR
                          from (select a." + sqlType + @" as group_name,  
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code,a.*, nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code =:plant and d.bu_code = 'PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_plant_def_t p
                                 where 1 = 1 " + sql1 + strExSql + sql2;
                    if (vModel != "")
                        sql += @" and a." + sqlType + @"=:model ";
                    if (vTypes == "LINE" && vLineType != "")
                        sql += @" AND (SELECT mes_line FROM sfis1.C_LINE_DEF_T WHERE MES_LINE = a.line_name AND SUB_PROCESS=:linetype) IS NOT null";
                    sql += @"      and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT'  ";
                    sql += @"      and a.plant_code = p.mes_plant and a.process='FATP' and p.bu_code='PCBG' and p.rms_plant=:plant                 
                                 group by a." + sqlType + @") x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql;
                    //if (vModel != "")
                    //    sql += @" and a." + sqlType + @"=:model ";
                    sql += @"      and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"      
                                   ) y, ";
                    sql += @"(select a." + sqlType + @" as group_name,
                                   	d.data_code as location_code,  
                                    case when d.data_code is null then 0 else sum(a.qty) end qty    
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_plant_def_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;
                    if (vModel != "")
                        sql += @" and a." + sqlType + @"=:model ";
                    if (vTypes == "LINE" && vLineType != "")
                        sql += @" AND (SELECT mes_line FROM sfis1.C_LINE_DEF_T WHERE MES_LINE = a.line_name AND SUB_PROCESS=:linetype) IS NOT null";
                    sql += @"      and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT'  ";
                    sql += @"      and a.plant_code = p.mes_plant and a.process='FATP' and p.bu_code='PCBG' and p.rms_plant=:plant                 
                                 group by a." + sqlType + @", d.data_code) z 
                              where z.group_name=x.group_name
                              group by x.group_name,x.qty,x.percents,y.input order by qty desc )";
                    if (iTop != 0)
                        sql += " where rownum <= :top ";
                }
                #endregion
                else
                {
                    #region FATP FPY     
                    sql = @"select * from 
                               (select x.group_name as test_code,
                                max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                                x.qty,
                                x.percents,
                                case when (y.input>0) then
                                round(x.qty / y.input, 4) * 100 
                                else 
                                0 
                                end as FR
                          from (select a." + sqlType + @" as group_name,  
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.R_ERROR_INFO_T a)a 
                                 where 1=1 " + sql1 + strExSql + sql2;
                    if (vModel != "")
                        sql += @" and a." + sqlType + @"=:model ";
                    if (vTypes == "LINE" && vLineType != "")
                        sql += @" AND (SELECT mes_line FROM sfis1.C_LINE_DEF_T WHERE MES_LINE = a.line_name AND SUB_PROCESS=:linetype) IS NOT null";
                    sql += @"      and instr(:cust,a.cust_no ) >0 and a.process='FATP' and a.FPY_FLAG = 'Y' and a.plant_code like :sap        
                                 group by a." + sqlType + @") x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql;
                    //if (vModel != "")
                    //    sql += @" and a." + sqlType + @"=:model ";
                    sql += @"      and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"      
                                   ) y, ";
                    sql += @"(select a." + sqlType + @" as group_name,
                                       w.location_code as location_code,
                                       case when w.location_code is null then 0 else count(0) end qty 
                                from 
                                (select a.*   
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.R_ERROR_INFO_T a)a  
                                 where 1=1 " + sql1 + strExSql + sql2;
                    if (vModel != "")
                        sql += @" and a." + sqlType + @"=:model ";
                    if (vTypes == "LINE" && vLineType != "")
                        sql += @" AND (SELECT mes_line FROM sfis1.C_LINE_DEF_T WHERE MES_LINE = a.line_name AND SUB_PROCESS=:linetype) IS NOT null";
                    sql += @"      and a.FPY_FLAG = 'Y' and a.plant_code like :sap and instr(:cust,a.cust_no ) >0 and a.process='FATP' )a
                                   left outer join  sfism4.r_repair_info_t w
                                   on a.serial_number = w.serial_number  and a.item_no = w.item_no   
                                     group by a." + sqlType + @", w.location_code ) z 
                              where z.group_name=x.group_name
                              group by x.group_name,x.qty,x.percents,y.input order by qty desc )";
                    if (iTop != 0)
                        sql += " where rownum <= :top ";
                    #endregion
                }
            }
            else
            {
                if (bInsight)
                {
                    #region Insight SMT
                    sql = @"select * from 
                               (select x.group_name as test_code,
                                max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                                x.qty,
                                x.percents,
                                case when (y.input>0) then
                                round(x.qty / y.input, 4) * 100 
                                else 
                                0 
                                end as FR
                          from (select a." + sqlType + @" as group_name,  
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_plant_def_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;
                    if (vModel != "")
                        sql += @" and a." + sqlType + @"=:model ";
                    if (vTypes == "LINE" && vLineType != "")
                        sql += @" AND (SELECT mes_line FROM sfis1.C_LINE_DEF_T WHERE MES_LINE = a.line_name AND SUB_PROCESS=:linetype) IS NOT null";
                    sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                    sql += @"      and a.plant_code = p.mes_plant and a.process='SMT' and p.bu_code='PCBG' and p.rms_plant=:plant                 
                                 group by a." + sqlType + @") x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql;
                    //if (vModel != "")
                    //    sql += @" and a." + sqlType + @"=:model ";
                    sql += @"      and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"      
                                   ) y ,";
                    sql += @"   (select a." + sqlType + @" as group_name,  
                                   		d.data_code as location_code,
                                        case when d.data_code is null then 0 else sum(a.qty) end qty    
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_plant_def_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;
                    if (vModel != "")
                        sql += @" and a." + sqlType + @"=:model ";
                    if (vTypes == "LINE" && vLineType != "")
                        sql += @" AND (SELECT mes_line FROM sfis1.C_LINE_DEF_T WHERE MES_LINE = a.line_name AND SUB_PROCESS=:linetype) IS NOT null";
                    sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                    sql += @"      and a.plant_code = p.mes_plant and a.process='SMT' and p.bu_code='PCBG' and p.rms_plant=:plant                 
                                 group by a." + sqlType + @",d.data_code) z 
                              where z.group_name=x.group_name
                              group by x.group_name,x.qty,x.percents,y.input order by qty desc )";
                    if (iTop != 0)
                        sql += " where rownum <= :top ";
                }
                #endregion
                else
                {
                    #region SMT
                    sql = @"select * from 
                               (select x.group_name as test_code,
                                max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                                x.qty,
                                x.percents,
                                case when (y.input>0) then
                                round(x.qty / y.input, 4) * 100 
                                else 
                                0 
                                end as FR
                          from (select a." + sqlType + @" as group_name,  
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.R_ERROR_INFO_T a)a    
                                 where 1=1 " + sql1 + strExSql + sql2;
                    if (vModel != "")
                        sql += @" and a." + sqlType + @"=:model ";
                    if (vTypes == "LINE" && vLineType != "")
                        sql += @" AND (SELECT mes_line FROM sfis1.C_LINE_DEF_T WHERE MES_LINE = a.line_name AND SUB_PROCESS=:linetype) IS NOT null";
                    sql += @"     and a.process='SMT' and a.FPY_FLAG = 'Y' and a.plant_code like :sap           
                                 group by a." + sqlType + @") x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql;
                    //if (vModel != "")
                    //    sql += @" and a." + sqlType + @"=:model ";
                    sql += @"      and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"      
                                   ) y ,";
                    sql += @"   (select a." + sqlType + @" as group_name,
                                       w.location_code as location_code,
                                       case when w.location_code is null then 0 else count(0) end qty 
                                from 
                                (select a.*   
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.R_ERROR_INFO_T a)a 
                                 where 1=1 " + sql1 + strExSql + sql2;
                    if (vModel != "")
                        sql += @" and a." + sqlType + @"=:model ";
                    if (vTypes == "LINE" && vLineType != "")
                        sql += @" AND (SELECT mes_line FROM sfis1.C_LINE_DEF_T WHERE MES_LINE = a.line_name AND SUB_PROCESS=:linetype) IS NOT null";
                    sql += @"     and a.process='SMT' and a.FPY_FLAG = 'Y' and a.plant_code like :sap )a
                                   left outer join  sfism4.r_repair_info_t w
                                   on a.serial_number = w.serial_number  and a.item_no = w.item_no   
                                     group by a." + sqlType + @", w.location_code ) z 
                              where z.group_name=x.group_name
                              group by x.group_name,x.qty,x.percents,y.input order by qty desc )";
                    if (iTop != 0)
                        sql += " where rownum <= :top ";
                    #endregion
                }
            }
            ht.Clear();
            if ((strProcess == "FATP") || (strMProcess == "SMT" && strPlant == "VNP1"))
                ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else if (vSapPlant.IndexOf("VN") > -1)
                ht.Add("sap", "VN%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", strPlant.Replace("VN76", "VNP1"));

            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vTestCode != "")
                ht.Add("test", vTestCode);
            if (vModel != "")
                ht.Add("model", vModel);
            if (iTop != 0)
                ht.Add("top", iTop);
            if (vTypes == "LINE" && vLineType != "")
                ht.Add("linetype", vLineType);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetErrorTable(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vTypeCond, string vType, string vStation,
                                    int iTOP, string vTestCode, string vLocaCode, string vMetType, string vDuty)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            bool bInsight = false, bPcblrr = false, bIOP = false, bItemCode = false;
            string strFloorSql1 = "", strFloorSql2 = "", strFloor = "";
            string sql1 = "", sql2 = "", sql3 = "", sqlType1 = "", sqlType2 = "", strAdd = "", strAdd2 = "";
            string strPlant = "", strShift = "", strCust = "", strProcess = "FATP", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                // strExSql = " and a.model_serial like :ex1 ";
                if (strExType.IndexOf("_") > -1)
                {
                    string[] cc = strExType.Split('_');
                    vPlant = vPlant + "_" + cc[1];
                    if (cc.Length > 2)
                        vPlant = vPlant + "_" + cc[2];
                    strExType = strExType.Split('_')[0];
                }
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vPlant.IndexOf("_") > -1)
            {
                if (vPlant.IndexOf("_IOP") > -1)
                {
                    vPlant = vPlant.Replace("_IOP", "");
                    bIOP = true;
                }
                strPlant = vPlant.Split('_')[0];
                string strTempProcess = vPlant.Split('_')[1];
                if (strTempProcess.IndexOf("Insight") > -1)
                {
                    bInsight = true;
                    if (strTempProcess.IndexOf("InsightSMT") > -1)
                    {
                        strProcess = "SMT";
                        strMProcess = "SMT";
                    }
                    else
                    {
                        strProcess = "FATP";
                        strMProcess = "FATP";
                    }
                    if (vPlant.IndexOf("ItemCode") > -1)
                        bItemCode = true;
                }
                else if (strTempProcess.IndexOf("PcbLrr") > -1)
                {
                    bPcblrr = true;
                    if (strTempProcess.IndexOf("Component") > -1)
                        strAdd = "fatp_location";
                    else if (strTempProcess.IndexOf("Duty") > -1)
                        strAdd = "duty_party";
                    else if (strTempProcess.IndexOf("ERROR") > -1)
                        strAdd = "test_code";
                    else if (strTempProcess.IndexOf("REASON") > -1)
                        strAdd = "reason_code";
                    else if (strTempProcess.IndexOf("Location") > -1)
                        strAdd += "location_code";
                    if (strTempProcess.IndexOf("ERROR") > -1)
                        strAdd2 = "fatp_location";
                    else if (strTempProcess.IndexOf("REASON") > -1)
                        strAdd2 = "location_code";
                }
                else
                {
                    if (strTempProcess.IndexOf("SMT") > -1)
                    {
                        strProcess = "SMT";
                        strMProcess = "SMT";
                    }
                }
            }
            else
                strPlant = vPlant;
            strCust = getCust(strPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
            {
                sql1 += @" and a.model_serial=:lob ";
                if (vLOB.IndexOf("-2F") > -1 || vLOB.IndexOf("-3F") > -1)
                {
                    string[] bb = vLOB.Split('-');
                    for (int i = 0; i < bb.Length; i++)
                    {
                        if (i != bb.Length - 1)
                        {
                            if (i != 0)
                                vLOB += "-" + bb[i];
                            else
                                vLOB = bb[i];
                        }
                        else
                            strFloor = bb[i];
                    }
                    strFloorSql1 = " WHERE a.test_line IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                    strFloorSql2 = " WHERE a.line_name IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                }
            }
            if (vTestCode != "")
            {
                if (bInsight)
                {
                    if (bItemCode)
                        sql2 += " and a.error_code = :test ";
                    else
                        sql2 += " and a.test_code = :test ";

                }
                else if (bPcblrr)
                {
                    if (vPlant.IndexOf("Component") > -1)
                        sql2 += " and a.fatp_location = :test ";
                    else if (vPlant.IndexOf("Duty") > -1)
                        sql2 += " and a.duty_party = :test ";
                    else if (vPlant.IndexOf("ERROR") > -1)
                        sql2 += " and a.test_code = :test ";
                    else if (vPlant.IndexOf("REASON") > -1)
                        sql2 += " and a.reason_code = :test ";
                    else if (vPlant.IndexOf("Location") > -1)
                        sql2 += " and a.location_code = :test ";
                }
                else
                    sql2 += " and a.test_code = :test ";
            }
            if (bPcblrr && !bIOP)
            {
                if (vStation != "")
                    sql2 += " and a.test_group = :groupname ";
                if (vDuty != "")
                    sql2 += " and a.duty_party = :duty ";
            }
            if (vType == "LINE")
            {
                if (vTypeCond.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                else if (vTypeCond.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                sql1 += " and a.line_name = :typecond ";
            }
            else if (vType == "MODEL")
            {
                if (strProcess == "SMT")
                    sql1 += " and substr(a.model_name,0,5) = :typecond ";
                else
                    sql1 += " and a.model_name = :typecond ";
            }
            else if (vType == "MODELLINE")
            {
                sql1 += " and a.line_name = :typecond2 ";
                string[] bb = vTypeCond.Split(';');
                if (bb[1].IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                else if (bb[1].IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                if (strProcess == "SMT")
                    sql1 += " and substr(a.model_name,0,5) = :typecond ";
                else
                    sql1 += " and a.model_name = :typecond ";
            }
            if (vMetType == "ME")
                sqlType1 += " and ed.error_type in ('A','C','F') ";
            else if (vMetType == "EE")
                sqlType1 += " and ed.error_type in ('E') ";
            if (strMProcess == "SMT" && strPlant == "VNP1")
                strExSql += @"     and instr(:cust,a.cust_no ) >0 ";
            string sql = "";
            if (strProcess == "FATP")
            {
                if (vMetType != "" && !bInsight)
                {
                    if (bPcblrr)
                    {
                        #region PcbLrr
                        if (strAdd == "duty_party" || strAdd == "fatp_location" || strAdd == "location_code")
                        {
                            if (bIOP)
                            {
                                sql = @"select test_code,'' as error_desc,'' as location_code, qty,percents,fr
                             from (select x.test_code, 
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a." + strAdd + @" as test_code,  
                                       SUM(a.qty) qty,
                                       round(ratio_to_report(SUM(a.qty)) over(), 4) * 100 percents
                                  from (select a.*,a.test_line as line_name,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a)a,sfis1.C_DATA_DICTIONARY_T c 
                                 where a.mfg_id = c.DATA_CODE AND c.DATA_TYPE = 'IOP_MFG_ID' " + sql1 + sql2;
                                sql += @"      and instr(:cust,a.cust_no ) >0 AND c.DATA_VALUE =:plant2 
                                   and a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1)   
                                 group by a." + strAdd + @") x,
                               (select NVL(sum(a.qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_MB_IOP_T a)a,sfis1.C_PLANT_DEF_T b,sfis1.C_DATA_DICTIONARY_T c  
                                where a.from_plant=b.MES_PLANT AND a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND b.RMS_PLANT =:plant AND b.bu_code = 'PCBG' 
                                             AND c.DATA_VALUE=:plant2 AND a.LINE_NAME NOT LIKE '%REP%' AND a.LINE_NAME NOT LIKE '%NPI%' AND a.LINE_NAME NOT LIKE '%TNB%' " + sql1 + @"
                                   ) y  
                                group by x.test_code,x.qty,x.percents,y.input                          
                                order by x.qty desc ) where rownum <= :top";
                            }
                            else
                            {
                                sql = @"select test_code,'' as error_desc,'' as location_code, qty,percents,fr
                             from (select x.test_code, 
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a." + strAdd + @" as test_code,  
                                       SUM(a.qty) qty,
                                       round(ratio_to_report(SUM(a.qty)) over(), 4) * 100 percents
                                  from (select a.*,a.test_line as line_name,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a " + strFloorSql1 + @")a 
                                 where 1=1 " + sql1 + sql2;
                                sql += @"      and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1)   
                                 group by a." + strAdd + @") x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a " + strFloorSql2 + @")a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"  
                                   ) y  
                                group by x.test_code,x.qty,x.percents,y.input                          
                                order by x.qty desc ) where rownum <= :top";
                            }
                        }
                        else
                        {
                            if (bIOP)
                            {
                                sql = @"select test_code,";
                                if (strAdd == "test_code")
                                    sql += "ed.error_desc";
                                else
                                    sql += "'' as error_desc";
                                sql += @",location_code, qty,percents,fr
                             from (select x.test_code, 
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z." + strAdd2 + @") keep(dense_rank first order by z.qty desc) location_code
                          from(select a." + strAdd + @" as test_code,
                                       SUM(a.qty) qty,
                                       round(ratio_to_report(SUM(a.qty)) over(), 4) * 100 percents
                                  from(select a.*,a.test_line as line_name, nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code =:plant
                                          ), a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a)a,sfis1.C_DATA_DICTIONARY_T c 
                                  where a.mfg_id = c.DATA_CODE AND c.DATA_TYPE = 'IOP_MFG_ID' " + sql1 + sql2;
                                sql += @"      and instr(:cust,a.cust_no ) >0  AND c.DATA_VALUE =:plant2 
                                   and a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1)   
                                 group by a." + strAdd + @") x,
                               (select NVL(sum(a.qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_MB_IOP_T a)a,sfis1.C_PLANT_DEF_T b,sfis1.C_DATA_DICTIONARY_T c  
                                where a.from_plant=b.MES_PLANT AND a.mfg_id=c.DATA_CODE AND c.DATA_TYPE ='IOP_MFG_ID' AND b.RMS_PLANT =:plant AND b.bu_code = 'PCBG' 
                                             AND c.DATA_VALUE=:plant2 AND a.LINE_NAME NOT LIKE '%REP%' AND a.LINE_NAME NOT LIKE '%NPI%' AND a.LINE_NAME NOT LIKE '%TNB%' " + sql1 + @"
                                   ) y  ,
                                (select a." + strAdd + @" as test_code,a." + strAdd2 + @",  
                                       SUM(a.qty) qty,
                                       round(ratio_to_report(SUM(a.qty)) over(), 4) * 100 percents
                                  from (select a.*,a.test_line as line_name,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a)a,sfis1.C_DATA_DICTIONARY_T c 
                                 where a.mfg_id = c.DATA_CODE AND c.DATA_TYPE = 'IOP_MFG_ID' " + sql1 + sql2;
                                sql += @" and instr(:cust,a.cust_no ) >0  AND c.DATA_VALUE =:plant2 
                                   and a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1)   
                                 group by a." + strAdd + ",a." + strAdd2 + @") z
                                  WHERE x.test_code=z.test_code 
                                group by x.test_code,x.qty,x.percents,y.input                          
                                order by x.qty desc )a ";
                                if (strAdd == "test_code")
                                    sql += @",sfis1.C_ERROR_DESC_T  ed 
                                WHERE a.test_code= ed.error_code and rownum <= :top";
                                else
                                    sql += @" WHERE rownum <= :top";
                            }
                            else
                            {
                                sql = @"select test_code,";
                                if (strAdd == "test_code")
                                    sql += "ed.error_desc";
                                else
                                    sql += "'' as error_desc";
                                sql += @",location_code, qty,percents,fr
                             from (select x.test_code, 
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z." + strAdd2 + @") keep(dense_rank first order by z.qty desc) location_code
                          from(select a." + strAdd + @" as test_code,
                                       SUM(a.qty) qty,
                                       round(ratio_to_report(SUM(a.qty)) over(), 4) * 100 percents
                                  from(select a.*,a.test_line as line_name, nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code =:plant
                                          ), a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a " + strFloorSql1 + @")a
                                  where 1 = 1 " + sql1 + sql2;
                                sql += @"      and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1)   
                                 group by a." + strAdd + @") x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a " + strFloorSql2 + @")a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"  
                                   ) y  ,
                                (select a." + strAdd + @" as test_code,a." + strAdd2 + @",  
                                       SUM(a.qty) qty,
                                       round(ratio_to_report(SUM(a.qty)) over(), 4) * 100 percents
                                  from (select a.*,a.test_line as line_name,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a " + strFloorSql1 + @")a 
                                 where 1=1 " + sql1 + sql2;
                                sql += @" and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1)   
                                 group by a." + strAdd + ",a." + strAdd2 + @") z
                                  WHERE x.test_code=z.test_code 
                                group by x.test_code,x.qty,x.percents,y.input                          
                                order by x.qty desc )a ";
                                if (strAdd == "test_code")
                                    sql += @",sfis1.C_ERROR_DESC_T  ed 
                                WHERE a.test_code= ed.error_code and rownum <= :top";
                                else
                                    sql += @" WHERE rownum <= :top";
                            }
                        }
                        #endregion
                    }
                    else
                    {
                        #region FATP ERROR
                        if (vStation == "")
                        {
                            sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                             from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.test_code, 
                                       ed.error_desc,  
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t ed 
                                 where a.test_code=ed.error_code " + sql1 + strExSql + sql2 + sqlType1;
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap           
                                   and a.process='FATP'      
                                 group by a.test_code,ed.error_desc) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"       
                                   ) y ,
                                (select a.test_code,
                                       w.location_code as location_code,
                                       case when w.location_code is null then 0 else count(0) end qty 
                                from 
                                (select a.* 
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t ed 
                                 where a.test_code=ed.error_code " + sql1 + strExSql + sql2 + sqlType1;
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap        
                                   and a.process='FATP' )a
                                   left outer join  sfism4.r_repair_info_t w
                                   on a.serial_number = w.serial_number  and a.item_no = w.item_no   
                                     group by a.test_code, w.location_code) z       
                                where z.test_code=x.test_code
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input                          
                                order by x.qty desc ) where rownum <= :top";
                        }
                        else if (vStation != "")
                        {
                            bool bNonInsight = false;
                            if (vStation.IndexOf("_NONINSIGHT") > -1)
                                bNonInsight = true;
                            vStation = vStation.Replace("_NONINSIGHT", "");
                            sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                              from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.test_code,
                                       ed.error_desc,  
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_error_desc_t ed 
                                 where a.test_code=ed.error_code " + sql1 + strExSql + sql2 + sqlType1;
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            if (bNonInsight && vStation == "STRU2")
                                sql += " and (a.test_code like '1%' or a.test_code like '6%') ";
                            sql += @"      and instr(:cust,a.cust_no ) >0 
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap           
                                   and a.process='FATP'      
                                 group by a.test_code,ed.error_desc) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                   ) y ,
                                (select a.test_code,                                       
                                       w.location_code as location_code,
                                       case when w.location_code is null then 0 else count(0) end qty 
                                from 
                                (select a.*  
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_error_desc_t ed  
                                 where a.test_code=ed.error_code " + sql1 + strExSql + sql2 + sqlType1;
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            if (bNonInsight && vStation == "STRU2")
                                sql += " and (a.test_code like '1%' or a.test_code like '6%') ";
                            sql += @"      and instr(:cust,a.cust_no ) >0 
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP' 
                                   and d.data_value=:groupname
                                   and a.plant_code like:sap                  
                                   and a.process='FATP' )a
                                   left outer join  sfism4.r_repair_info_t w
                                   on a.serial_number = w.serial_number  and a.item_no = w.item_no   
                                     group by a.test_code, w.location_code) z
                                where z.test_code=x.test_code
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                        }
                        #endregion
                    }
                }
                else
                {
                    if (bInsight)
                    {
                        if (bItemCode)
                        {
                            if (vStation != "" && vStation.IndexOf("_INSIGHT") > -1)
                            {
                                vStation = vStation.Replace("_INSIGHT", "");
                                #region Insight Item
                                if (vLOB == "" && vType == "LOB")
                                {
                                    sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,
                            case WHEN model_name is null then 'N/A' else CASE WHEN LENGTH(model_name)>=5 THEN substr(model_name,0,5) ELSE model_name end end as model_name,
                                  qty,percents,fr
                                from (select x.test_code,x.error_desc,
                                 max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                                 max(v.model_name) keep(dense_rank first order by v.qty desc) model_name,
                                 x.qty,
                                 x.percents,
                                 case when (y.input>0) then
                                 round(x.qty / y.input, 4) * 100 
                                 else 
                                 0 
                                 end as FR
                            from (select a.error_code as test_code,   
                                         CASE WHEN nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code),NULL) IS NULL THEN 
                                            nvl((select ei.ITEM_DESC from sfis1.c_error_itemcode_t ei where a.error_code = ei.item_code" + sqlType2 + @"),NULL )
                                            ELSE 
                                            nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code" + sqlType2 + @"),NULL) 
                                            END as error_desc,                                      
                                         sum(a.qty) qty,
                                         round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                            ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p  
                                   where 1=1 " + sql1 + strExSql + sql2;

                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                     and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"     and d.data_code=:groupname ";
                                    sql += @"           and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant 
                                   group by a.error_code) x,
                                 (select nvl(sum(a.output_qty),0) input
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                            ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                   where a.bu_code = 'PCBG' and instr(:cust,a.cust_no ) >0 
                                     and a.plant_code like :sap " + sql1 + strExSql + @"       
                                     and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                     ) y ,
                                  (select a.error_code as test_code,                                     
                                         d.data_code as location_code,
                                         case when d.data_code is null then 0 else sum(a.qty) end qty      
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                            ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                                   where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                     and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"      and d.data_code=:groupname ";
                                    sql += @"          and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant  
                                       group by a.error_code, d.data_code) z,
                                  (select a.error_code as test_code,                                     
                                         a.model_name,
                                         case when a.model_name is null then 0 else sum(a.qty) end qty      
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                            ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                                   where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                     and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"      and d.data_code=:groupname ";
                                    sql += @"          and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant  
                                       group by a.error_code, a.model_name) v
                                  where z.test_code=x.test_code AND v.test_code=x.test_code 
                                  group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                  order by x.qty desc ) where rownum <= :top";
                                }
                                else
                                {
                                    sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                                from (select x.test_code,x.error_desc,
                                 max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                                 x.qty,
                                 x.percents,
                                 case when (y.input>0) then
                                 round(x.qty / y.input, 4) * 100 
                                 else 
                                 0 
                                 end as FR
                            from (select a.error_code as test_code,  
                                         CASE WHEN nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code),NULL) IS NULL THEN 
                                            nvl((select ei.ITEM_DESC from sfis1.c_error_itemcode_t ei where a.error_code = ei.item_code" + sqlType2 + @"),NULL )
                                            ELSE 
                                            nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code" + sqlType2 + @"),NULL) 
                                            END as error_desc,  
                                         sum(a.qty) qty,
                                         round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                            ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p  
                                   where 1=1 " + sql1 + strExSql + sql2;

                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                     and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"     and d.data_code=:groupname ";
                                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant      
                                   group by a.error_code) x,
                                 (select nvl(sum(a.output_qty),0) input
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                            ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                   where a.bu_code = 'PCBG' and instr(:cust,a.cust_no ) >0 
                                     and a.plant_code like :sap " + sql1 + strExSql + @"       
                                     and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"      
                                     ) y ,
                                  (select a.error_code as test_code,                                     
                                          a.location_code,
                                         case when a.location_code is null then 0 else sum(a.qty) end qty      
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                            ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p   
                                   where 1=1 " + sql1 + strExSql + sql2;

                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                     and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"      and d.data_code=:groupname ";
                                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant 
                                       group by a.error_code, a.location_code) z
                                  where z.test_code=x.test_code 
                                  group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                  order by x.qty desc ) where rownum <= :top";
                                }
                                #endregion
                            }
                            else
                            {
                                #region Insight Item
                                if (vLOB == "" && vType == "LOB")
                                {
                                    sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,
		                        case WHEN model_name is null then 'N/A' else CASE WHEN LENGTH(model_name)>=5 THEN substr(model_name,0,5) ELSE model_name end end as model_name,
                                qty,percents,fr
                              from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               max(v.model_name) keep(dense_rank first order by v.qty desc) model_name,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.error_code as test_code,   
                                       CASE WHEN nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code),NULL) IS NULL THEN 
                                          nvl((select ei.ITEM_DESC from sfis1.c_error_itemcode_t ei where a.error_code = ei.item_code" + sqlType2 + @"),NULL )
                                          ELSE 
                                          nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code" + sqlType2 + @"),NULL) 
                                          END as error_desc,                                      
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0   ";
                                    if (vStation != "")
                                        sql += @"     and (a.group_name=:groupname or a.group_name in (select t.data_code from sfis1.c_data_dictionary_t t where t.data_type='FPY_GROUP' and data_value=:groupname) ) ";
                                    sql += @"           and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant 
                                 group by a.error_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG' and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                   ) y ,
                                (select a.error_code as test_code,                                     
                                       a.group_name as location_code,
                                       sum(a.qty) qty      
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t p   
                                 where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0 ";
                                    if (vStation != "")
                                        sql += @"      and (a.group_name=:groupname or a.group_name in (select t.data_code from sfis1.c_data_dictionary_t t where t.data_type='FPY_GROUP' and data_value=:groupname) ) ";
                                    sql += @"          and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant  
                                     group by a.error_code,a.group_name) z,
                                (select a.error_code as test_code,                                     
                                       a.model_name,
                                       case when a.model_name is null then 0 else sum(a.qty) end qty      
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                                 where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0 ";
                                    if (vStation != "")
                                        sql += @"     and (a.group_name=:groupname or a.group_name in (select t.data_code from sfis1.c_data_dictionary_t t where t.data_type='FPY_GROUP' and data_value=:groupname) ) ";
                                    sql += @"          and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant  
                                     group by a.error_code, a.model_name) v
                                where z.test_code=x.test_code AND v.test_code=x.test_code 
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                                }
                                else
                                {
                                    sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                              from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.error_code as test_code,  
                                       CASE WHEN nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code),NULL) IS NULL THEN 
                                          nvl((select ei.ITEM_DESC from sfis1.c_error_itemcode_t ei where a.error_code = ei.item_code" + sqlType2 + @"),NULL )
                                          ELSE 
                                          nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code" + sqlType2 + @"),NULL) 
                                          END as error_desc,  
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a , sfis1.c_data_dictionary_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0  ";
                                    if (vStation != "")
                                        sql += @"     and (a.group_name=:groupname or a.group_name in (select t.data_code from sfis1.c_data_dictionary_t t where t.data_type='FPY_GROUP' and data_value=:groupname) ) ";
                                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant      
                                 group by a.error_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG' and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"      
                                   ) y ,
                                (select a.error_code as test_code,                                     
                                        a.location_code,
                                       case when a.location_code is null then 0 else sum(a.qty) end qty      
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a , sfis1.c_data_dictionary_t p   
                                 where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0 ";
                                    if (vStation != "")
                                        sql += @"      and (a.group_name=:groupname or a.group_name in (select t.data_code from sfis1.c_data_dictionary_t t where t.data_type='FPY_GROUP' and data_value=:groupname) ) ";
                                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant 
                                     group by a.error_code, a.location_code) z
                                where z.test_code=x.test_code 
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                                }
                                #endregion
                            }
                        }
                        else
                        {
                            #region old Insight
                            //  if (vLOB == "" && vType == "LOB")
                            //  {
                            //      sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,
                            //case WHEN model_name is null then 'N/A' else CASE WHEN LENGTH(model_name)>=5 THEN substr(model_name,0,5) ELSE model_name end end as model_name,
                            //      qty,percents,fr
                            //    from (select x.test_code,x.error_desc,
                            //     max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                            //     max(v.model_name) keep(dense_rank first order by v.qty desc) model_name,
                            //     x.qty,
                            //     x.percents,
                            //     case when (y.input>0) then
                            //     round(x.qty / y.input, 4) * 100 
                            //     else 
                            //     0 
                            //     end as FR
                            //from (select a.error_code as test_code, 
                            //              nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code " + sqlType2 + @"),'NULL') as error_desc,
                            //              nvl((select ed.error_desc from sfis1.c_error_desc_t ed,sfis1.c_error_itemcode_t ei 
                            //                        where a.error_code = ei.item_code and ei.error_code= ed.error_code" + sqlType2 + @"),'NULL' ) as item_desc,                                         
                            //             sum(a.qty) qty,
                            //             round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                            //        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                            //                ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p  
                            //       where 1=1 " + sql1 + strExSql + sql2;

                            //      sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                            //         and d.data_type = 'FPY_GROUP_INSIGHT' ";
                            //      if (vStation != "")
                            //          sql += @"     and d.data_code=:groupname ";
                            //      sql += @"           and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant 
                            //       group by a.error_code) x,
                            //     (select nvl(sum(a.output_qty),0) input
                            //        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                            //                ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                            //       where a.bu_code = 'PCBG' and instr(:cust,a.cust_no ) >0 
                            //         and a.plant_code like :sap " + sql1 + strExSql + @"       
                            //         and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                            //         ) y ,
                            //      (select a.error_code as test_code,                                     
                            //             d.data_code as location_code,
                            //             case when d.data_code is null then 0 else sum(a.qty) end qty      
                            //        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                            //                ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                            //       where 1=1 " + sql1 + strExSql + sql2;
                            //      sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                            //         and d.data_type = 'FPY_GROUP_INSIGHT' ";
                            //      if (vStation != "")
                            //          sql += @"      and d.data_code=:groupname ";
                            //      sql += @"          and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant  
                            //           group by a.error_code, d.data_code) z,
                            //      (select a.error_code as test_code,                                     
                            //             a.model_name,
                            //             case when a.model_name is null then 0 else sum(a.qty) end qty      
                            //        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                            //                ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                            //       where 1=1 " + sql1 + strExSql + sql2;
                            //      sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                            //         and d.data_type = 'FPY_GROUP_INSIGHT' ";
                            //      if (vStation != "")
                            //          sql += @"      and d.data_code=:groupname ";
                            //      sql += @"          and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant  
                            //           group by a.error_code, a.model_name) v
                            //      where z.test_code=x.test_code AND v.test_code=x.test_code AND x.item_desc ='NULL'
                            //      group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                            //      order by x.qty desc ) where rownum <= :top";
                            //  }
                            //  else
                            //  {
                            //      sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                            //    from (select x.test_code,x.error_desc,
                            //     max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                            //     x.qty,
                            //     x.percents,
                            //     case when (y.input>0) then
                            //     round(x.qty / y.input, 4) * 100 
                            //     else 
                            //     0 
                            //     end as FR
                            //from (select a.error_code as test_code, 
                            //              nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code " + sqlType2 + @"),'NULL') as error_desc,
                            //              nvl((select ed.error_desc from sfis1.c_error_desc_t ed,sfis1.c_error_itemcode_t ei 
                            //                        where a.error_code = ei.item_code and ei.error_code= ed.error_code" + sqlType2 + @"),'NULL' ) as item_desc,                
                            //             sum(a.qty) qty,
                            //             round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                            //        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                            //                ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p  
                            //       where 1=1 " + sql1 + strExSql + sql2;

                            //      sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                            //         and d.data_type = 'FPY_GROUP_INSIGHT' ";
                            //      if (vStation != "")
                            //          sql += @"     and d.data_code=:groupname ";
                            //      sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant      
                            //       group by a.error_code) x,
                            //     (select nvl(sum(a.output_qty),0) input
                            //        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                            //                ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                            //       where a.bu_code = 'PCBG' and instr(:cust,a.cust_no ) >0 
                            //         and a.plant_code like :sap " + sql1 + strExSql + @"       
                            //         and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"      
                            //         ) y ,
                            //      (select a.error_code as test_code,                                     
                            //              a.location_code,
                            //             case when a.location_code is null then 0 else sum(a.qty) end qty      
                            //        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                            //                ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p   
                            //       where 1=1 " + sql1 + strExSql + sql2;

                            //      sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                            //         and d.data_type = 'FPY_GROUP_INSIGHT' ";
                            //      if (vStation != "")
                            //          sql += @"      and d.data_code=:groupname ";
                            //      sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant 
                            //           group by a.error_code, a.location_code) z
                            //      where z.test_code=x.test_code AND x.item_desc ='NULL'
                            //      group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                            //      order by x.qty desc ) where rownum <= :top";
                            //  }
                            #endregion
                            if (vStation != "" && vStation.IndexOf("_INSIGHT") > -1)
                            {
                                vStation = vStation.Replace("_INSIGHT", "");
                                #region new Insight
                                if (vLOB == "" && vType == "LOB")
                                {
                                    sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,
                            case WHEN model_name is null then 'N/A' else CASE WHEN LENGTH(model_name)>=5 THEN substr(model_name,0,5) ELSE model_name end end as model_name,
                                  qty,percents,fr
                                from (select x.test_code,x.error_desc,
                                 max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                                 max(v.model_name) keep(dense_rank first order by v.qty desc) model_name,
                                 x.qty,
                                 x.percents,
                                 case when (y.input>0) then
                                 round(x.qty / y.input, 4) * 100 
                                 else 
                                 0 
                                 end as FR
                            from (select a.test_code, 
                                          nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.test_code = ed.error_code " + sqlType2 + @"),NULL) as error_desc,                                                
                                         sum(a.qty) qty,
                                         round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                    from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                    where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                    where a.error_code = ei.item_code),NULL)
                                                    ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                            ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p  
                                   where 1=1 " + sql1 + strExSql + sql2;

                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                     and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"     and d.data_code=:groupname ";
                                    sql += @"           and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant 
                                   group by a.test_code) x,
                                 (select nvl(sum(a.output_qty),0) input
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                            ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                   where a.bu_code = 'PCBG' and instr(:cust,a.cust_no ) >0 
                                     and a.plant_code like :sap " + sql1 + strExSql + @"       
                                     and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                     ) y ,
                                  (select a.test_code,                                     
                                         d.data_code as location_code,
                                         case when d.data_code is null then 0 else sum(a.qty) end qty      
                                    from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                    where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                    where a.error_code = ei.item_code),NULL)
                                                    ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                            ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                                   where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                     and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"      and d.data_code=:groupname ";
                                    sql += @"          and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant  
                                       group by a.test_code, d.data_code) z,
                                  (select a.test_code,                                     
                                         a.model_name,
                                         case when a.model_name is null then 0 else sum(a.qty) end qty      
                                    from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                    where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                    where a.error_code = ei.item_code),NULL)
                                                    ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                            ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                                   where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                     and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"      and d.data_code=:groupname ";
                                    sql += @"          and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant  
                                       group by a.test_code, a.model_name) v
                                  where z.test_code=x.test_code AND v.test_code=x.test_code AND x.error_desc IS NOT NULL
                                  group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                  order by x.qty desc ) where rownum <= :top";
                                }
                                else
                                {
                                    sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                                from (select x.test_code,x.error_desc,
                                 max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                                 x.qty,
                                 x.percents,
                                 case when (y.input>0) then
                                 round(x.qty / y.input, 4) * 100 
                                 else 
                                 0 
                                 end as FR
                            from (select a.test_code, 
                                          nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.test_code = ed.error_code " + sqlType2 + @"),NULL) as error_desc, 
                                         sum(a.qty) qty,
                                         round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                    from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                    where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                    where a.error_code = ei.item_code),NULL)
                                                    ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                            ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p  
                                   where 1=1 " + sql1 + strExSql + sql2;

                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                     and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"     and d.data_code=:groupname ";
                                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant      
                                   group by a.test_code) x,
                                 (select nvl(sum(a.output_qty),0) input
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                            ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                   where a.bu_code = 'PCBG' and instr(:cust,a.cust_no ) >0 
                                     and a.plant_code like :sap " + sql1 + strExSql + @"       
                                     and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"      
                                     ) y ,
                                  (select a.test_code,                                     
                                          a.location_code,
                                         case when a.location_code is null then 0 else sum(a.qty) end qty      
                                    from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                    where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                    where a.error_code = ei.item_code),NULL)
                                                    ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                            ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p   
                                   where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                     and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"      and d.data_code=:groupname ";
                                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant 
                                       group by a.test_code, a.location_code) z
                                  where z.test_code=x.test_code AND x.error_desc IS NOT NULL
                                  group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                  order by x.qty desc ) where rownum <= :top";
                                }
                                #endregion
                            }
                            else
                            {
                                #region new no station Insight
                                if (vLOB == "" && vType == "LOB")
                                {
                                    sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,
                                case WHEN model_name is null then 'N/A' else CASE WHEN LENGTH(model_name)>=5 THEN substr(model_name,0,5) ELSE model_name end end as model_name,
                                      qty,percents,fr
                                    from (select x.test_code,x.error_desc,
                                     max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                                     max(v.model_name) keep(dense_rank first order by v.qty desc) model_name,
                                     x.qty,
                                     x.percents,
                                     case when (y.input>0) then
                                     round(x.qty / y.input, 4) * 100 
                                     else 
                                     0 
                                     end as FR
                                from (select a.test_code, 
                                              nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.test_code = ed.error_code " + sqlType2 + @"),NULL) as error_desc,                                                
                                             sum(a.qty) qty,
                                             round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                        from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                        where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                        where a.error_code = ei.item_code),NULL)
                                                        ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                                ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p  
                                       where 1=1 " + sql1 + strExSql + sql2;

                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                         and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"     and d.data_code=:groupname ";
                                    sql += @"           and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant 
                                       group by a.test_code) x,
                                     (select nvl(sum(a.output_qty),0) input
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                                ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                       where a.bu_code = 'PCBG' and instr(:cust,a.cust_no ) >0 
                                         and a.plant_code like :sap " + sql1 + strExSql + @"       
                                         and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                         ) y ,
                                      (select a.test_code,                                     
                                             d.data_code as location_code,
                                             case when d.data_code is null then 0 else sum(a.qty) end qty      
                                        from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                        where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                        where a.error_code = ei.item_code),NULL)
                                                        ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                                ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                                       where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                         and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"      and d.data_code=:groupname ";
                                    sql += @"          and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant  
                                           group by a.test_code, d.data_code) z,
                                      (select a.test_code,                                     
                                             a.model_name,
                                             case when a.model_name is null then 0 else sum(a.qty) end qty      
                                        from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                        where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                        where a.error_code = ei.item_code),NULL)
                                                        ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                                ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                                       where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0 and a.group_name = d.data_value
                                         and d.data_type = 'FPY_GROUP_INSIGHT' ";
                                    if (vStation != "")
                                        sql += @"      and d.data_code=:groupname ";
                                    sql += @"          and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant  
                                           group by a.test_code, a.model_name) v
                                      where z.test_code=x.test_code AND v.test_code=x.test_code AND x.error_desc IS NOT NULL
                                      group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                      order by x.qty desc ) where rownum <= :top";
                                }
                                else
                                {
                                    sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                              from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.test_code, 
                                        nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.test_code = ed.error_code " + sqlType2 + @"),NULL) as error_desc, 
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a , sfis1.c_data_dictionary_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;

                                    sql += @" and instr(:cust,a.cust_no ) >0 ";
                                    if (vStation != "")
                                        sql += @"     and (a.group_name=:groupname or a.group_name in (select t.data_code from sfis1.c_data_dictionary_t t where t.data_type='FPY_GROUP' and data_value=:groupname) ) ";
                                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant      
                                 group by a.test_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG' and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"      
                                   ) y ,
                                (select a.test_code,                                     
                                        a.location_code,
                                       case when a.location_code is null then 0 else sum(a.qty) end qty      
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a , sfis1.c_data_dictionary_t p   
                                 where 1=1 " + sql1 + strExSql + sql2;
                                    sql += @" and instr(:cust,a.cust_no ) >0 ";
                                    if (vStation != "")
                                        sql += @"      and (a.group_name=:groupname or a.group_name in (select t.data_code from sfis1.c_data_dictionary_t t where t.data_type='FPY_GROUP' and data_value=:groupname) ) ";
                                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant 
                                     group by a.test_code, a.location_code) z
                                where z.test_code=x.test_code AND x.error_desc IS NOT NULL
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                                }
                                #endregion
                            }
                        }
                    }
                    else
                    {
                        #region FATP FPY
                        if (vStation == "")
                        {
                            sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                             from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.test_code, 
                                       nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.test_code = ed.error_code " + sqlType2 + @"),'NULL' ) as error_desc, 
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where 1=1 " + sql1 + strExSql + sql2;
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap           
                                   and a.process='FATP'    
                                 group by a.test_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"  
                                   ) y ,
                                (select a.test_code,
                                       w.location_code as location_code,
                                       case when w.location_code is null then 0 else count(0) end qty 
                                from 
                                (select a.* 
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where 1=1 " + sql1 + strExSql + sql2;
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap        
                                   and a.process='FATP' )a
                                   left outer join sfism4.r_repair_info_t w
                                   on a.serial_number = w.serial_number  and a.item_no = w.item_no   
                                     group by a.test_code, w.location_code) z       
                                where z.test_code=x.test_code
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input                          
                                order by x.qty desc ) where rownum <= :top";
                        }
                        else if (vStation != "")
                        {
                            sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                              from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.test_code,
                                       nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.test_code = ed.error_code " + sqlType2 + @"),'NULL' ) as error_desc,   
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where 1=1 " + sql1 + strExSql + sql2;
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and instr(:cust,a.cust_no ) >0 
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap           
                                   and a.process='FATP'            
                                 group by a.test_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                   ) y ,
                                (select a.test_code,                                       
                                       w.location_code as location_code,
                                       case when w.location_code is null then 0 else count(0) end qty 
                                from 
                                (select a.*  
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where 1=1 " + sql1 + strExSql + sql2;
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and instr(:cust,a.cust_no ) >0 
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP' 
                                   and d.data_value=:groupname
                                   and a.plant_code like:sap                  
                                   and a.process='FATP' )a
                                   left outer join  sfism4.r_repair_info_t w
                                   on a.serial_number = w.serial_number  and a.item_no = w.item_no   
                                     group by a.test_code, w.location_code) z
                                where z.test_code=x.test_code
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                        }
                        #endregion
                    }
                }
            }
            else
            {
                if (bInsight)
                {
                    if (bItemCode)
                    {
                        #region Insight SMT
                        if (vLOB == "" && vType == "LOB")
                        {
                            sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,
		                        case WHEN model_name is null then 'N/A' else CASE WHEN LENGTH(model_name)>=5 THEN substr(model_name,0,5) ELSE model_name end end as model_name,
                                qty,percents,fr
                              from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               max(v.model_name) keep(dense_rank first order by v.qty desc) model_name,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.error_code as test_code,   
                                       CASE WHEN nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code),NULL) IS NULL THEN 
                                          nvl((select ei.ITEM_DESC from sfis1.c_error_itemcode_t ei where a.error_code = ei.item_code" + sqlType2 + @"),NULL )
                                          ELSE 
                                          nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code" + sqlType2 + @"),NULL) 
                                          END as error_desc,                                  
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;

                            sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                            if (vStation != "")
                                sql += @"     and d.data_code=:groupname ";
                            sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.DATA_VALUE=:plant            
                                 group by a.error_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"    
                                   ) y ,
                                (select a.error_code as test_code,                                     
                                       d.data_code as location_code,
                                       case when d.data_code is null then 0 else sum(a.qty) end qty      
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                                 where 1=1 " + sql1 + strExSql + sql2;

                            sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                            if (vStation != "")
                                sql += @"      and d.data_code=:groupname ";
                            sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.DATA_VALUE=:plant          
                                     group by a.error_code, d.data_code) z,
                                (select a.error_code as test_code,                                     
                                       a.model_name,
                                       case when a.model_name is null then 0 else sum(a.qty) end qty      
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                                 where 1=1 " + sql1 + strExSql + sql2;
                            sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                            if (vStation != "")
                                sql += @"      and d.data_code=:groupname ";
                            sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.DATA_VALUE=:plant          
                                     group by a.error_code, a.model_name) v
                                where z.test_code=x.test_code AND v.test_code=x.test_code 
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                        }
                        else
                        {
                            sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                              from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.error_code as test_code,    
                                       CASE WHEN nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code),NULL) IS NULL THEN 
                                          nvl((select ei.ITEM_DESC from sfis1.c_error_itemcode_t ei where a.error_code = ei.item_code" + sqlType2 + @"),NULL )
                                          ELSE 
                                          nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.error_code = ed.error_code" + sqlType2 + @"),NULL) 
                                          END as error_desc,  
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;

                            sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                            if (vStation != "")
                                sql += @"     and d.data_code=:groupname ";
                            sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.DATA_VALUE=:plant                     
                                 group by a.error_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"      
                                   ) y ,
                                (select a.error_code as test_code,                                     
                                        a.location_code,
                                       case when a.location_code is null then 0 else sum(a.qty) end qty      
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p   
                                 where 1=1 " + sql1 + strExSql + sql2;

                            sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                            if (vStation != "")
                                sql += @"      and d.data_code=:groupname ";
                            sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.data_value=:plant          
                                     group by a.error_code, a.location_code) z
                                where z.test_code=x.test_code 
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                        }
                        #endregion
                    }
                    else
                    {
                        #region Insight SMT
                        if (vLOB == "" && vType == "LOB")
                        {
                            sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,
		                        case WHEN model_name is null then 'N/A' else CASE WHEN LENGTH(model_name)>=5 THEN substr(model_name,0,5) ELSE model_name end end as model_name,
                                qty,percents,fr
                              from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               max(v.model_name) keep(dense_rank first order by v.qty desc) model_name,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.test_code, 
                                        nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.test_code = ed.error_code " + sqlType2 + @"),NULL) as error_desc,                                        
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code,a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;

                            sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                            if (vStation != "")
                                sql += @"     and d.data_code=:groupname ";
                            sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.DATA_VALUE=:plant            
                                 group by a.test_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"    
                                   ) y ,
                                (select a.test_code,                                     
                                       d.data_code as location_code,
                                       case when d.data_code is null then 0 else sum(a.qty) end qty      
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code, a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                                 where 1=1 " + sql1 + strExSql + sql2;

                            sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                            if (vStation != "")
                                sql += @"      and d.data_code=:groupname ";
                            sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.DATA_VALUE=:plant          
                                     group by a.test_code, d.data_code) z,
                                (select a.test_code,                                     
                                       a.model_name,
                                       case when a.model_name is null then 0 else sum(a.qty) end qty      
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code, a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t p   
                                 where 1=1 " + sql1 + strExSql + sql2;
                            sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                            if (vStation != "")
                                sql += @"      and d.data_code=:groupname ";
                            sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.DATA_VALUE=:plant          
                                     group by a.test_code, a.model_name) v
                                where z.test_code=x.test_code AND v.test_code=x.test_code AND x.error_desc IS NOT NULL 
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                        }
                        else
                        {
                            sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                              from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.test_code,  
                                        nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.test_code = ed.error_code " + sqlType2 + @"),NULL) as error_desc, 
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code, a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;

                            sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                            if (vStation != "")
                                sql += @"     and d.data_code=:groupname ";
                            sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.DATA_VALUE=:plant                     
                                 group by a.test_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"      
                                   ) y ,
                                (select a.test_code,                                     
                                        a.location_code,
                                       case when a.location_code is null then 0 else sum(a.qty) end qty      
                                  from (select CASE WHEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL) IS NOT NULL THEN nvl((SELECT ei.ERROR_CODE FROM sfis1.c_error_itemcode_t ei 
                                                  where a.error_code = ei.item_code),NULL)
                                                  ELSE a.error_code END as test_code, a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p   
                                 where 1=1 " + sql1 + strExSql + sql2;

                            sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                            if (vStation != "")
                                sql += @"      and d.data_code=:groupname ";
                            sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.data_value=:plant          
                                     group by a.test_code, a.location_code) z
                                where z.test_code=x.test_code AND x.error_desc IS NOT NULL 
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                        }
                        #endregion
                    }

                }
                else
                {
                    #region SMT
                    if (vStation == "")
                    {
                        sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                             from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.test_code, 
                                       nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.test_code = ed.error_code " + sqlType2 + @"),'NULL' ) as error_desc, 
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where 1=1 " + sql1 + strExSql + sql2 + sql3;
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.plant_code like :sap           
                                   and a.process='SMT'   
                                 group by a.test_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a  
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"     
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"    
                                   ) y ,
                                (select a.test_code,
                                       w.location_code as location_code,
                                       case when w.location_code is null then 0 else count(0) end qty 
                                from 
                                (select a.* 
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where 1=1 " + sql1 + strExSql + sql2;
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.plant_code like :sap        
                                   and a.process='SMT' )a
                                   left outer join  sfism4.r_repair_info_t w
                                   on a.serial_number = w.serial_number  and a.item_no = w.item_no   
                                     group by a.test_code, w.location_code) z       
                                where z.test_code=x.test_code
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input                          
                                order by x.qty desc ) where rownum <= :top";
                    }
                    else if (vStation != "")
                    {
                        sql = @"select test_code,error_desc,case when location_code is null then 'N/A' else location_code end as location_code,qty,percents,fr
                              from (select x.test_code,x.error_desc,
                               max(z.location_code) keep(dense_rank first order by z.qty desc) location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.test_code,
                                       nvl((select ed.error_desc from sfis1.c_error_desc_t ed where a.test_code = ed.error_code " + sqlType2 + @"),'NULL' ) as error_desc, 
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where 1=1 " + sql1 + strExSql + sql2;
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP_SMT' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap           
                                   and a.process='SMT'                
                                 group by a.test_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"     
                                   ) y ,
                                (select a.test_code,                                       
                                       w.location_code as location_code,
                                       case when w.location_code is null then 0 else count(0) end qty 
                                from 
                                (select a.*  
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d    
                                 where 1=1 " + sql1 + strExSql + sql2;
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP_SMT' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap                  
                                   and a.process='SMT'  )a
                                   left outer join  sfism4.r_repair_info_t w
                                   on a.serial_number = w.serial_number  and a.item_no = w.item_no   
                                     group by a.test_code, w.location_code) z
                                where z.test_code=x.test_code
                                group by x.test_code,x.error_desc,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                    }
                    #endregion
                }
            }
            ht.Clear();
            if ((strProcess == "FATP") || (strMProcess == "SMT" && strPlant == "VNP1"))
                ht.Add("cust", strCust);
            if (!bIOP)
            {
                if (vSapPlant.IndexOf("CQ") > -1)
                    ht.Add("sap", "CQ%");
                else if (vSapPlant.IndexOf("CD") > -1)
                    ht.Add("sap", "CD%");
                else
                    ht.Add("sap", vSapPlant);
                if (strShift != "ALL")
                    ht.Add("shift", strShift);
                if (vStation != "")
                    ht.Add("groupname", vStation);
                if (bPcblrr)
                {
                    if (vDuty != "")
                        ht.Add("duty", vDuty);
                    if (strFloor != "")
                        ht.Add("floor", strFloor);
                }
            }
            else
                ht.Add("plant2", vDuty.Replace("VN76", "VNP1"));
            ht.Add("top", iTOP);
            ht.Add("plant", strPlant.Replace("VN76", "VNP1"));
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vType == "MODELLINE")
            {
                string[] bb = vTypeCond.Split(';');
                ht.Add("typecond", bb[0]);
                ht.Add("typecond2", bb[1]);
            }
            else
            {
                if (vTypeCond != "")
                    ht.Add("typecond", vTypeCond);
            }
            if (vTestCode != "")
                ht.Add("test", vTestCode);
            if (vLocaCode != "")
                ht.Add("loca", vLocaCode);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetPartsTable(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vTypeCond, string vType, string vDuty, string vStation,
                                    int iTOP, string vLocaCode = "", string vMetType = "")
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            bool bInsight = false;
            string sql1 = "", sql2 = "", sql3 = "", sqlType1 = "";
            string strPlant = "", strShift = "", strCust = "", strProcess = "FATP", strMProcess = "FATP"; ;
            string strExSql = "", strExType = "";
            #region Para
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                // strExSql = " and a.model_serial like :ex1 ";
                if (strExType.IndexOf("_") > -1)
                {
                    vPlant = vPlant + "_" + strExType.Split('_')[1];
                    strExType = strExType.Split('_')[0];
                }
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vPlant.IndexOf("_") > -1)
            {
                strPlant = vPlant.Split('_')[0];
                string strTempProcess = vPlant.Split('_')[1];
                if (strTempProcess.IndexOf("Insight") > -1)
                {
                    bInsight = true;
                    if (strTempProcess.IndexOf("InsightSMT") > -1)
                    {
                        strProcess = "SMT";
                        strMProcess = "SMT";
                    }
                    else
                    {
                        strProcess = "FATP";
                        strMProcess = "FATP";
                    }
                }
                else
                {
                    if (strTempProcess.IndexOf("SMT") > -1)
                    {
                        strProcess = "SMT";
                        strMProcess = "SMT";
                    }
                }
            }
            else
                strPlant = vPlant;
            strCust = getCust(strPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += " and a.model_serial = :lob ";
            if (vLocaCode != "")
            {
                if (bInsight)
                    sql2 += " and a.location_code = :loca ";
                else
                    sql2 += " and w.location_code = :loca ";
            }
            if (vType == "LINE")
            {
                if (vTypeCond.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                else if (vTypeCond.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                sql1 += " and a.line_name = :typecond ";
            }
            else if (vType == "MODEL")
            {
                if (strProcess == "SMT")
                    sql1 += " and substr(a.model_name,0,5) = :typecond ";
                else
                    sql1 += " and a.model_name = :typecond ";
            }
            else if (vType == "MODELLINE")
            {
                sql1 += " and a.line_name = :typecond2 ";
                string[] bb = vTypeCond.Split(';');
                if (bb[1].IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                else if (bb[1].IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                if (strProcess == "SMT")
                    sql1 += " and substr(a.model_name,0,5) = :typecond ";
                else
                    sql1 += " and a.model_name = :typecond ";
            }
            if (strMProcess == "SMT" && strPlant == "VNP1")
                strExSql += @"     and instr(:cust,a.cust_no ) >0 ";
            if (vMetType == "ME")
                sqlType1 += " and ed.error_type in ('A','C','F') ";
            else if (vMetType == "EE")
                sqlType1 += " and ed.error_type in ('E') ";
            string sql = "";
            #endregion
            if (strProcess == "FATP")
            {
                if (bInsight)
                {
                    #region Insight
                    sql = @"select * 
                              from (select x.location_code,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.location_code,  
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p  
                                 where 1=1  and instr(:cust,a.cust_no ) > 0 " + sql1 + strExSql + sql2;

                    sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT' ";
                    if (vStation != "")
                        sql += @"     and d.data_code=:groupname ";
                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant             
                                 group by a.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG' and instr(:cust,a.cust_no ) > 0 
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @" 
                                   ) y ,
                                (select a.location_code,                                     
                                       ed.error_desc,
                                       case when ed.error_desc is null then 0 else sum(a.qty) end qty         
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a,sfis1.c_data_dictionary_t d,sfis1.c_error_desc_t ed  ,sfis1.c_data_dictionary_t p   
                                 where a.error_code=ed.error_code and instr(:cust,a.cust_no ) > 0 " + sql1 + strExSql + sql2;

                    sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT' ";
                    if (vStation != "")
                        sql += @"      and d.data_code=:groupname ";
                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='FATP' and p.DATA_VALUE=:plant                
                                     group by a.location_code, ed.error_desc) z
                                where z.location_code=x.location_code and z.location_code!='N/A' 
                                group by x.location_code,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                }
                #endregion
                else
                {
                    if (vMetType == "ALL" || vMetType == "")
                    {
                        #region FATP
                        if (vDuty == "" && vStation == "")
                        {
                            sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc 
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a  
                                 where a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap        
                                   and a.process='FATP'        
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"  
                                   ) y  ,
                                 (select w.location_code,
                                        a.test_code,
                                        c.error_desc,
                                        count(0) qty 
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"    
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap        
                                   and a.process='FATP'             
                                   and a.test_code=c.error_code 
                                 group by w.location_code,a.test_code,c.error_desc) z
                                 where z.location_code=x.location_code
                                 group by x.location_code,x.qty,x.percents, y.input 
                                   order by x.qty desc ) where rownum <= :top";
                        }
                        else if (vDuty != "" && vStation == "")
                        {
                            sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0 
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.plant_code like :sap        
                                   and a.process='FATP'                
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"   
                                   ) y  ,
                                (select w.location_code,
                                        a.test_code,
                                        c.error_desc,
                                        count(0) qty 
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0 
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.plant_code like :sap        
                                   and a.process='FATP'    
                                 and a.test_code=c.error_code 
                                 group by w.location_code,a.test_code,c.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input
                                   order by x.qty desc ) where rownum <= :top";
                        }
                        else if (vDuty == "" && vStation != "")
                        {
                            sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0                                    
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='FATP'                
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                   ) y ,
                                (select w.location_code,
                                        a.test_code,
                                        c.error_desc,
                                        count(0) qty 
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0                                    
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='FATP'                 
                                   and a.test_code=c.error_code 
                                 group by w.location_code,a.test_code,c.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input
                                   order by x.qty desc ) where rownum <= :top";
                        }
                        else if (vDuty != "" && vStation != "")
                        {
                            sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t f
                                 where a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0 
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.group_name = f.data_code
                                   and f.data_type = 'FPY_GROUP' 
                                   and f.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='FATP'          
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                   ) y ,
                                (select w.location_code,
                                        a.test_code,
                                        c.error_desc,
                                        count(0) qty 
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t f ,sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0 
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.group_name = f.data_code
                                   and f.data_type = 'FPY_GROUP' 
                                   and f.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='FATP'                  
                                   and a.test_code=c.error_code 
                                 group by w.location_code,a.test_code,c.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input
                                   order by x.qty desc ) where rownum <= :top";
                        }
                        #endregion
                    }
                    else
                    {
                        #region FATP TYPE
                        if (vStation == "")
                        {
                            sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc 
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t ed 
                                 where a.test_code=ed.error_code and a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sqlType1 + @"                                    
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap        
                                   and a.process='FATP'        
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"  
                                   ) y  ,
                                 (select w.location_code,
                                        a.test_code,
                                        c.error_desc,
                                        count(0) qty 
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t c ,sfis1.c_error_desc_t ed 
                                 where a.test_code=ed.error_code and a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sqlType1 + @"    
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap        
                                   and a.process='FATP'             
                                   and a.test_code=c.error_code 
                                 group by w.location_code,a.test_code,c.error_desc) z
                                 where z.location_code=x.location_code
                                 group by x.location_code,x.qty,x.percents, y.input 
                                   order by x.qty desc ) where rownum <= :top";
                        }
                        else if (vStation != "")
                        {
                            sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d ,sfis1.c_error_desc_t ed 
                                 where a.test_code=ed.error_code and a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sqlType1 + @"                                    
                                   and instr(:cust,a.cust_no ) >0                                    
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='FATP'                
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                   ) y ,
                                (select w.location_code,
                                        a.test_code,
                                        ed.error_desc,
                                        count(0) qty 
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_error_desc_t ed 
                                 where a.test_code=ed.error_code and a.serial_number = w.serial_number ";
                            if (strCust != "A76")
                                sql += " and a.FPY_FLAG = 'Y' ";
                            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0                                    
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='FATP'      
                                 group by w.location_code,a.test_code,ed.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input
                                   order by x.qty desc ) where rownum <= :top";
                        }
                        #endregion
                    }
                }
            }
            else
            {
                if (bInsight)
                {
                    #region Insight SMT
                    sql = @"select * 
                              from (select x.location_code,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select a.location_code,  
                                       sum(a.qty) qty,
                                       round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t p  
                                 where 1=1 " + sql1 + strExSql + sql2;

                    sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                    if (vStation != "")
                        sql += @"     and d.data_code=:groupname ";
                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.DATA_VALUE=:plant                        
                                 group by a.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @" 
                                   ) y ,
                                (select a.location_code,                                     
                                       ed.error_desc,
                                       case when ed.error_desc is null then 0 else sum(a.qty) end qty         
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_insigth_error_t a)a,sfis1.c_data_dictionary_t d,sfis1.c_error_desc_t ed  ,sfis1.c_data_dictionary_t p   
                                 where a.error_code=ed.error_code " + sql1 + strExSql + sql2;

                    sql += @"      and a.group_name = d.data_value
                                   and d.data_type = 'FPY_GROUP_INSIGHT_SMT' ";
                    if (vStation != "")
                        sql += @"      and d.data_code=:groupname ";
                    sql += @"      and p.data_type='RMS_PLANT_CODE' and a.plant_code = p.data_code and a.process='SMT' and p.DATA_VALUE=:plant                                 
                                     group by a.location_code, ed.error_desc) z
                                where z.location_code=x.location_code and z.location_code!='N/A' 
                                group by x.location_code,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
                }
                #endregion
                else
                {
                    #region SMT
                    if (vDuty == "" && vStation == "")
                    {
                        sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where a.serial_number = w.serial_number ";
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"    
                                   and a.plant_code like :sap        
                                   and a.process='SMT'     
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"  
                                   ) y ,
                                 (select w.location_code,
                                        a.test_code,
                                        c.error_desc,
                                        count(0) qty 
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"    
                                   and a.plant_code like :sap        
                                   and a.process='SMT'        
                                  and a.test_code=c.error_code 
                                 group by w.location_code,a.test_code,c.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input 
                                   order by x.qty desc ) where rownum <= :top";
                    }
                    else if (vDuty != "" && vStation == "")
                    {
                        sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where a.serial_number = w.serial_number ";
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"      
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.plant_code like :sap        
                                   and a.process='SMT'  
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"        
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"   
                                   ) y ,
                                (select w.location_code,
                                        a.test_code,
                                        c.error_desc,
                                        count(0) qty 
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"      
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.plant_code like :sap        
                                   and a.process='SMT'    
                                 and a.test_code=c.error_code 
                                 group by w.location_code,a.test_code,c.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input
                                   order by x.qty desc ) where rownum <= :top";
                    }
                    else if (vDuty == "" && vStation != "")
                    {
                        sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where a.serial_number = w.serial_number ";
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"                    
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP_SMT' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='SMT'                     
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @" 
                                   ) y ,
                                (select w.location_code,
                                        a.test_code,
                                        c.error_desc,
                                        count(0) qty 
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"                    
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP_SMT' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='SMT'                   
                                   and a.test_code=c.error_code 
                                 group by w.location_code,a.test_code,c.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input
                                   order by x.qty desc ) where rownum <= :top";
                    }
                    else if (vDuty != "" && vStation != "")
                    {
                        sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d,sfis1.c_data_dictionary_t f 
                                 where a.serial_number = w.serial_number ";
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"     
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.group_name = f.data_code
                                   and f.data_type = 'FPY_GROUP_SMT' 
                                   and f.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='SMT'             
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"      
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"   
                                   ) y ,
                                (select w.location_code,
                                        a.test_code,
                                        c.error_desc,
                                        count(0) qty 
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t f ,sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                        if (strCust != "A76")
                            sql += " and a.FPY_FLAG = 'Y' ";
                        sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"     
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.group_name = f.data_code
                                   and f.data_type = 'FPY_GROUP_SMT' 
                                   and f.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='SMT'                    
                                   and a.test_code=c.error_code 
                                 group by w.location_code,a.test_code,c.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input
                                   order by x.qty desc ) where rownum <= :top";
                    }
                    #endregion
                }
            }
            ht.Clear();
            if ((strProcess == "FATP") || (strMProcess == "SMT" && strPlant == "VNP1"))
                ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("top", iTOP);
            ht.Add("plant", strPlant.Replace("VN76", "VNP1"));
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDuty != "")
            {
                if (vDuty == "複判OK")
                    ht.Add("duty", "NTF");
                else if (vDuty == "組包造成")
                    ht.Add("duty", "AFTP");
                else
                    ht.Add("duty", vDuty.Replace("不良", ""));
            }
            if (vStation != "")
                ht.Add("groupname", vStation);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vType == "MODELLINE")
            {
                string[] bb = vTypeCond.Split(';');
                ht.Add("typecond", bb[0]);
                ht.Add("typecond2", bb[1]);
            }
            else
            {
                if (vTypeCond != "")
                    ht.Add("typecond", vTypeCond);
            }
            if (vLocaCode != "")
                ht.Add("loca", vLocaCode);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetComponentTable(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vTypeCond, string vType, string vDuty, string vStation, int iTOP)
        {
            return GetComponentTable(vPlant, vSapPlant, vDateType, vQCond, vLOB, vTypeCond, vType, vDuty, vStation, iTOP, "");
        }
        public DataTable GetComponentTable(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vTypeCond, string vType, string vDuty, string vStation,
                                    int iTOP, string vLocaCode)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sql3 = "";
            string strPlant = "", strShift = "", strCust = "", strProcess = "FATP", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //    strExSql = " and a.model_serial like :ex1 ";
                if (strExType.IndexOf("_") > -1)
                {
                    vPlant = vPlant + "_" + strExType.Split('_')[1];
                    strExType = strExType.Split('_')[0];
                }
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vPlant.IndexOf("_") > -1)
            {
                strPlant = vPlant.Split('_')[0];
                strProcess = "SMT";
                strMProcess = "SMT";
            }
            else
                strPlant = vPlant;
            strCust = getCust(strPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += " and a.model_serial = :lob ";
            if (vLocaCode != "")
                sql2 += @" and case
                                       when reason_code = 'BIOS REFRESH' then
                                        'BIOS'
                                       when location_code like '%PCB%' or location_code like '%PCBA%' then
                                        'PCB'
                                       when location_code like 'U%' OR location_code like 'PU%' OR
                                            location_code like '%WL1%' OR location_code like '%CPU%' then
                                        'IC/Chip'
                                       when location_code like 'J%' OR location_code like '%PJP%' OR
                                            location_code like '%BATT%' then
                                        'CONN'
                                       when location_code like 'D%' OR location_code like 'PD%' OR
                                            location_code like 'F%' OR location_code like 'PF%' OR
                                            location_code like 'Q%' OR location_code like 'PQ%' then
                                        'Transistor'
                                       when location_code like 'L%' OR location_code like 'PL%' OR
                                            location_code like 'C%' OR location_code like 'PC%' OR
                                            location_code like 'R%' OR location_code like 'PR%' then
                                        'LCR'
                                       else
                                        'Other'
                                     end = :loca ";
            if (vType == "LINE")
            {
                sql1 += " and a.line_name = :typecond ";
                if (vTypeCond.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                else if (vTypeCond.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
            }
            else if (vType == "MODEL")
            {
                if (strProcess == "SMT")
                    sql1 += " and substr(a.model_name,0,5) = :typecond ";
                else
                    sql1 += " and a.model_name = :typecond ";
            }
            else if (vType == "MODELLINE")
            {
                sql1 += " and a.line_name = :typecond2 ";
                string[] bb = vTypeCond.Split(';');
                if (bb[1].IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                else if (bb[1].IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                if (strProcess == "SMT")
                    sql1 += " and substr(a.model_name,0,5) = :typecond ";
                else
                    sql1 += " and a.model_name = :typecond ";
            }
            if (strMProcess == "SMT" && strPlant == "VNP1")
                strExSql += @"     and instr(:cust,a.cust_no ) >0 ";
            string sql = "";
            if (strProcess == "FATP")
            {
                #region FATP
                if (vDuty == "" && vStation == "")
                {
                    sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.plant_code like :sap        
                                   and a.process='FATP'    
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"  
                                   ) y 
                                   order by x.qty desc ) where rownum <= :top";
                }
                else if (vDuty != "" && vStation == "")
                {
                    sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0 
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.plant_code like :sap        
                                   and a.process='FATP'               
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"  
                                   ) y 
                                   order by x.qty desc ) where rownum <= :top";
                }
                else if (vDuty == "" && vStation != "")
                {
                    sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0                                    
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='FATP'        
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"  
                                   ) y 
                                   order by x.qty desc ) where rownum <= :top";
                }
                else if (vDuty != "" && vStation != "")
                {
                    sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select w.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t f
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"                                    
                                   and instr(:cust,a.cust_no ) >0 
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.group_name = f.data_code
                                   and f.data_type = 'FPY_GROUP' 
                                   and f.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='FATP'              
                                 group by w.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and instr(:cust,a.cust_no ) >0 
                                   and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                   ) y 
                                   order by x.qty desc ) where rownum <= :top";
                }
                #endregion
            }
            else
            {
                #region SMT
                if (vDuty == "" && vStation == "")
                {
                    sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select a.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents from 
                                 (select case
                                       when reason_code = 'BIOS REFRESH' then
                                        'BIOS'
                                       when location_code like '%PCB%' or location_code like '%PCBA%' then
                                        'PCB'
                                       when location_code like 'U%' OR location_code like 'PU%' OR
                                            location_code like '%WL1%' OR location_code like '%CPU%' then
                                        'IC/Chip'
                                       when location_code like 'J%' OR location_code like '%PJP%' OR
                                            location_code like '%BATT%' then
                                        'CONN'
                                       when location_code like 'D%' OR location_code like 'PD%' OR
                                            location_code like 'F%' OR location_code like 'PF%' OR
                                            location_code like 'Q%' OR location_code like 'PQ%' then
                                        'Transistor'
                                       when location_code like 'L%' OR location_code like 'PL%' OR
                                            location_code like 'C%' OR location_code like 'PC%' OR
                                            location_code like 'R%' OR location_code like 'PR%' then
                                        'LCR'
                                       else
                                        'Other'
                                     end location_code 
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"    
                                   and a.plant_code like :sap        
                                   and a.process='SMT'    
                                 )a group by a.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"   
                                   ) y ,
                                 (select a.*,count(0) qty from 
                                  (select case
                                       when reason_code = 'BIOS REFRESH' then
                                        'BIOS'
                                       when location_code like '%PCB%' or location_code like '%PCBA%' then
                                        'PCB'
                                       when location_code like 'U%' OR location_code like 'PU%' OR
                                            location_code like '%WL1%' OR location_code like '%CPU%' then
                                        'IC/Chip'
                                       when location_code like 'J%' OR location_code like '%PJP%' OR
                                            location_code like '%BATT%' then
                                        'CONN'
                                       when location_code like 'D%' OR location_code like 'PD%' OR
                                            location_code like 'F%' OR location_code like 'PF%' OR
                                            location_code like 'Q%' OR location_code like 'PQ%' then
                                        'Transistor'
                                       when location_code like 'L%' OR location_code like 'PL%' OR
                                            location_code like 'C%' OR location_code like 'PC%' OR
                                            location_code like 'R%' OR location_code like 'PR%' then
                                        'LCR'
                                       else
                                        'Other'
                                     end location_code,
                                        a.test_code,
                                        c.error_desc 
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"    
                                   and a.plant_code like :sap        
                                   and a.process='SMT'  
                                  and a.test_code=c.error_code ) a
                                 group by a.location_code,a.test_code,a.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input 
                                   order by x.qty desc ) where rownum <= :top";
                }
                else if (vDuty != "" && vStation == "")
                {
                    sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select a.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents from 
                                 (select case
                                       when reason_code = 'BIOS REFRESH' then
                                        'BIOS'
                                       when location_code like '%PCB%' or location_code like '%PCBA%' then
                                        'PCB'
                                       when location_code like 'U%' OR location_code like 'PU%' OR
                                            location_code like '%WL1%' OR location_code like '%CPU%' then
                                        'IC/Chip'
                                       when location_code like 'J%' OR location_code like '%PJP%' OR
                                            location_code like '%BATT%' then
                                        'CONN'
                                       when location_code like 'D%' OR location_code like 'PD%' OR
                                            location_code like 'F%' OR location_code like 'PF%' OR
                                            location_code like 'Q%' OR location_code like 'PQ%' then
                                        'Transistor'
                                       when location_code like 'L%' OR location_code like 'PL%' OR
                                            location_code like 'C%' OR location_code like 'PC%' OR
                                            location_code like 'R%' OR location_code like 'PR%' then
                                        'LCR'
                                       else
                                        'Other'
                                     end location_code 
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"      
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.plant_code like :sap        
                                   and a.process='SMT'    
                                 )a group by a.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"        
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"    
                                   ) y ,
                                (select a.*,count(0) qty from 
                                  (select case
                                       when reason_code = 'BIOS REFRESH' then
                                        'BIOS'
                                       when location_code like '%PCB%' or location_code like '%PCBA%' then
                                        'PCB'
                                       when location_code like 'U%' OR location_code like 'PU%' OR
                                            location_code like '%WL1%' OR location_code like '%CPU%' then
                                        'IC/Chip'
                                       when location_code like 'J%' OR location_code like '%PJP%' OR
                                            location_code like '%BATT%' then
                                        'CONN'
                                       when location_code like 'D%' OR location_code like 'PD%' OR
                                            location_code like 'F%' OR location_code like 'PF%' OR
                                            location_code like 'Q%' OR location_code like 'PQ%' then
                                        'Transistor'
                                       when location_code like 'L%' OR location_code like 'PL%' OR
                                            location_code like 'C%' OR location_code like 'PC%' OR
                                            location_code like 'R%' OR location_code like 'PR%' then
                                        'LCR'
                                       else
                                        'Other'
                                     end location_code,
                                        a.test_code,
                                        c.error_desc 
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d ,sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"      
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.plant_code like :sap        
                                   and a.process='SMT'  
                                 and a.test_code=c.error_code ) a
                                 group by a.location_code,a.test_code,a.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input
                                   order by x.qty desc ) where rownum <= :top";
                }
                else if (vDuty == "" && vStation != "")
                {
                    sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select a.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents from 
                                 (select case
                                       when reason_code = 'BIOS REFRESH' then
                                        'BIOS'
                                       when location_code like '%PCB%' or location_code like '%PCBA%' then
                                        'PCB'
                                       when location_code like 'U%' OR location_code like 'PU%' OR
                                            location_code like '%WL1%' OR location_code like '%CPU%' then
                                        'IC/Chip'
                                       when location_code like 'J%' OR location_code like '%PJP%' OR
                                            location_code like '%BATT%' then
                                        'CONN'
                                       when location_code like 'D%' OR location_code like 'PD%' OR
                                            location_code like 'F%' OR location_code like 'PF%' OR
                                            location_code like 'Q%' OR location_code like 'PQ%' then
                                        'Transistor'
                                       when location_code like 'L%' OR location_code like 'PL%' OR
                                            location_code like 'C%' OR location_code like 'PC%' OR
                                            location_code like 'R%' OR location_code like 'PR%' then
                                        'LCR'
                                       else
                                        'Other'
                                     end location_code 
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"                    
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP_SMT' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='SMT'                 
                                )a group by a.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"         
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"   
                                   ) y ,
                                (select a.*,count(0) qty from 
                                  (select case
                                       when reason_code = 'BIOS REFRESH' then
                                        'BIOS'
                                       when location_code like '%PCB%' or location_code like '%PCBA%' then
                                        'PCB'
                                       when location_code like 'U%' OR location_code like 'PU%' OR
                                            location_code like '%WL1%' OR location_code like '%CPU%' then
                                        'IC/Chip'
                                       when location_code like 'J%' OR location_code like '%PJP%' OR
                                            location_code like '%BATT%' then
                                        'CONN'
                                       when location_code like 'D%' OR location_code like 'PD%' OR
                                            location_code like 'F%' OR location_code like 'PF%' OR
                                            location_code like 'Q%' OR location_code like 'PQ%' then
                                        'Transistor'
                                       when location_code like 'L%' OR location_code like 'PL%' OR
                                            location_code like 'C%' OR location_code like 'PC%' OR
                                            location_code like 'R%' OR location_code like 'PR%' then
                                        'LCR'
                                       else
                                        'Other'
                                     end location_code,
                                        a.test_code,
                                        c.error_desc 
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"                    
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP_SMT' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='SMT'               
                                   and a.test_code=c.error_code ) a
                                 group by a.location_code,a.test_code,a.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input
                                   order by x.qty desc ) where rownum <= :top";
                }
                else if (vDuty != "" && vStation != "")
                {
                    sql = @"select * from (select x.location_code,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR,
                               max(z.error_desc) keep(dense_rank first order by z.qty desc) error_desc
                          from (select a.location_code,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents from 
                                 (select case
                                       when reason_code = 'BIOS REFRESH' then
                                        'BIOS'
                                       when location_code like '%PCB%' or location_code like '%PCBA%' then
                                        'PCB'
                                       when location_code like 'U%' OR location_code like 'PU%' OR
                                            location_code like '%WL1%' OR location_code like '%CPU%' then
                                        'IC/Chip'
                                       when location_code like 'J%' OR location_code like '%PJP%' OR
                                            location_code like '%BATT%' then
                                        'CONN'
                                       when location_code like 'D%' OR location_code like 'PD%' OR
                                            location_code like 'F%' OR location_code like 'PF%' OR
                                            location_code like 'Q%' OR location_code like 'PQ%' then
                                        'Transistor'
                                       when location_code like 'L%' OR location_code like 'PL%' OR
                                            location_code like 'C%' OR location_code like 'PC%' OR
                                            location_code like 'R%' OR location_code like 'PR%' then
                                        'LCR'
                                       else
                                        'Other'
                                     end location_code 
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d ,sfis1.c_data_dictionary_t f 
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"     
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.group_name = f.data_code
                                   and f.data_type = 'FPY_GROUP_SMT' 
                                   and f.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='SMT'              
                                )a group by a.location_code) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"      
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @" 
                                   ) y ,
                                (select a.*,count(0) qty from 
                                  (select case
                                       when reason_code = 'BIOS REFRESH' then
                                        'BIOS'
                                       when location_code like '%PCB%' or location_code like '%PCBA%' then
                                        'PCB'
                                       when location_code like 'U%' OR location_code like 'PU%' OR
                                            location_code like '%WL1%' OR location_code like '%CPU%' then
                                        'IC/Chip'
                                       when location_code like 'J%' OR location_code like '%PJP%' OR
                                            location_code like '%BATT%' then
                                        'CONN'
                                       when location_code like 'D%' OR location_code like 'PD%' OR
                                            location_code like 'F%' OR location_code like 'PF%' OR
                                            location_code like 'Q%' OR location_code like 'PQ%' then
                                        'Transistor'
                                       when location_code like 'L%' OR location_code like 'PL%' OR
                                            location_code like 'C%' OR location_code like 'PC%' OR
                                            location_code like 'R%' OR location_code like 'PR%' then
                                        'LCR'
                                       else
                                        'Other'
                                     end location_code,
                                        a.test_code,
                                        c.error_desc 
                                  from sfism4.r_repair_info_t w, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where substr(a.model_name,0,5) = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d, sfis1.c_data_dictionary_t f ,sfis1.c_error_desc_t c  
                                 where a.serial_number = w.serial_number ";
                    if (strCust != "A76")
                        sql += " and a.FPY_FLAG = 'Y' ";
                    sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + sql3 + @"     
                                   and w.duty_type = d.data_code
                                   and d.data_type = 'DUTY_TYPE'                                    
                                   and d.data_value=:duty
                                   and a.group_name = f.data_code
                                   and f.data_type = 'FPY_GROUP_SMT' 
                                   and f.data_value=:groupname
                                   and a.plant_code like :sap        
                                   and a.process='SMT'            
                                   and a.test_code=c.error_code ) a
                                 group by a.location_code,a.test_code,a.error_desc) z
                                 where z.location_code=x.location_code
                                 group by  x.location_code,x.qty,x.percents, y.input
                                   order by x.qty desc ) where rownum <= :top";
                }
                #endregion
            }
            ht.Clear();
            if ((strProcess == "FATP") || (strMProcess == "SMT" && strPlant == "VNP1"))
                ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("top", iTOP);
            ht.Add("plant", strPlant.Replace("VN76", "VNP1"));
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDuty != "")
            {
                if (vDuty == "複判OK")
                    ht.Add("duty", "NTF");
                else if (vDuty == "組包造成")
                    ht.Add("duty", "AFTP");
                else
                    ht.Add("duty", vDuty.Replace("不良", ""));
            }
            if (vStation != "")
                ht.Add("groupname", vStation);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vType == "MODELLINE")
            {
                string[] bb = vTypeCond.Split(';');
                ht.Add("typecond", bb[0]);
                ht.Add("typecond2", bb[1]);
            }
            else
            {
                if (vTypeCond != "")
                    ht.Add("typecond", vTypeCond);
            }
            if (vLocaCode != "")
                ht.Add("loca", vLocaCode);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetHeadTable(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vTypeCond, string vType, string vStation, int iTOP)
        {
            return GetHeadTable(vPlant, vSapPlant, vDateType, vQCond, vLOB, vTypeCond, vType, vStation, iTOP, "", "", "");
        }
        public DataTable GetHeadTable(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vTypeCond, string vType, string vStation,
                            int iTOP, string vTestCode, string vLocaCode, string vHead)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1, sql2 = "";
            string strPlant = "", strShift = "", strCust = "", strProcess = "SMT", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //  strExSql = " and a.model_serial like :ex1 ";
                if (strExType.IndexOf("_") > -1)
                {
                    vPlant = vPlant + "_" + strExType.Split('_')[1];
                    strExType = strExType.Split('_')[0];
                }
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vPlant.IndexOf("_") > -1)
            {
                strPlant = vPlant.Split('_')[0];
                strProcess = "SMT";
            }
            else
                strPlant = vPlant;
            strCust = getCust(strPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += " and a.model_serial = :lob ";
            if (vTestCode != "")
                sql2 += " and a.test_code = :test ";
            if (vHead != "")
                sql2 += " and w.head_no = :head ";
            if (vType == "LINE")
            {
                if (vTypeCond.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                sql1 += " and a.line_name = :typecond ";
            }
            else if (vType == "MODEL")
            {
                if (strProcess == "SMT")
                    sql1 += " and substr(a.model_name,0,5) = :typecond ";
                else
                    sql1 += " and a.model_name = :typecond ";
            }
            else if (vType == "MODELLINE")
            {
                sql1 += " and a.line_name = :typecond2 ";
                string[] bb = vTypeCond.Split(';');
                if (bb[1].IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                else if (bb[1].IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                if (strProcess == "SMT")
                    sql1 += " and substr(a.model_name,0,5) = :typecond ";
                else
                    sql1 += " and a.model_name = :typecond ";
            }
            if (strMProcess == "SMT" && strPlant == "VNP1")
                strExSql += @"     and instr(:cust,a.cust_no ) >0 ";
            string sql = "";
            sql = @"select head_no as hs,qty,percents,fr 
                              from (select x.head_no ,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select w.head_no,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where d.model_name=substr(a.model_name,0,5) and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where a.serial_number = w.serial_number ";
            if (strCust != "A76")
                sql += " and a.FPY_FLAG = 'Y' ";
            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"     
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP_SMT' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap           
                                   and a.process='SMT' and w.head_no is not null             
                                 group by w.head_no) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"        
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"   
                                   ) y 
                                group by x.head_no,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";
            ht.Clear();
            if ((strProcess == "FATP") || (strMProcess == "SMT" && strPlant == "VNP1"))
                ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("top", iTOP);
            ht.Add("plant", strPlant.Replace("VN76", "VNP1"));
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vStation != "")
                ht.Add("groupname", vStation);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vType == "MODELLINE")
            {
                string[] bb = vTypeCond.Split(';');
                ht.Add("typecond", bb[0]);
                ht.Add("typecond2", bb[1]);
            }
            else
            {
                if (vTypeCond != "")
                    ht.Add("typecond", vTypeCond);
            }
            if (vTestCode != "")
                ht.Add("test", vTestCode);
            if (vHead != "")
                ht.Add("head", vHead);
            if (vLocaCode != "")
                ht.Add("loca", vLocaCode);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetSlotTable(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vTypeCond, string vType, string vStation, int iTOP)
        {
            return GetSlotTable(vPlant, vSapPlant, vDateType, vQCond, vLOB, vTypeCond, vType, vStation, iTOP, "", "", "");
        }
        public DataTable GetSlotTable(string vPlant, string vSapPlant, string vDateType, string vQCond, string vLOB, string vTypeCond, string vType, string vStation,
                                    int iTOP, string vTestCode, string vLocaCode, string vSlot)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1, sql2 = "";
            string strPlant = "", strShift = "", strCust = "", strProcess = "SMT", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType.IndexOf("_") > -1)
                {
                    vPlant = vPlant + "_" + strExType.Split('_')[1];
                    strExType = strExType.Split('_')[0];
                }
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            if (vPlant.IndexOf("_") > -1)
            {
                strPlant = vPlant.Split('_')[0];
                strProcess = "SMT";
            }
            else
                strPlant = vPlant;
            strCust = getCust(strPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vLOB != "")
                sql1 += " and a.model_serial = :lob ";
            if (vTestCode != "")
                sql2 += " and a.test_code = :test ";
            if (vSlot != "")
                sql2 += " and w.slot = :slot ";
            if (vType == "LINE")
            {
                if (vTypeCond.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                sql1 += " and a.line_name = :typecond ";
            }
            else if (vType == "MODEL")
            {
                if (strProcess == "SMT")
                    sql1 += " and substr(a.model_name,0,5) = :typecond ";
                else
                    sql1 += " and a.model_name = :typecond ";
            }
            else if (vType == "MODELLINE")
            {
                sql1 += " and a.line_name = :typecond2 ";
                string[] bb = vTypeCond.Split(';');
                if (bb[1].IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                else if (bb[1].IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                if (strProcess == "SMT")
                    sql1 += " and substr(a.model_name,0,5) = :typecond ";
                else
                    sql1 += " and a.model_name = :typecond ";
            }
            if (strMProcess == "SMT" && strPlant == "VNP1")
                strExSql += @"     and instr(:cust,a.cust_no ) >0 ";
            string sql = "";
            sql = @"select slot as hs,qty,percents,fr 
                              from (select x.slot ,
                               x.qty,
                               x.percents,
                               case when (y.input>0) then
                               round(x.qty / y.input, 4) * 100 
                               else 
                               0 
                               end as FR
                          from (select w.slot,
                                       count(0) qty,
                                       round(ratio_to_report(count(0)) over(), 4) * 100 percents
                                  from sfism4.r_repair_info_t w,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where d.model_name=substr(a.model_name,0,5) and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_data_dictionary_t d 
                                 where a.serial_number = w.serial_number ";
            if (strCust != "A76")
                sql += " and a.FPY_FLAG = 'Y' ";
            sql += @"      and a.item_no = w.item_no " + sql1 + strExSql + sql2 + @"    
                                   and a.group_name = d.data_code
                                   and d.data_type = 'FPY_GROUP_SMT' 
                                   and d.data_value=:groupname
                                   and a.plant_code like :sap           
                                   and a.process='SMT' and w.slot is not null      
                                 group by w.slot) x,
                               (select nvl(sum(a.output_qty),0) input
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code = 'PCBG'
                                   and a.plant_code like :sap " + sql1 + strExSql + @"       
                                   and a.process = 'SMT' " + getSubProcess(strMProcess, strCust) + @"   
                                   ) y 
                                group by x.slot,x.qty,x.percents,y.input  
                                order by x.qty desc ) where rownum <= :top";

            ht.Clear();
            if ((strProcess == "FATP") || (strMProcess == "SMT" && strPlant == "VNP1"))
                ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("top", iTOP);
            ht.Add("plant", strPlant);
            if (vLOB != "")
                ht.Add("lob", vLOB);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vStation != "")
                ht.Add("groupname", vStation);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            if (vType == "MODELLINE")
            {
                string[] bb = vTypeCond.Split(';');
                ht.Add("typecond", bb[0]);
                ht.Add("typecond2", bb[1]);
            }
            else
            {
                if (vTypeCond != "")
                    ht.Add("typecond", vTypeCond);
            }
            if (vTestCode != "")
                ht.Add("test", vTestCode);
            if (vSlot != "")
                ht.Add("slot", vSlot);
            if (vLocaCode != "")
                ht.Add("loca", vLocaCode);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetPidIndexData(string vPlant, string vSapPlant, string vDateType, string vQCond, string vMType, bool vIsMP = true)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sqlInput = "";
            string strPlant = "", strShift = "", strCust = "";
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strPlant = vPlant;
            strCust = getCust(strPlant);
            if (vDateType == "Daily")
            {
                sql1 = " and a.work_date = :qcond ";
                sqlInput = " and a.work_date = :qinputcond ";

            }
            else if (vDateType == "Weekly")
            {
                sql1 = " and a.week_code = :qcond ";
                sqlInput = " and a.work_date between :qinputcond and :qinputcond2 ";
            }
            else if (vDateType == "Range")
            {
                sql1 = " and a.work_date between :qcond1 and :qcond2 ";
                sqlInput = " and a.work_date between :qinputcond and :qinputcond2 ";
            }
            else
            {
                sql1 = " and a.work_date like :qcond ";
                sqlInput = " and a.work_date like :qinputcond  ";
            }
            if (strShift != "ALL")
            {
                sqlInput += " and a.shift_period = :shift ";
                sql1 += " and a.shift_period = :shift ";
            }
            if (vIsMP)
                sql1 += " and a.material_source='MP' ";
            else
                sql1 += @" and a.material_source='非MP' ";
            if (vMType != "TOTAL")
                sql1 += @" and a.error_type= :mtype ";
            string sql = "";
            sql = @" select * from (select a.catalogy, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm,a.qty,b.input from 
                    (  
                     select * from (
                     select nvl(b.data_value,'N/A') as catalogy,sum(a.qty) as qty from sfism4.r_kpi_pid_t a 
                     inner join sfis1.c_data_dictionary_t b
                     on a.material_type=b.data_code and b.data_type='PID_MATERIAL_TYPE' and b.data_value in ('ME Parts','Key Parts') and a.bu_code='PCBG' 
                     where a.plant_code like :sap " + sql1 + @"                     
                     group by b.data_value
                     union 
                     select nvl(b.data_value,'N/A') as catalogy,sum(a.qty) as qty from sfism4.r_kpi_pid_t a 
                     inner join sfis1.c_data_dictionary_t b
                     on a.material_type=b.data_code
                     where b.data_type='PID_MATERIAL_TYPE' and b.data_value in ('LCD') and a.bu_code='PCBG' 
                     and a.plant_code like :sap " + sql1 + @"                     
                     group by b.data_value
                     ))a,    
                    (
                    select 'ALL' as catalogy,NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b   
                    where a.plant_code like :sap and a.bu_code=b.bu_code 
                            and a.bu_code = 'PCBG' and a.bu_code= b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"                             
                    ) b
                    )
                    order by decode( catalogy,'ME Parts',1,'Key Parts',2,'LCD',3,'N/A',4)";
            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (vMType != "TOTAL")
                ht.Add("mtype", vMType);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                ht.Add("qinputcond", vQCond);
                ht.Add("qcond", vQCond);
            }
            else if (vDateType == "Weekly")
            {
                ht.Add("qcond", vQCond.Replace("W", ""));
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qinputcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qinputcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond1", cc[0]);
                    ht.Add("qcond2", cc[1]);
                    ht.Add("qinputcond", cc[0]);
                    ht.Add("qinputcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond1", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                    ht.Add("qinputcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qinputcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
            {
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
                ht.Add("qinputcond", vQCond.Replace("M", "") + "%");
            }

            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetPidCrossData(string vSapPlant, string vDateType, string vQCond, string vMType, string vPType, string vSubType, string vSubValue, bool vIsMP = true)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sqlInput = "";
            string strShift = "";
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            sqlInput = " and a.work_date between :qinputcond and :qinputcond2 ";
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.week_code = :qcond ";
            else if (vDateType == "Range")
                sql1 = " and a.work_date between :qcond1 and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vIsMP)
                sql1 += " and a.material_source='MP' ";
            else
                sql1 += @" and a.material_source='非MP' ";
            if (vMType != "TOTAL")
                sql1 += @" and a.error_type= :mtype ";
            string sql = "";
            if (vSubType == "")
                #region
                sql = @"
                   select a.plant_code , 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                     (select c.rms_plant as plant_code,nvl(sum(a.qty),0) as qty from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c     
                     where a.material_type=b.data_code and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype and a.bu_code=c.bu_code  
                             and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"
                             group by c.rms_plant 
                     )a,
                     (select b.rms_plant, NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b     
                    where a.bu_code = 'PCBG' and a.plant_code = b.sap_plant and a.bu_code=b.bu_code
                         and instr((select c.data_value 
                            from sfis1.c_data_dictionary_t c 
                            where c.data_code=b.rms_plant and c.data_type='PLANT_CUST' and c.data_desc=a.bu_code), a.cust_no ) > 0 
                            and a.process = 'FATP'  " + sqlInput + @"
                            and a.sub_process in ('ASSY', 'CELL', 'REPAIR', 'TNB', 'DOCK')                                    
                    group by b.rms_plant
                    )b
                    where a.plant_code=b.rms_plant
                    order by a.plant_code ";
            #endregion
            else if (vSubType == "AREA")
                #region 
                sql = @"select a.plant_code , 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                     (select d.display_line as plant_code,nvl(sum(a.qty),0) as qty from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d         
                     where a.material_type=b.data_code and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                             and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @" and d.site_id=c.site_id and a.line_name = d.mes_line 
                             and c.sap_plant=:sapplant and a.bu_code=c.bu_code 
                     group by d.display_line
                     )a,
                     (select d.display_line as plant_code, NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b,sfis1.c_line_def_t d        
                    where a.bu_code = 'PCBG' and a.plant_code = b.sap_plant
                         and b.sap_plant=:sapplant and a.bu_code=b.bu_code 
                         and instr((select c.data_value 
                            from sfis1.c_data_dictionary_t c 
                            where c.data_code=b.rms_plant and c.data_type='PLANT_CUST' and c.data_desc=a.bu_code), a.cust_no ) > 0 
                            and a.process = 'FATP'  " + sqlInput + @"
                            and a.sub_process in ('ASSY', 'CELL', 'REPAIR', 'TNB', 'DOCK')     
                            and d.site_id=b.site_id and a.line_name = d.mes_line                                                            
                   group by d.display_line
                    )b 
                    where a.plant_code=b.plant_code 
                    order by a.plant_code  ";
            #endregion
            else if (vSubType == "LINE")
                #region
                sql = @"select a.plant_code , 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                     (select d.mes_line as plant_code,nvl(sum(a.qty),0) as qty from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d         
                     where a.material_type=b.data_code and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  and a.bu_code=c.bu_code 
                             and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @" and d.site_id=c.site_id and a.line_name = d.mes_line 
                             and c.sap_plant=:sapplant and d.sub_process=:sub 
                             group by d.mes_line
                     )a,
                     (select a.line_name as plant_code, NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b     
                    where a.bu_code = 'PCBG' and a.plant_code = b.sap_plant
                         and b.sap_plant=:sapplant and a.bu_code=b.bu_code  
                         and instr((select c.data_value 
                            from sfis1.c_data_dictionary_t c 
                            where c.data_code=b.rms_plant and c.data_type='PLANT_CUST' and c.data_desc=a.bu_code), a.cust_no ) > 0 
                            and a.process = 'FATP'  " + sqlInput + @"                                 
                    group by a.line_name
                    )b 
                    where a.plant_code=b.plant_code
                    order by a.plant_code ";
            #endregion
            else if (vSubType == "MODEL")
                #region
                sql = @"select a.plant_code , 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                     (select a.model_name as plant_code,nvl(sum(a.qty),0) as qty 
                      from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code 
                                          ),a.model_name) as model_serial from sfism4.r_kpi_pid_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                            ,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c  
                     where a.material_type=b.data_code and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                             and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @" 
                             and c.sap_plant=:sapplant and a.bu_code=c.bu_code  
                             group by a.model_name
                     )a,
                     (select a.model_name as plant_code, NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b     
                    where a.bu_code = 'PCBG' and a.plant_code = b.sap_plant
                         and b.sap_plant=:sapplant and a.bu_code=b.bu_code 
                         and instr((select c.data_value 
                            from sfis1.c_data_dictionary_t c 
                            where c.data_code=b.rms_plant and c.data_type='PLANT_CUST' and c.data_desc=a.bu_code), a.cust_no ) > 0 
                            and a.process = 'FATP'  " + sqlInput + @"
                            and a.sub_process in ('ASSY', 'CELL', 'REPAIR', 'TNB', 'DOCK')                                    
                    group by a.model_name 
                    )b 
                    where a.plant_code=b.plant_code
                    order by a.plant_code ";
            #endregion
            else if (vSubType == "LOB")
                #region
                sql = @"select a.plant_code , 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                     (select a.model_serial as plant_code,nvl(sum(a.qty),0) as qty
                       from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code 
                                          ),a.model_name) as model_serial from sfism4.r_kpi_pid_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                            ,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c      
                     where a.material_type=b.data_code and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                             and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @" 
                             and c.sap_plant=:sapplant and a.bu_code=c.bu_code  
                             group by a.model_serial
                     )a,
                     (select a.model_serial as plant_code, NVL(sum(a.output_qty), 0) as input
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a ,sfis1.c_plant_def_t b       
                    where a.bu_code = 'PCBG' and a.plant_code = b.sap_plant
                         and b.sap_plant=:sapplant and a.bu_code=b.bu_code 
                         and instr((select c.data_value 
                            from sfis1.c_data_dictionary_t c 
                            where c.data_code=b.rms_plant and c.data_type='PLANT_CUST' and c.data_desc=a.bu_code), a.cust_no ) > 0 
                            and a.process = 'FATP'  " + sqlInput + @"
                            and a.sub_process in ('ASSY', 'CELL', 'REPAIR', 'TNB', 'DOCK')                      
                    group by a.model_serial
                    )b 
                    where a.plant_code=b.plant_code 
                    order by a.plant_code  ";
            #endregion
            else if (vSubType == "PARTS")
                #region
                sql = @"select a.plant_code , 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                     (select a.material_type as plant_code,nvl(sum(a.qty),0) as qty from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c          
                     where a.material_type=b.data_code and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                             and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @" 
                             and c.sap_plant=:sapplant and a.bu_code=c.bu_code 
                             group by a.material_type
                     )a,
                     (select b.rms_plant, NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b     
                    where a.bu_code = 'PCBG' and a.plant_code = b.sap_plant
                         and b.sap_plant=:sapplant and a.bu_code=b.bu_code 
                         and instr((select c.data_value 
                            from sfis1.c_data_dictionary_t c 
                            where c.data_code=b.rms_plant and c.data_type='PLANT_CUST' and c.data_desc=a.bu_code), a.cust_no ) > 0 
                            and a.process = 'FATP'  " + sqlInput + @"
                            and a.sub_process in ('ASSY', 'CELL', 'REPAIR', 'TNB', 'DOCK')                                    
                    group by b.rms_plant
                    )b 
                    order by a.plant_code ";
            #endregion
            else if (vSubType == "LOBLINE")
                #region
                sql = @"select a.plant_code , 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                     (select d.mes_line as plant_code,nvl(sum(a.qty),0) as qty 
                     from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code 
                                          ),a.model_name) as model_serial from sfism4.r_kpi_pid_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                          ,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d             
                     where a.material_type=b.data_code and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  and a.bu_code=c.bu_code 
                             and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @" and d.site_id=c.site_id and a.line_name = d.mes_line 
                             and c.sap_plant like :sapplant and a.model_serial=:sub and d.sub_process=:sub2 
                             group by d.mes_line
                     )a,
                     (select a.line_name as plant_code, NVL(sum(a.output_qty), 0) as input
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                            ,sfis1.c_plant_def_t b           
                    where a.bu_code = 'PCBG' and a.plant_code = b.sap_plant
                         and b.sap_plant like :sapplant and a.bu_code=b.bu_code 
                         and instr((select c.data_value 
                            from sfis1.c_data_dictionary_t c 
                            where c.data_code=b.rms_plant and c.data_type='PLANT_CUST' and c.data_desc=a.bu_code), a.cust_no ) > 0 
                            and a.process = 'FATP'  " + sqlInput + @" and a.model_serial=:sub                     
                    group by a.line_name
                    )b 
                    where a.plant_code=b.plant_code
                    order by a.plant_code ";
            #endregion
            ht.Clear();
            if (vSubType != "")
            {
                if (vSapPlant.IndexOf("CQ") > -1)
                    ht.Add("sapplant", "CQ%");
                else if (vSapPlant.IndexOf("CD") > -1)
                    ht.Add("sap", "CD%");
                else
                    ht.Add("sapplant", vSapPlant);
            }
            if (vSubType == "LINE")
                ht.Add("sub", vSubValue.Split('_')[0]);
            else if (vSubType == "LOBLINE")
            {
                ht.Add("sub", vSubValue.Split('_')[0]);
                ht.Add("sub2", vSubValue.Split('_')[1]);
            }
            ht.Add("ptype", vPType);
            if (vMType != "TOTAL")
                ht.Add("mtype", vMType);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                ht.Add("qcond", vQCond);
                ht.Add("qinputcond", vQCond);
                ht.Add("qinputcond2", vQCond);
            }
            else if (vDateType == "Weekly")
            {
                ht.Add("qcond", vQCond.Replace("W", ""));
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qinputcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qinputcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond1", cc[0]);
                    ht.Add("qcond2", cc[1]);
                    ht.Add("qinputcond", cc[0]);
                    ht.Add("qinputcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond1", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                    ht.Add("qinputcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qinputcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
            {
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
                ht.Add("qinputcond", vQCond.Replace("M", "") + "01");
                ht.Add("qinputcond2", vQCond.Replace("M", "") + "31");
            }

            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetPidTrenChartData(string vPlant, string vSapPlant, string vDateType, string vQCond, string vMType, string vPType, string vSubType, string vSubValue, bool vIsMP = true)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sqlInput = "";
            string strShift = "", strCust = "";
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            sqlInput = " and a.work_date between :qinputcond and :qinputcond2 ";

            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.week_code = :qcond ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
            {
                sqlInput += " and a.shift_period = :shift ";
                sql1 += " and a.shift_period = :shift ";
            }
            if (vIsMP)
                sql1 += " and a.material_source='MP' ";
            else
                sql1 += @" and a.material_source='非MP' ";
            if (vMType != "TOTAL")
                sql1 += @" and a.error_type= :mtype ";
            string sql = "";
            if (vSubType == "")
                #region DEFAULT
                sql = @"select a.plant_code,a.qty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm,b.input from 
                    (     
                    select c.rms_plant as plant_code,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c     
                    where a.plant_code like :sap and a.material_type=b.data_code 
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype and a.bu_code=c.bu_code   
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"                     
                    group by c.rms_plant    
                    )a,    
                    (
                    select b.rms_plant,NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b     
                    where a.plant_code like :sap and a.bu_code=b.bu_code 
                            and a.bu_code = 'PCBG'
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"                                     
                    group by b.rms_plant
                    ) b
                    where a.plant_code=b.rms_plant";
            #endregion
            else if (vSubType == "AREA")
                #region AREA 
                sql = @"select a.plant_code,a.qty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select d.display_line as plant_code,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d            
                    where a.plant_code like :sap and a.material_type=b.data_code 
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype and a.bu_code=c.bu_code   
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @" and d.site_id=c.site_id and a.line_name = d.mes_line  
                            and d.display_line = :subvalue                           
                            group by d.display_line  
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b,sfis1.c_line_def_t d    
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"    
                            and a.line_name = d.mes_line and b.site_id=d.site_id and d.display_line = :subvalue        
                    ) b ";
            #endregion
            else if (vSubType == "LINE")
                #region LINE
                sql = @"select a.plant_code,a.qty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select d.mes_line as plant_code,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d            
                    where a.plant_code like :sap and a.material_type=b.data_code 
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype and a.bu_code=c.bu_code   
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @" and d.site_id=c.site_id and a.line_name = d.mes_line  
                            and d.mes_line  = :subvalue                           
                            group by d.mes_line   
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b,sfis1.c_line_def_t d        
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"             
                            and a.line_name = d.mes_line and b.site_id=d.site_id and d.mes_line  = :subvalue    
                    ) b ";
            #endregion
            else if (vSubType == "MODEL")
                #region MODEL
                sql = @"select a.plant_code,a.qty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select d.model_name as plant_code,nvl(sum(a.qty),0) as qty 
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code 
                                          ),a.model_name) as model_serial from sfism4.r_kpi_pid_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                         ,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c  
                    where a.plant_code like :sap and a.material_type=b.data_code and c.bu_code=b.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"                       
                            and a.model_name = :subvalue                           
                            group by d.model_name
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                         ,sfis1.c_plant_def_t b 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"               
                            and a.model_name = :subvalue                           
                    ) b ";
            #endregion
            else if (vSubType == "LOB")
                #region LOB
                sql = @"select a.plant_code,a.qty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select a.model_serial as plant_code,nvl(sum(a.qty),0) as qty 
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code 
                                          ),a.model_name) as model_serial from sfism4.r_kpi_pid_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                        ,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c 
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"                        
                            and a.model_serial  = :subvalue                           
                            group by a.model_serial
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                        ,sfis1.c_plant_def_t b    
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"                     
                            and a.model_serial  = :subvalue                                                          
                    group by b.rms_plant
                    ) b ";
            #endregion
            else if (vSubType == "PARTS")
                #region PARTS
                sql = @"select a.plant_code,a.qty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select a.material_type as plant_code,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c       
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @" 
                            and a.material_type = :subvalue                           
                            group by a.material_type 
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b     
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"       
                    ) b ";
            #endregion
            ht.Clear();
            if (vSubType != "")
                ht.Add("subvalue", vSubValue);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            ht.Add("ptype", vPType);
            if (vMType != "TOTAL")
                ht.Add("mtype", vMType);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                ht.Add("qcond", vQCond);
                ht.Add("qinputcond", vQCond);
                ht.Add("qinputcond2", vQCond);
            }
            else if (vDateType == "Weekly")
            {
                ht.Add("qcond", vQCond.Replace("W", ""));
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qinputcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qinputcond2", eTime.ToString("yyyyMMdd"));
            }
            else
            {
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
                ht.Add("qinputcond", vQCond.Replace("M", "") + "01");
                ht.Add("qinputcond2", vQCond.Replace("M", "") + "31");
            }
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetPidDPPMChartData(string vPlant, string vSapPlant, string vDateType, string vQCond, string vMType, string vPType, string vSubType, string vSubValue, bool vIsMP = true)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();

            DataTable dtResult = new DataTable();
            string sql1 = "", sqlInput = "";
            string strShift = "", strCust = "";
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);

            if (vDateType == "Daily")
            {
                sql1 = " and a.work_date = :qcond ";
                sqlInput = " and a.work_date = :qinputcond ";

            }
            else if (vDateType == "Weekly")
            {
                sql1 = " and a.week_code = :qcond ";
                sqlInput = " and a.work_date between :qinputcond and :qinputcond2 ";
            }
            else if (vDateType == "Range")
            {
                sql1 = " and a.work_date between :qcond1 and :qcond2 ";
                sqlInput = " and a.work_date between :qinputcond and :qinputcond2 ";
            }
            else
            {
                sql1 = " and a.work_date like :qcond ";
                sqlInput = " and a.work_date like :qinputcond  ";
            }
            if (strShift != "ALL")
            {
                sqlInput += " and a.shift_period = :shift ";
                sql1 += " and a.shift_period = :shift ";
            }
            if (vIsMP)
                sql1 += " and a.material_source='MP' ";
            else
                sql1 += @" and a.material_source='非MP' ";
            if (vMType != "TOTAL")
                sql1 += @" and a.error_type= :mtype ";
            if (vSubType == "LINE")
            {
                if (vSubValue != "")
                {
                    sql1 += " and d.sub_process = :sub ";
                }
            }
            string sql = "";
            if (vSubType == "")
                sql = @"select * from (
                        select a.catalogy,a.qty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select 'ALL' as catalogy,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d        
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"      
                            and a.line_name = d.mes_line      
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b   
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"    
                    ) b 
                    order by qty desc 
                    ) where rownum<10";
            else if (vSubType == "AREA")
                sql = @"select * from (
                        select a.catalogy,a.qty as PartQty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select d.display_line as catalogy,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d        
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"      
                            and a.line_name = d.mes_line         
                    group by d.display_line  
                    )a,    
                    (
                    select d.display_line as catalogy,NVL(sum(a.output_qty), 0) as input from
                    (select a.*  
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b    
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"    
                    ) a,sfis1.c_line_def_t d   
                     where a.line_name = d.mes_line            
                    group by d.display_line      
                    ) b 
                    where a.catalogy = b.catalogy
                    order by qty desc 
                    ) where rownum<10";
            else if (vSubType == "LINE")
                sql = @"select * from (
                        select a.catalogy,a.qty as PartQty,
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select a.line_name as catalogy,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d        
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"      
                            and a.line_name = d.mes_line         
                    group by a.line_name 
                    )a,    
                    (
                    select a.line_name as catalogy,NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b    
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' 
                    group by a.line_name 
                    ) b 
                    where a.catalogy = b.catalogy 
                    order by qty desc 
                    ) where rownum<10";
            else if (vSubType == "MODEL")
                sql = @"select * from (
                        select a.catalogy,a.qty as PartQty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select a.Model_Name as catalogy,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c 
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"  
                    group by a.Model_Name  
                    )a,    
                    (
                    select a.model_name as catalogy,
                           NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b    
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"    
                    group by  a.Model_Name 
                    ) b 
                    where a.catalogy = b.catalogy
                    order by qty desc 
                    ) where rownum<10";
            else if (vSubType == "REPAIR")
                sql = @"select * from (
                        select a.catalogy,a.qty as PartQty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select a.repair_desc as catalogy,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c 
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"  
                    group by a.repair_desc  
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b    
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"         
                    ) b                    
                    order by qty desc 
                    ) where rownum<10";
            else if (vSubType == "LOB")
                sql = @"select * from (
                        select a.catalogy,a.qty as PartQty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select a.model_serial as catalogy,nvl(sum(a.qty),0) as qty 
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code 
                                          ),a.model_name) as model_serial from sfism4.r_kpi_pid_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                         ,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c 
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"   
                    group by a.model_serial 
                    )a,    
                    (
                    select a.model_serial as catalogy,NVL(sum(a.output_qty), 0) as input
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                          ,sfis1.c_plant_def_t b 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"     
                    group by a.model_serial 
                    ) b 
                    where a.catalogy = b.catalogy
                    order by qty desc 
                    ) where rownum<10";
            else if (vSubType == "PARTS")
                sql = @"select * from (
                        select a.catalogy,a.qty as PartQty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select a.material_type as catalogy,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c 
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"  
                    group by a.material_type  
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b    
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"        
                    ) b                    
                    order by qty desc 
                    ) where rownum<10";
            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (vSubType == "LINE")
            {
                if (vSubValue != "")
                {
                    ht.Add("sub", vSubValue);
                }
            }
            ht.Add("cust", strCust);
            ht.Add("ptype", vPType);
            if (vMType != "TOTAL")
                ht.Add("mtype", vMType);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                ht.Add("qinputcond", vQCond);
                ht.Add("qcond", vQCond);
            }
            else if (vDateType == "Weekly")
            {
                ht.Add("qcond", vQCond.Replace("W", ""));
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qinputcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qinputcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond1", cc[0]);
                    ht.Add("qcond2", cc[1]);
                    ht.Add("qinputcond", cc[0]);
                    ht.Add("qinputcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond1", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                    ht.Add("qinputcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qinputcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
            {
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
                ht.Add("qinputcond", vQCond.Replace("M", "") + "%");
            }

            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetPidDPPMChartData(string vPlant, string vSapPlant, string vDateType, string vQCond, string vMType, string vPType, string vSubType, string vSubValue, string vPhotoType, string vErrorValue = "", bool vIsMP = true)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sqlInput = "";
            string strShift = "", strCust = "", strMProcess = "FATP";
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);

            if (vDateType == "Daily")
            {
                sql1 = " and a.work_date = :qcond ";
                sqlInput = " and a.work_date = :qinputcond ";

            }
            else if (vDateType == "Weekly")
            {
                sql1 = " and a.week_code = :qcond ";
                sqlInput = " and a.work_date between :qinputcond and :qinputcond2 ";
            }
            else if (vDateType == "Range")
            {
                sql1 = " and a.work_date between :qcond and :qcond2 ";
                sqlInput = " and a.work_date between :qinputcond and :qinputcond2 ";
            }
            else
            {
                sql1 = " and a.work_date like :qcond ";
                sqlInput = " and a.work_date like :qinputcond  ";
            }
            if (strShift != "ALL")
            {
                sqlInput += " and a.shift_period = :shift ";
                sql1 += " and a.shift_period = :shift ";
            }
            if (vIsMP)
                sql1 += " and a.material_source='MP' ";
            else
                sql1 += @" and a.material_source='非MP' ";
            if (vMType != "TOTAL")
                sql1 += @" and a.error_type= :mtype ";
            if (vSubType == "LINE")
            {
                if (vSubValue.IndexOf("PACK") > -1)
                    strMProcess = "PACK";
                if (vSubValue.IndexOf("PCB") > -1)
                    strMProcess = "PCB";
                sql1 += " and a.line_name = :subvalue ";
                sqlInput += " and a.line_name = :subvalue ";
            }
            else if (vSubType == "AREA")
            {
                sql1 += " and d.display_line = :subvalue ";
                sqlInput += " and d.display_line = :subvalue ";
            }
            else if (vSubType == "MODEL")
            {
                sql1 += " and a.model_name = :subvalue ";
                sqlInput += " and a.model_name = :subvalue ";
            }
            else if (vSubType == "PARTS")
                sql1 += " and a.material_type = :subvalue ";
            else if (vSubType == "LOB")
            {
                sql1 += " and a.model_serial = :subvalue ";
                sqlInput += " and a.model_serial = :subvalue ";
            }
            if (vErrorValue != "")
                sql1 += " and a.repair_desc = :errorvalue ";
            string sql = "";
            if (vPhotoType == "")
                #region default
                sql = @"select * from (
                        select a.catalogy,a.qty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select 'ALL' as catalogy,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d        
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"      
                            and a.line_name = d.mes_line      
                    )a,    
                    (
                    select 'ALL' as catalogy,NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b    
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                    ) b
                    order by qty desc 
                    ) where rownum<10";
            #endregion
            else if (vPhotoType == "AREA")
                #region AREA
                sql = @"select * from (
                        select a.catalogy,a.qty as PartQty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select d.display_line as catalogy,nvl(sum(a.qty),0) as qty,round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d        
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"      
                            and a.line_name = d.mes_line         
                    group by d.display_line  
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b  
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                    ) b
                    order by percents desc 
                    ) where rownum<10";
            #endregion
            else if (vPhotoType == "LINE")
                #region LINE
                sql = @"select * from (
                        select a.catalogy,a.qty as PartQty,
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select a.line_name as catalogy,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d        
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"      
                            and a.line_name = d.mes_line         
                    group by a.line_name 
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP'    
                    ) b 
                    order by qty desc 
                    ) where rownum<10";
            #endregion
            else if (vPhotoType == "MODEL")
                #region MODEL
                sql = @"select * from (
                        select a.catalogy,a.qty as PartQty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select a.Model_Name as catalogy,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c 
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"  
                    group by a.Model_Name  
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                    ) b 
                    order by qty desc 
                    ) where rownum<10";
            #endregion
            else if (vPhotoType == "REPAIR")
            #region REPAIR
            {
                if (vSubType == "PARTS")
                    sql = @"select * from (
                            select a.catalogy, 
                            case
                            when b.input = 0 then
                            0
                            when b.input < a.qty then
                            0
                            else
                            round((a.qty / b.input) * 1000000) end as dppm,0 as Error_Percent,percents,a.qty as PartQty from 
                        (     
                        select a.repair_desc as catalogy,nvl(sum(a.qty),0) as qty,round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents 
                        from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c  
                        where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                                and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                                and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"                            
                        group by a.repair_desc 
                        )a,    
                        (
                        select NVL(sum(a.output_qty), 0) as input
                        from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b
                        where a.plant_code like :sap
                                and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                                and a.plant_code = b.sap_plant
                                and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                                and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"                                  
                        ) b                    
                        order by percents desc 
                        ) where rownum<10";
                else if (vSubType == "LINE" || vSubType == "AREA")
                    sql = @"select * from (
                        select a.catalogy, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm,0 as Error_Percent,percents,a.qty as PartQty from 
                    (     
                    select a.repair_desc as catalogy,nvl(sum(a.qty),0) as qty,round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c ,sfis1.c_line_def_t d   
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant and d.site_id=c.site_id and a.line_name = d.mes_line " + sql1 + @"                            
                    group by a.repair_desc 
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b,sfis1.c_line_def_t d 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"    
                            and d.site_id=b.site_id and a.line_name = d.mes_line                  
                    ) b                    
                    order by percents desc 
                    ) where rownum<10";
                else if (vSubType == "MODEL" || vSubType == "LOB")
                    sql = @"select * from (
                        select a.catalogy, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm,0 as Error_Percent,percents,a.qty as PartQty from 
                    (     
                    select a.repair_desc as catalogy,nvl(sum(a.qty),0) as qty,round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents 
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code 
                                          ),a.model_name) as model_serial from sfism4.r_kpi_pid_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                            ,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c 
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"  
                    group by a.repair_desc 
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                         ,sfis1.c_plant_def_t b 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess("FATP", strCust) + @"    
                    ) b                    
                    order by percents desc 
                    ) where rownum<10";
                else
                    sql = @"select * from (
                        select a.catalogy, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm,0 as Error_Percent,percents,a.qty as PartQty from 
                    (     
                    select a.repair_desc as catalogy,nvl(sum(a.qty),0) as qty,round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents 
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code 
                                          ),a.model_name) as model_serial from sfism4.r_kpi_pid_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                            ,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c ,sfis1.c_line_def_t d   
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant and d.site_id=c.site_id and a.line_name = d.mes_line " + sql1 + @"  
                    group by a.repair_desc 
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                         ,sfis1.c_plant_def_t b,sfis1.c_line_def_t d,sfis1.c_model_serial_def_t e 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"      
                            and d.site_id=b.site_id and a.line_name = d.mes_line            
                    ) b                    
                    order by percents desc 
                    ) where rownum<10";
            }
            #endregion
            else if (vPhotoType == "LOB")
                #region LOB
                sql = @"select * from (
                        select a.catalogy,a.qty as PartQty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select a.model_serial as catalogy,nvl(sum(a.qty),0) as qty 
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code 
                                          ),a.model_name) as model_serial from sfism4.r_kpi_pid_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                            ,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c 
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"  
                            and d.model_name=a.model_name and d.plant_code = c.rms_plant and d.bu_code=a.bu_code 
                    group by a.model_serial 
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"          
                    ) b 
                    order by qty desc 
                    ) where rownum<10";
            #endregion
            else if (vPhotoType == "PARTS")
                #region PARTS
                sql = @"select * from (
                        select a.catalogy,a.qty as PartQty, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm from 
                    (     
                    select a.material_type as catalogy,nvl(sum(a.qty),0) as qty 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c 
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"  
                    group by a.material_type  
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"                    
                    ) b                    
                    order by qty desc 
                    ) where rownum<10";
            #endregion
            else if (vPhotoType == "TOP")
            #region TOP
            {
                if (vSubType == "PARTS")
                    sql = @"select * from (
                        select a.catalogy, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm,0 as Error_Percent,percents,a.qty as PartQty from 
                    (     
                    select a.material_type as catalogy,nvl(sum(a.qty),0) as qty,round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c  
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @" 
                    group by a.material_type 
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"              
                    ) b                    
                    order by percents desc 
                    ) where rownum<2";
                else if (vSubType == "LINE" || vSubType == "AREA")
                    sql = @"select * from (
                        select a.catalogy, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm,0 as Error_Percent,percents,a.qty as PartQty from 
                    (     
                    select a.material_type as catalogy,nvl(sum(a.qty),0) as qty,round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents 
                    from sfism4.r_kpi_pid_t a,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c,sfis1.c_line_def_t d    
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant and d.site_id=c.site_id and a.line_name = d.mes_line " + sql1 + @" 
                    group by a.material_type 
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b,sfis1.c_line_def_t d 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"     
                            and d.site_id=b.site_id and a.line_name = d.mes_line                
                    ) b                
                    order by percents desc 
                    ) where rownum<2";
                else if (vSubType == "MODEL" || vSubType == "LOB")
                    sql = @"select * from (
                        select a.catalogy, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm,0 as Error_Percent,percents,a.qty as PartQty from 
                    (     
                    select a.material_type as catalogy,nvl(sum(a.qty),0) as qty,round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents 
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code 
                                          ),a.model_name) as model_serial from sfism4.r_kpi_pid_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                          ,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c  
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant " + sql1 + @"  
                    group by a.material_type 
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                          ,sfis1.c_plant_def_t b,sfis1 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"             
                    ) b                    
                    order by percents desc 
                    ) where rownum<2";
                else
                    sql = @"select * from (
                        select a.catalogy, 
                        case
                        when b.input = 0 then
                        0
                        when b.input < a.qty then
                        0
                        else
                        round((a.qty / b.input) * 1000000) end as dppm,0 as Error_Percent,percents,a.qty as PartQty from 
                    (     
                    select a.material_type as catalogy,nvl(sum(a.qty),0) as qty,round(ratio_to_report(sum(a.qty)) over(), 4) * 100 percents 
                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=c.rms_plant and d.bu_code=a.bu_code 
                                          ),a.model_name) as model_serial from sfism4.r_kpi_pid_t a,sfis1.c_plant_def_t c where a.plant_code = c.sap_plant and a.bu_code=c.bu_code)a 
                        ,sfis1.c_data_dictionary_t b,sfis1.c_plant_def_t c ,sfis1.c_line_def_t d 
                    where a.plant_code like :sap and a.material_type=b.data_code and a.bu_code=c.bu_code  
                            and b.data_type='PID_MATERIAL_TYPE' and b.data_value = :ptype  
                            and a.bu_code='PCBG' and a.plant_code = c.sap_plant and d.site_id=c.site_id and a.line_name = d.mes_line " + sql1 + @"  
                    group by a.material_type 
                    )a,    
                    (
                    select NVL(sum(a.output_qty), 0) as input
                    from sfism4.r_kpi_fpy_t a ,sfis1.c_plant_def_t b 
                    where a.plant_code like :sap
                            and a.bu_code = 'PCBG' and a.bu_code=b.bu_code 
                            and a.plant_code = b.sap_plant
                            and instr(:cust, a.cust_no ) > 0 " + sqlInput + @"
                            and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"                     
                    ) b                    
                    order by percents desc 
                    ) where rownum<2";

            }

            #endregion
            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (vSubValue != "")
                ht.Add("subvalue", vSubValue);
            if (vErrorValue != "")
                ht.Add("errorvalue", vErrorValue);
            ht.Add("cust", strCust);
            ht.Add("ptype", vPType);
            if (vMType != "TOTAL")
                ht.Add("mtype", vMType);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                ht.Add("qinputcond", vQCond);
                ht.Add("qcond", vQCond);
            }
            else if (vDateType == "Weekly")
            {
                ht.Add("qcond", vQCond.Replace("W", ""));
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qinputcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qinputcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                    ht.Add("qinputcond", cc[0]);
                    ht.Add("qinputcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                    ht.Add("qinputcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qinputcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
            {
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
                ht.Add("qinputcond", vQCond.Replace("M", "") + "%");
            }

            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetErrLogIndexData(string vPlant, string vSapPlant, string vDateType, string vQCond, string vMType, string vPType, string vPhotoType, int vTop, string qOrderBy, string qOrderAsc)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sqlType = "";
            string strPlant = "", strShift = "", strCust = "", strOrderBy = "";
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strPlant = vPlant;
            strCust = getCust(strPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2  ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (qOrderBy == "Error Rate")
                strOrderBy = "err_rate";
            else if (qOrderBy == "Fail Qty")
                strOrderBy = "ErrorQty";
            if (vMType == "PROGRAM")
                sqlType = "a.GROUP_NAME||'-'||a.FUNC_ID";
            else if (vMType == "GROUP")
                sqlType = "a.GROUP_NAME";
            else if (vMType == "LINE")
                sqlType = "a.LINE_NAME";
            else if (vMType == "SYMPTOM")
                sqlType = "a.MSG_CODE";
            if (vMType == "LINE" && vPhotoType != "EXCEL")
                sql1 += " and a.sub_process = :subvalue ";
            string sql = "";
            sql = @"SELECT * FROM
                             (SELECT x.catalogy,case
					                when x.ErrorQty = 0 then
					                0
					                when y.TotalQty < x.ErrorQty then
					                0
					                else
					                round((x.ErrorQty / y.TotalQty) * 100,2) end as err_rate ,x.ErrorQty,y.TotalQty FROM                               
                              (SELECT " + sqlType + @" AS catalogy, sum(QTY) AS ErrorQty 
                                FROM (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial,nvl((select c.SUB_PROCESS  from sfis1.C_LINE_DEF_T c where a.LINE_NAME =c.MES_LINE
                                          ),'N/A') as SUB_PROCESS from sfism4.R_ERROR_LOG_ANALYSIS_T a)a 
                                WHERE a.MSG_TYPE IN (1) AND a.plant_code like :sap AND instr(:cust,a.cust_code ) >0 AND a.process=:mprocess " + sql1 + @"
                              GROUP BY " + sqlType + @")x,
                              (SELECT " + sqlType + @" AS catalogy, sum(QTY) AS TotalQty 
                                FROM (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial,nvl((select c.SUB_PROCESS  from sfis1.C_LINE_DEF_T c where a.LINE_NAME =c.MES_LINE
                                          ),'N/A') as SUB_PROCESS from sfism4.R_ERROR_LOG_ANALYSIS_T a)a 
                                WHERE a.MSG_TYPE IN (0,1) AND a.plant_code like :sap AND instr(:cust,a.cust_code ) > 0 AND a.process=:mprocess " + sql1 + @"
                              GROUP BY " + sqlType + @")y
                              WHERE x.catalogy=y.catalogy ORDER BY " + strOrderBy + " " + qOrderAsc + @"
                    ) ";
            if (vPhotoType != "EXCEL")
                sql += @" WHERE ROWNUM <= :itop ";
            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else if (vSapPlant.IndexOf("VN") > -1)
                ht.Add("sap", "VN%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (vPhotoType != "EXCEL")
                ht.Add("itop", vTop);
            ht.Add("mprocess", vPType);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vMType == "LINE" && vPhotoType != "EXCEL")
                ht.Add("subvalue", vPhotoType);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");

            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetErrLogLv2Data(string vPlant, string vSapPlant, string vDateType, string vQCond, string vMType, string vPType, string vSubType, string vSubValue, string vPhotoType, int vTop, string qOrderBy, string qOrderAsc, string vExData1 = "", string vExData2 = "")
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sqlType = "";
            string strPlant = "", strShift = "", strCust = "", strOrderBy = "", strMprocess = "";
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strPlant = vPlant;
            strCust = getCust(strPlant);
            if (vMType.IndexOf("_") > -1)
            {
                string[] bb = vMType.Split('_');
                vMType = bb[0];
                strMprocess = bb[1];
            }
            if (qOrderBy == "Error Rate")
                strOrderBy = "err_rate";
            else if (qOrderBy == "Fail Qty")
                strOrderBy = "ErrorQty";
            if (vSubType == "TREND")
            {
                if (vDateType == "Daily" || vDateType == "Range")
                    sqlType = " a.work_date ";
                else if (vDateType == "Weekly")
                    sqlType = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
                else
                    sqlType = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
                sql1 = " and a.work_date between :qcond and :qcond2  ";
                if (strShift != "ALL")
                    sql1 += " and a.shift_period = :shift ";
            }
            else
            {
                if (vDateType == "Daily")
                    sql1 = " and a.work_date = :qcond ";
                else if (vDateType == "Weekly" || vDateType == "Range")
                    sql1 = " and a.work_date between :qcond and :qcond2  ";
                else
                    sql1 = " and a.work_date like :qcond ";
                if (strShift != "ALL")
                    sql1 += " and a.shift_period = :shift ";
                if (vSubType == "LOB")
                    sqlType = " a.model_serial ";
                else if (vSubType == "MODEL")
                    sqlType = " a.model_name ";
                else if (vSubType == "LINE")
                {
                    sqlType = " a.line_name ";
                    sql1 += " and a.sub_process = :subvalue ";
                }
                else if (vSubType == "SYMPTOM")
                    sqlType = " a.msg_code ";
                else if (vSubType == "USER")
                    sqlType = " a.client_user ";
            }
            if (vMType == "PROGRAM")
                sql1 += " and a.GROUP_NAME||'-'||a.FUNC_ID = :qptye ";
            else if (vMType == "GROUP")
                sql1 += " and a.GROUP_NAME = :qptye ";
            else if (vMType == "LINE")
                sql1 += " and a.LINE_NAME = :qptye ";
            else if (vMType == "SYMPTOM")
                sql1 += " and a.MSG_CODE = :qptye ";
            //if (vMType == "PROGRAM")
            //    sqlType = "a.GROUP_NAME||'-'||a.FUNC_ID";
            //else if (vMType == "GROUP")
            //    sqlType = "a.GROUP_NAME";
            //else if (vMType == "LINE")
            //    sqlType = "a.LINE_NAME";
            //else if (vMType == "SYMPTOM")
            //    sqlType = "a.MSG_CODE";
            string sql = "";
            sql = @"SELECT * FROM
                             (SELECT x.catalogy,case
					                when x.ErrorQty = 0 then
					                0
					                when y.TotalQty < x.ErrorQty then
					                0
					                else
					                round((x.ErrorQty / y.TotalQty) * 100,2) end as err_rate ,x.ErrorQty,y.TotalQty FROM                               
                              (SELECT " + sqlType + @" AS catalogy, sum(QTY) AS ErrorQty 
                                FROM (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial,nvl((select c.SUB_PROCESS  from sfis1.C_LINE_DEF_T c where a.LINE_NAME =c.MES_LINE
                                          ),'N/A') as SUB_PROCESS from sfism4.R_ERROR_LOG_ANALYSIS_T a)a 
                                WHERE a.MSG_TYPE IN (1) AND a.plant_code like :sap AND instr(:cust,a.cust_code ) >0 AND a.process=:mprocess " + sql1 + @"
                              GROUP BY " + sqlType + @")x,
                              (SELECT " + sqlType + @" AS catalogy, sum(QTY) AS TotalQty 
                                FROM (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial,nvl((select c.SUB_PROCESS  from sfis1.C_LINE_DEF_T c where a.LINE_NAME =c.MES_LINE
                                          ),'N/A') as SUB_PROCESS from sfism4.R_ERROR_LOG_ANALYSIS_T a)a 
                                WHERE a.MSG_TYPE IN (0,1) AND a.plant_code like :sap AND instr(:cust,a.cust_code ) > 0 AND a.process=:mprocess " + sql1 + @"
                              GROUP BY " + sqlType + @")y
                              WHERE x.catalogy=y.catalogy ORDER BY ";
            if (vSubType != "TREND")
                sql += strOrderBy + " " + qOrderAsc;
            else
                sql += "catalogy";
            sql += @" ) ";
            if (vPhotoType == "")
                sql += @" WHERE ROWNUM <= :itop ";
            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else if (vSapPlant.IndexOf("VN") > -1)
                ht.Add("sap", "VN%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSubValue != "")
                ht.Add("subvalue", vSubValue);
            ht.Add("cust", strCust);
            ht.Add("itop", vTop);
            ht.Add("mprocess", strMprocess);
            ht.Add("qptye", vPType);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vSubType != "TREND")
            {
                if (vDateType == "Daily")
                    ht.Add("qcond", vQCond);
                else if (vDateType == "Weekly")
                {
                    string strYear, strWeek;
                    vQCond = vQCond.Replace("W", "");
                    strYear = vQCond.Substring(0, 4);
                    strWeek = vQCond.Substring(4, 2);
                    DateTime sTime, eTime;
                    if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                    {
                        sTime = DateTime.Now.AddDays(-7);
                        eTime = DateTime.Now;
                    }
                    ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                    ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
                }
                else if (vDateType == "Range")
                {
                    if (vQCond.IndexOf("-") > -1)
                    {
                        string[] cc = vQCond.Split('-');
                        ht.Add("qcond", cc[0]);
                        ht.Add("qcond2", cc[1]);
                    }
                    else
                    {
                        ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                        ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                    }
                }
                else
                    ht.Add("qcond", vQCond.Replace("M", "") + "%");
            }
            else
            {
                ht.Add("qcond", vExData1);
                ht.Add("qcond2", vExData2);
            }

            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetErrLogLv3Data(string vPlant, string vSapPlant, string vDateType, string vQCond, string vMType, string vPType, string vSubType, string vSubValue, string vPhotoType, int vTop, string qOrderBy, string qOrderAsc, string vExData1 = "", string vExData2 = "")
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sqlType = "";
            string strPlant = "", strShift = "", strCust = "", strMprocess = "";
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strPlant = vPlant;
            strCust = getCust(strPlant);
            if (vMType.IndexOf("_") > -1)
            {
                string[] bb = vMType.Split('_');
                vMType = bb[0];
                strMprocess = bb[1];
            }
            if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2  ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vSubType == "LOB")
                sql1 += " and a.model_serial = :subvalue ";
            else if (vSubType == "MODEL")
                sql1 += " and a.model_name = :subvalue ";
            else if (vSubType == "LINE")
                sql1 += " and a.line_name = :subvalue ";
            else if (vSubType == "SYMPTOM")
                sql1 += " and a.msg_code = :subvalue ";
            else if (vSubType == "USER")
                sql1 += " and a.client_user = :subvalue ";
            if (vPhotoType == "User")
                sqlType = " a.client_user ";
            else if (vPhotoType == "Symptom")
                sqlType = "  a.msg_code ";
            if (vMType == "PROGRAM")
                sql1 += " and a.GROUP_NAME||'-'||a.FUNC_ID = :qptye ";
            else if (vMType == "GROUP")
                sql1 += " and a.GROUP_NAME = :qptye ";
            else if (vMType == "LINE")
                sql1 += " and a.LINE_NAME = :qptye ";
            else if (vMType == "SYMPTOM")
                sql1 += " and a.MSG_CODE = :qptye ";
            string sql = "";
            if (vExData1 != "")
            {
                sql = @"SELECT * FROM
                             (SELECT x.catalogy,
                             		case
					                when x.ErrorQty = 0 then
					                0
					                when z.TotalQty < x.ErrorQty then
					                0
					                else
					                round((x.ErrorQty / z.TotalQty) * 100,2) end as fr,			                
					                x.ErrorQty,z.TotalQty FROM                               
                              (SELECT " + sqlType + @" AS catalogy, sum(QTY) AS ErrorQty 
                                FROM (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial,nvl((select c.SUB_PROCESS  from sfis1.C_LINE_DEF_T c where a.LINE_NAME =c.MES_LINE
                                          ),'N/A') as SUB_PROCESS from sfism4.R_ERROR_LOG_ANALYSIS_T a)a 
                                WHERE a.MSG_TYPE IN (1) AND a.plant_code like :sap AND instr(:cust,a.cust_code ) >0 AND a.process=:mprocess " + sql1 + @"
                              GROUP BY " + sqlType + @")x,
                              (SELECT sum(QTY) AS TotalQty 
                                FROM (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial,nvl((select c.SUB_PROCESS  from sfis1.C_LINE_DEF_T c where a.LINE_NAME =c.MES_LINE
                                          ),'N/A') as SUB_PROCESS from sfism4.R_ERROR_LOG_ANALYSIS_T a)a 
                                WHERE a.MSG_TYPE IN (0,1) AND a.plant_code like :sap AND instr(:cust,a.cust_code ) > 0 AND a.process=:mprocess " + sql1 + @"
                              )z   
                              WHERE x.catalogy = :exinfo                  
                              ORDER BY errorqty DESC) WHERE ROWNUM <= :itop";
            }
            else
            {
                sql = @"SELECT * FROM
                             (SELECT x.catalogy,
                             		case
					                when x.ErrorQty = 0 then
					                0
					                when z.TotalQty < x.ErrorQty then
					                0
					                else
					                round((x.ErrorQty / z.TotalQty) * 100,2) end as fr,
                             		case
					                when x.ErrorQty = 0 then
					                0
					                when y.UTotalQty < x.ErrorQty then
					                0
					                else
					                round((x.ErrorQty / y.UTotalQty) * 100,2) end as error_rate,					                
					                x.ErrorQty,y.UTotalQty,z.TotalQty FROM                               
                              (SELECT " + sqlType + @" AS catalogy, sum(QTY) AS ErrorQty 
                                FROM (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial,nvl((select c.SUB_PROCESS  from sfis1.C_LINE_DEF_T c where a.LINE_NAME =c.MES_LINE
                                          ),'N/A') as SUB_PROCESS from sfism4.R_ERROR_LOG_ANALYSIS_T a)a 
                                WHERE a.MSG_TYPE IN (1) AND a.plant_code like :sap AND instr(:cust,a.cust_code ) >0 AND a.process=:mprocess " + sql1 + @"
                              GROUP BY " + sqlType + @")x,
                             (SELECT sum(QTY) AS UTotalQty 
                                FROM (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                            ),a.model_name) as model_serial,nvl((select c.SUB_PROCESS  from sfis1.C_LINE_DEF_T c where a.LINE_NAME =c.MES_LINE
                                            ),'N/A') as SUB_PROCESS from sfism4.R_ERROR_LOG_ANALYSIS_T a)a 
                                WHERE a.MSG_TYPE IN (1) AND a.plant_code like :sap AND instr(:cust,a.cust_code ) >0 AND a.process=:mprocess " + sql1 + @"
                                )y,
                              (SELECT sum(QTY) AS TotalQty 
                                FROM (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial,nvl((select c.SUB_PROCESS  from sfis1.C_LINE_DEF_T c where a.LINE_NAME =c.MES_LINE
                                          ),'N/A') as SUB_PROCESS from sfism4.R_ERROR_LOG_ANALYSIS_T a)a 
                                WHERE a.MSG_TYPE IN (0,1) AND a.plant_code like :sap AND instr(:cust,a.cust_code ) > 0 AND a.process=:mprocess " + sql1 + @"
                               )z                            
                              ORDER BY errorqty DESC) WHERE ROWNUM <= :itop";
            }
            ht.Clear();
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else if (vSapPlant.IndexOf("VN") > -1)
                ht.Add("sap", "VN%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSubValue != "" && vSubType != "TREND")
                ht.Add("subvalue", vSubValue);
            ht.Add("cust", strCust);
            ht.Add("itop", vTop);
            ht.Add("mprocess", strMprocess);
            ht.Add("qptye", vPType);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vExData1 != "")
                ht.Add("exinfo", vExData1);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");

            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        private string getCust(string vPlant)
        {
            string res = "";
            Hashtable ht = new Hashtable();
            string sql = @"select b.data_value 
                            from sfis1.c_data_dictionary_t b 
                            where b.data_code=:plant and b.data_type='PLANT_CUST' and b.data_desc='PCBG'  ";
            ht.Clear();
            ht.Add("plant", vPlant);
            try
            {
                res = mDBTools.ExecuteQueryStrHt(sql, ht);
            }
            catch
            {
                res = "";
            }
            return res;
        }
        private string getSubProcess(string vMProcess, string vCust)
        {
            string res = "";
            Hashtable ht = new Hashtable();
            string sql = @" select b.data_value 
                            from sfis1.c_data_dictionary_t b 
                            where  b.data_type=:datatype and b.data_code=:cust and b.data_desc='PCBG'  ";
            ht.Clear();
            ht.Add("datatype", "PROCESS_" + vMProcess);
            ht.Add("cust", vCust);
            try
            {
                res = mDBTools.ExecuteQueryStrHt(sql, ht);
                if (res == "" || res == null)
                {
                    if (vMProcess == "SMT")
                        res = " and a.sub_process in ('SMT')  ";
                    else if (vMProcess == "PCB")
                        res = " and a.sub_process in ('PCB')  ";
                    else if (vMProcess == "PACK")
                        res = " and a.sub_process in ('PACK')  ";
                    else
                        res = " and a.sub_process in ('ASSY', 'CELL', 'REPAIR', 'TNB', 'DOCK')  ";
                }
                else if (res == "N/A")
                    res = "";
            }
            catch
            {
                res = "";
            }
            return res;
        }
        public DataTable GetFpyDataLast(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
                //  strExSql = " and a.model_serial like :ex1 ";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            string sql = "";
            sql = @"select * from 
                            (select :fpydate as fpydate,
                                    y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG' and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql +
                                  @"    and a.process='FATP'                                   
                                ) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from sfism4.r_kpi_fpy_t a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                      and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql +
                                  @"  and a.process='FATP' " + getSubProcess("FATP", strCust) + @"    
                                      ) y                                       
                                ) a ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    vQCond = DateTime.ParseExact(cc[1], "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                }
                else
                    vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                sTime = sTime.AddDays(-7);
                eTime = eTime.AddDays(-7);
                string strLastWeek = "";
                System.Globalization.GregorianCalendar gc = new System.Globalization.GregorianCalendar();
                int weekOfYear = gc.GetWeekOfYear(sTime, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
                strLastWeek = "W" + weekOfYear.ToString("00");
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
                ht.Add("fpydate", strLastWeek);
            }
            else
            {
                vQCond = vQCond.Replace("M", "");
                vQCond = DateTime.ParseExact(vQCond, "yyyyMM", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-1).ToString("yyyyMM");
                ht.Add("qcond", vQCond + "%");
                ht.Add("fpydate", "M" + vQCond.Substring(4, 2));
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataThis(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            string sql = "";
            sql = @"select * from 
                            (select :fpydate as fpydate,
                                    y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG' and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql +
                                  @"    and a.process='FATP'         
                                ) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                      and instr(:cust,a.cust_no ) >0 " + sql1 + strExSql +
                                  @"   and a.process='FATP' " + getSubProcess("FATP", strCust) + @"    
                                      ) y                                       
                                ) a ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                //      vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    vQCond = cc[1];
                }
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                ht.Add("fpydate", vQCond.Substring(4));
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                //sTime = sTime.AddDays(-7);
                //eTime = eTime.AddDays(-7);
                //string strLastWeek = "";
                //System.Globalization.GregorianCalendar gc = new System.Globalization.GregorianCalendar();
                //int weekOfYear = gc.GetWeekOfYear(sTime, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
                //strLastWeek = sTime.Year.ToString() + "W" + weekOfYear.ToString("00");
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else
            {
                ht.Add("fpydate", vQCond.Substring(4));
                vQCond = vQCond.Replace("M", "");
                // vQCond = DateTime.ParseExact(vQCond, "yyyyMM", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-1).ToString("yyyyMM");
                ht.Add("qcond", vQCond + "%");
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataLastSMT(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }
            string sql = "";
            sql = @"select * from 
                            (select :fpydate as fpydate,
                                    y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG' " + sql1 + strExSql +
                                  @"    and a.process='SMT'                                                                              
                                ) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                       " + sql1 + strExSql +
                                  @"   and a.process='SMT' " + getSubProcess("SMT", strCust) + @"                                 
                                      ) y                                       
                                ) a ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    vQCond = DateTime.ParseExact(cc[1], "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                }
                else
                    vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                sTime = sTime.AddDays(-7);
                eTime = eTime.AddDays(-7);
                string strLastWeek = "";
                System.Globalization.GregorianCalendar gc = new System.Globalization.GregorianCalendar();
                int weekOfYear = gc.GetWeekOfYear(sTime, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
                strLastWeek = "W" + weekOfYear.ToString("00");
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
                ht.Add("fpydate", strLastWeek);
            }
            else
            {
                vQCond = vQCond.Replace("M", "");
                vQCond = DateTime.ParseExact(vQCond, "yyyyMM", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-1).ToString("yyyyMM");
                ht.Add("qcond", vQCond + "%");
                ht.Add("fpydate", "M" + vQCond.Substring(4, 2));
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataThisSMT(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }
            string sql = "";
            sql = @"select * from 
                            (select :fpydate as fpydate,
                                    y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG'  " + sql1 + strExSql +
                                  @"    and a.process='SMT'                                         
                                ) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                       " + sql1 + strExSql +
                                  @"   and a.process='SMT' " + getSubProcess("SMT", strCust) + @"    
                                      ) y                                       
                                ) a ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                //      vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    vQCond = cc[1];
                }
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                ht.Add("fpydate", vQCond.Substring(4));
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                //sTime = sTime.AddDays(-7);
                //eTime = eTime.AddDays(-7);
                //string strLastWeek = "";
                //System.Globalization.GregorianCalendar gc = new System.Globalization.GregorianCalendar();
                //int weekOfYear = gc.GetWeekOfYear(sTime, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
                //strLastWeek = sTime.Year.ToString() + "W" + weekOfYear.ToString("00");
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else
            {
                ht.Add("fpydate", vQCond.Substring(4));
                vQCond = vQCond.Replace("M", "");
                // vQCond = DateTime.ParseExact(vQCond, "yyyyMM", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-1).ToString("yyyyMM");
                ht.Add("qcond", vQCond + "%");
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataLastInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }
            string sql = "";
            sql = @"select * from 
                            (select :fpydate as fpydate,
                                    y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select NVL(sum(a.gap_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG' " + sql1 + strExSql +
                                  @"    and a.process='SMT'                                                                              
                                ) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                       " + sql1 + strExSql +
                                  @"   and a.process='SMT' " + getSubProcess("SMT", strCust) + @"                                 
                                      ) y                                       
                                ) a ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    vQCond = DateTime.ParseExact(cc[1], "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                }
                else
                    vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                sTime = sTime.AddDays(-7);
                eTime = eTime.AddDays(-7);
                string strLastWeek = "";
                System.Globalization.GregorianCalendar gc = new System.Globalization.GregorianCalendar();
                int weekOfYear = gc.GetWeekOfYear(sTime, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
                strLastWeek = "W" + weekOfYear.ToString("00");
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
                ht.Add("fpydate", strLastWeek);
            }
            else
            {
                vQCond = vQCond.Replace("M", "");
                vQCond = DateTime.ParseExact(vQCond, "yyyyMM", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-1).ToString("yyyyMM");
                ht.Add("qcond", vQCond + "%");
                ht.Add("fpydate", "M" + vQCond.Substring(4, 2));
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataThisInsightSMT(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }
            string sql = "";
            sql = @"select * from 
                            (select :fpydate as fpydate,
                                    y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select NVL(sum(a.gap_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG'  " + sql1 + strExSql +
                                  @"    and a.process='SMT'                                         
                                ) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap
                                      and a.bu_code='PCBG' 
                                       " + sql1 + strExSql +
                                  @"   and a.process='SMT' " + getSubProcess("SMT", strCust) + @"    
                                      ) y                                       
                                ) a ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                //      vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    vQCond = cc[1];
                }
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                ht.Add("fpydate", vQCond.Substring(4));
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                //sTime = sTime.AddDays(-7);
                //eTime = eTime.AddDays(-7);
                //string strLastWeek = "";
                //System.Globalization.GregorianCalendar gc = new System.Globalization.GregorianCalendar();
                //int weekOfYear = gc.GetWeekOfYear(sTime, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
                //strLastWeek = sTime.Year.ToString() + "W" + weekOfYear.ToString("00");
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else
            {
                ht.Add("fpydate", vQCond.Substring(4));
                vQCond = vQCond.Replace("M", "");
                // vQCond = DateTime.ParseExact(vQCond, "yyyyMM", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-1).ToString("yyyyMM");
                ht.Add("qcond", vQCond + "%");
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataLastInsight(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "", strMProcess = "FATP";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            string sql = "";
            sql = @"select * from 
                            (select :fpydate as fpydate,
                                    y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0 " + sql1 + strExSql +
                                  @"    and a.process='FATP'                                                                              
                                ) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0 
                                      and a.bu_code='PCBG' 
                                       " + sql1 + strExSql +
                                  @"   and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                                 
                                      ) y                                       
                                ) a ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    vQCond = DateTime.ParseExact(cc[1], "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                }
                else
                    vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                sTime = sTime.AddDays(-7);
                eTime = eTime.AddDays(-7);
                string strLastWeek = "";
                System.Globalization.GregorianCalendar gc = new System.Globalization.GregorianCalendar();
                int weekOfYear = gc.GetWeekOfYear(sTime, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
                strLastWeek = "W" + weekOfYear.ToString("00");
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
                ht.Add("fpydate", strLastWeek);
            }
            else
            {
                vQCond = vQCond.Replace("M", "");
                vQCond = DateTime.ParseExact(vQCond, "yyyyMM", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-1).ToString("yyyyMM");
                ht.Add("qcond", vQCond + "%");
                ht.Add("fpydate", "M" + vQCond.Substring(4, 2));
            }
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataThisInsight(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "", strMProcess = "FATP";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            string sql = "";
            sql = @"select * from 
                            (select :fpydate as fpydate,
                                    y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.plant_code like :sap and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0 " + sql1 + strExSql +
                                  @"    and a.process='FATP'                                         
                                ) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0 
                                      and a.bu_code='PCBG' 
                                       " + sql1 + strExSql +
                                  @"   and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                      ) y                                       
                                ) a ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                //      vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    vQCond = cc[1];
                }
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                ht.Add("fpydate", vQCond.Substring(4));
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else
            {
                ht.Add("fpydate", vQCond.Substring(4));
                vQCond = vQCond.Replace("M", "");
                // vQCond = DateTime.ParseExact(vQCond, "yyyyMM", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-1).ToString("yyyyMM");
                ht.Add("qcond", vQCond + "%");
            }
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataLastPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "", strMProcess = "FATP";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            string sql = "";
            sql = @"select * from 
                            (select :fpydate as fpydate,
                                    y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select NVL(sum(a.qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a)a 
                                 where a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                 @" ) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0 
                                      and a.bu_code='PCBG' 
                                       " + sql1 + strExSql +
                                  @"   and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                                 
                                      ) y                                       
                                ) a ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    vQCond = DateTime.ParseExact(cc[1], "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                }
                else
                    vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                sTime = sTime.AddDays(-7);
                eTime = eTime.AddDays(-7);
                string strLastWeek = "";
                System.Globalization.GregorianCalendar gc = new System.Globalization.GregorianCalendar();
                int weekOfYear = gc.GetWeekOfYear(sTime, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
                strLastWeek = "W" + weekOfYear.ToString("00");
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
                ht.Add("fpydate", strLastWeek);
            }
            else
            {
                vQCond = vQCond.Replace("M", "");
                vQCond = DateTime.ParseExact(vQCond, "yyyyMM", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-1).ToString("yyyyMM");
                ht.Add("qcond", vQCond + "%");
                ht.Add("fpydate", "M" + vQCond.Substring(4, 2));
            }
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataThisPcbLrr(string vPlant, string vSapPlant, string vDateType, string vQCond)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1;
            string strShift = "", strCust = "";
            string strExSql = "", strExType = "", strMProcess = "FATP";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily" || vDateType == "Range")
                sql1 = " and a.work_date = :qcond ";
            else if (vDateType == "Weekly")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            string sql = "";
            sql = @"select * from 
                            (select :fpydate as fpydate,
                                    y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select NVL(sum(a.qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a)a 
                                 where a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                 @" ) x,
                                (select NVL(sum(a.output_qty),0) as input
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0 
                                      and a.bu_code='PCBG' 
                                       " + sql1 + strExSql +
                                  @"   and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"    
                                      ) y                                       
                                ) a ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vDateType == "Daily")
            {
                //      vQCond = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd");
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    vQCond = cc[1];
                }
                ht.Add("qcond", vQCond);
                ht.Add("fpydate", vQCond.Substring(4));
            }
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                ht.Add("fpydate", vQCond.Substring(4));
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else
            {
                ht.Add("fpydate", vQCond.Substring(4));
                vQCond = vQCond.Replace("M", "");
                // vQCond = DateTime.ParseExact(vQCond, "yyyyMM", System.Globalization.CultureInfo.CurrentCulture).AddMonths(-1).ToString("yyyyMM");
                ht.Add("qcond", vQCond + "%");
            }
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataByErrorType(string vPlant, string vSapPlant, string vDateType, string vQCond, string vType, string vTypeCond, string vType2 = "", string vTypeCond2 = "", string vType3 = "", string vTypeCond3 = "")
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sql3 = "", sqlType2 = "";
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vDateType == "Daily")
                sql1 = " and a.work_date= :qcond ";
            else if (vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else
                sql1 = " and a.work_date like :qcond";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vType == "ERROR")
            {
                if (vTypeCond == "ME")
                    sql3 = " and b.error_type in ('A','C','F') ";
                else if (vTypeCond == "EE")
                    sql3 = " and b.error_type in ('E') ";
                if (vType2 == "LINE")
                {
                    sqlType2 += @" a.line_name ";
                    if (vTypeCond2 != "ALL")
                    {
                        if (vTypeCond2.IndexOf("PACK") > -1)
                            strMProcess = "PACK";
                        sql2 = " and line_name in (SELECT MES_LINE FROM sfis1.C_LINE_DEF_T t WHERE SUB_PROCESS =:typeconde2) ";
                    }
                }
                else if (vType2 == "LOB")
                    sqlType2 += @" a.model_serial ";
                else if (vType2 == "MODEL")
                    sqlType2 += @" a.model_name ";
                else if (vType2 == "GROUP")
                    sqlType2 += @" a.group_name ";
                if (vTypeCond3 != "")
                {
                    if (vType3 == "LOB")
                        sql2 = " and a.model_serial = :vvalue ";
                    else if (vType3 == "LINE")
                        sql2 = " and a.line_name = :vvalue ";
                    else if (vType3 == "MODEL")
                        sql2 = " and a.model_name = :vvalue ";
                }
            }
            string sql = "";
            if (vType2 == "GROUP")
            {
                sql = @"select * from 
                            (select x.catalogy,
                                   x.error_input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select d.data_value as catalogy,  
                                   NVL(count(0),0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t b,sfis1.c_data_dictionary_t d  
                                 where a.process='FATP' and a.test_code=b.error_code and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + sql3 + @"        
                                   and a.plant_code like :sap and a.fpy_flag='Y' and a.group_name = d.data_code and d.data_type = 'FPY_GROUP'                                                  
                                 group by d.data_value ) x,
                                (select d.data_value as catalogy,
                                         sum(a.pass_qty + a.repass_qty+a.fail_qty+a.refail_qty) as input
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code =:plant and d.bu_code = 'PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a
                                    where a.plant_code like :sap
                                          and a.date_type = 'D'
                                          and a.mo_type = 'ZP01'
                                          and instr(:cust,a.cust_no ) > 0
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + sql2 + @"
                                          and a.group_name = d.data_code
                                          and d.data_type = 'FPY_GROUP'
                                          and((a.line_name not like '%REP%') or
                                        (a.line_name like '%REP%' and
                                         TRIM(a.group_name) not in
                                         ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL', 'TPDL_IN')))
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         and a.group_name not like '%OFF'
                                         and a.group_name not like '%_BR%'
                                         and a.line_name not like '%TNB%'
                                      group by d.data_value order by sum(a.fail_qty) + sum(a.refail_qty) desc) y                                       
                                where x.catalogy=y.catalogy  order by fpy desc) where rownum <=10 ";

            }
            else
            {
                sql = @"select * from 
                            (select x.catalogy,
                                   x.error_input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end fpy 
                                from                             
                                (select " + sqlType2 + @" as catalogy,  
                                   NVL(count(0),0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t b 
                                 where a.process='FATP' and a.test_code=b.error_code and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + sql3 + @"        
                                   and a.plant_code like :sap and a.fpy_flag='Y'                                         
                                 group by " + sqlType2 + @" ) x,
                                (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input 
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.bu_code='PCBG' and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"     
                                      group by " + sqlType2 + @" ) y                                       
                                where x.catalogy=y.catalogy  order by fpy desc) where rownum <=10 ";
            }
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vType2 == "LINE")
                ht.Add("typeconde2", vTypeCond2);
            if (vTypeCond3 != "")
                ht.Add("vvalue", vTypeCond3);
            if (vDateType == "Daily")
                ht.Add("qcond", vQCond);
            else if (vDateType == "Weekly")
            {
                string strYear, strWeek;
                vQCond = vQCond.Replace("W", "");
                strYear = vQCond.Substring(0, 4);
                strWeek = vQCond.Substring(4, 2);
                DateTime sTime, eTime;
                if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                {
                    sTime = DateTime.Now.AddDays(-7);
                    eTime = DateTime.Now;
                }
                ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
            }
            else if (vDateType == "Range")
            {
                if (vQCond.IndexOf("-") > -1)
                {
                    string[] cc = vQCond.Split('-');
                    ht.Add("qcond", cc[0]);
                    ht.Add("qcond2", cc[1]);
                }
                else
                {
                    ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                }
            }
            else
                ht.Add("qcond", vQCond.Replace("M", "") + "%");
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataTrend(string vPlant, string vSapPlant, string vDateType, string vSDate, string vEDate, string vType, string vTypeCond, string vType2 = "", string vTypeCond2 = "", string vType3 = "", string vTypeCond3 = "")
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sql3 = "", sql4 = "", sqlType1 = "", sqlType2 = "";
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            sql4 = " and a.work_date between :qcond and :qcond2 ";
            if (vDateType == "Daily")
            {
                sqlType1 = " a.work_date ";
                sqlType2 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType1 = " to_char(to_date(a.work_date,'YYYYMMDD'),'IYYYIW') ";
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
            }
            else
            {
                sqlType1 = " substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
                sqlType2 = " substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
            }
            if (strShift != "ALL")
            {
                sql1 += " and a.shift_period = :shift ";
                sql4 += " and a.shift_period = :shift ";
            }
            if (vTypeCond != "")
            {
                if (vType == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond ";
                }
                else if (vType == "LOB")
                    sql1 += @" and a.model_serial =:typecond ";
                else if (vType == "MODEL")
                    sql1 += @" and a.model_name =:typecond ";
                else if (vType == "STATION")
                    sql1 += @" and d.data_value =:typecond  ";
                else if (vType == "DUTY")
                    sql2 += @" and g.data_value =:typecond  ";
            }
            if (vTypeCond2 != "")
            {
                if (vType2 == "LINE")
                    sql1 += @" and a.line_name=:typecond2 ";
                else if (vType2 == "LOB")
                    sql1 += @" and a.model_serial =:typecond2 ";
                else if (vType2 == "MODEL")
                    sql1 += @" and a.model_name =:typecond2 ";
            }
            if (vTypeCond3 != "")
            {
                if (vType3 == "LINE")
                    sql1 += @" and a.line_name=:typecond3 ";
                else if (vType3 == "LOB")
                    sql1 += @" and a.model_serial =:typecond3 ";
                else if (vType3 == "MODEL")
                    sql1 += @" and a.model_name =:typecond3 ";
            }
            if (vType == "ERROR" || vType == "ERRORT")
            {
                if (vTypeCond == "ME")
                    sql3 = " and b.error_type in ('A','C','F') ";
                else if (vTypeCond == "EE")
                    sql3 = " and b.error_type in ('E') ";
                if (vType2 == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond2 ";
                    if (vTypeCond2.IndexOf("PACK") > -1)
                        strMProcess = "PACK";
                }
                else if (vType2 == "LOB")
                    sql1 += @" and a.model_serial =:typecond2 ";
            }
            string sql = "";
            if (vType == "LINE")
                sql = @" select " + sqlType2 + @" as catalogy,  
                                     NVL(sum(a.output_qty), 0) as input,
                                    case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end fpy," + sqlType1 + @" as orderlogy 
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a
                                        ,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                                 where  a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code   
                                   and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap  
                                 group by " + sqlType2 + "," + sqlType1 + @" order by orderlogy ";
            else if (vType == "LOB" || vType == "")
                sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy  ,x.orderlogy 
                                from                             
                                (select " + sqlType2 + @" as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input," + sqlType1 + @" as orderlogy  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code='PCBG' and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and a.process='FATP'                             
                                 group by " + sqlType2 + "," + sqlType1 + @" ) x,
                                (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input ," + sqlType1 + @" as orderlogy  
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a  
                                where a.bu_code='PCBG' and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap  and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"     
                                      group by " + sqlType2 + "," + sqlType1 + @" ) y                                       
                                where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            else if (vType == "MODEL")
                sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy  ,x.orderlogy 
                                from                             
                                (select " + sqlType2 + @" as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input," + sqlType1 + @" as orderlogy  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code='PCBG' and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and a.process='FATP'                             
                                 group by " + sqlType2 + "," + sqlType1 + @" ) x,
                                (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input ," + sqlType1 + @" as orderlogy  
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a  
                                where a.bu_code='PCBG' and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap  and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"     
                                      group by " + sqlType2 + "," + sqlType1 + @" ) y                                       
                                where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            else if (vType == "ERROR")
            {
                sql = @"select * from 
                            (select x.catalogy,
                                   x.error_input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end fpy  ,x.orderlogy 
                                from                             
                                (select " + sqlType2 + @" as catalogy,  
                                   NVL(count(0),0) as error_input," + sqlType1 + @" as orderlogy  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t b 
                                 where a.process='FATP' and a.test_code=b.error_code and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + sql3 + @"        
                                   and a.plant_code like :sap";
                if (strCust != "A76")
                    sql += "        and a.FPY_FLAG = 'Y' ";
                sql += @"           group by " + sqlType2 + "," + sqlType1 + @" ) x,
                                (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input ," + sqlType1 + @" as orderlogy  
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.bu_code='PCBG' and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"     
                                      group by " + sqlType2 + "," + sqlType1 + @" ) y                                       
                                where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            }
            else if (vType == "ERRORT")
            {
                sql = @"select * from 
                            (select x.catalogy,
                                   x.error_input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round(( x.error_input / y.input) * 100, 2)
                                   end fpy  ,x.orderlogy 
                                from                             
                                (select " + sqlType2 + @" as catalogy,  
                                   NVL(count(0),0) as error_input," + sqlType1 + @" as orderlogy  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t b 
                                 where a.process='FATP' and a.test_code=b.error_code and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + sql3 + @"        
                                   and a.plant_code like :sap";
                if (strCust != "A76")
                    sql += "        and a.FPY_FLAG = 'Y' ";
                sql += @"           group by " + sqlType2 + "," + sqlType1 + @" ) x,
                                (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input ," + sqlType1 + @" as orderlogy  
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.bu_code='PCBG' and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"     
                                      group by " + sqlType2 + "," + sqlType1 + @" ) y                                       
                                where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            }
            else if (vType == "DUTY")
            {
                sql = @"select * from 
                            (select x.catalogy , 
                                   x.error_input as input,                                                                  
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end fpy ,x.orderlogy                                     
                                from 
                            (select" + sqlType2 + @" as catalogy,  
                                       count(0) error_input," + sqlType1 + @" as orderlogy  
                                  from sfis1.c_data_dictionary_t g,sfism4.r_repair_info_t w, 
                                       (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a 
                                 where a.serial_number = w.serial_number
                                   and a.item_no = w.item_no and a.process='FATP' 
                                   and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + @"
                                    and a.plant_code like :sap ";
                if (strCust != "A76")
                    sql += "        and a.FPY_FLAG = 'Y' ";
                sql += @"           and w.duty_type = g.data_code and g.data_type = 'DUTY_TYPE'
                                    group by " + sqlType2 + "," + sqlType1 + @") x,
                            (select" + sqlType2 + @" as catalogy,  
                                NVL(sum(a.output_qty), 0) as input," + sqlType1 + @" as orderlogy
                            from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                        ), a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a
                             where a.bu_code = 'PCBG' and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + @"
                                   and a.plant_code like :sap and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"
                                    group by " + sqlType2 + "," + sqlType1 + @") y
                            where x.catalogy = y.catalogy
                            ) a order by orderlogy ";
            }
            else if (vType == "STATION")
            {
                if (vType == "LINE" || vType2 == "LINE")
                    sql = @"select * from 
                             (select
                                x.catalogy,
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end fpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty)+sum(a.refail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty)+sum(a.refail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a,sfis1.c_line_def_t c
                                    where a.plant_code like :sap     
                                          and instr(:cust,a.cust_no ) > 0                         
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%'
                                          and a.line_name=c.mes_line
                                          and c.main_process='FATP' " + sql1 + strExSql + @"        
                                          and a.group_name = d.data_code
                                          and d.data_type = 'FPY_GROUP'
                                          and((a.line_name not like '%REP%') or
                                        (a.line_name like '%REP%' and
                                         TRIM(a.group_name) not in
                                         ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL', 'TPDL_IN')))
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         and a.group_name not like '%OFF'
                                         and a.group_name not like '%_BR%'
                                         and a.line_name not like '%TNB%'                                      
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like:sap
                                              and a.bu_code = 'PCBG'
                                              and instr(:cust,a.cust_no ) > 0 " + sql4 + strExSql + @"
                                              and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"                                           
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
                else
                    sql = @"select * from 
                             (select
                                x.catalogy,
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end fpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty)+sum(a.refail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty)+sum(a.refail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap     
                                          and instr(:cust,a.cust_no ) > 0                         
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + @"        
                                          and a.group_name = d.data_code
                                          and d.data_type = 'FPY_GROUP'
                                          and((a.line_name not like '%REP%') or
                                        (a.line_name like '%REP%' and
                                         TRIM(a.group_name) not in
                                         ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL', 'TPDL_IN')))
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         and a.group_name not like '%OFF'
                                         and a.group_name not like '%_BR%'
                                         and a.line_name not like '%TNB%'                                      
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like:sap
                                              and a.bu_code = 'PCBG'
                                              and instr(:cust,a.cust_no ) > 0 " + sql4 + strExSql + @"
                                              and a.process = 'FATP' " + getSubProcess(strMProcess, strCust) + @"                                           
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            }
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            ht.Add("qcond", vSDate);
            ht.Add("qcond2", vEDate);

            if (vTypeCond != "" && vType != "ERROR" && vType != "ERRORT")
            {
                if (vType == "DUTY")
                {
                    if (vTypeCond == "作業不良" || vTypeCond == "材料不良" || vTypeCond == "設計不良")
                        ht.Add("typecond", vTypeCond.Substring(0, 2));
                    else
                        ht.Add("typecond", vTypeCond);
                }
                else
                    ht.Add("typecond", vTypeCond);
            }
            if (vTypeCond2 != "")
                ht.Add("typecond2", vTypeCond2);
            if (vTypeCond3 != "")
                ht.Add("typecond3", vTypeCond3);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataTrendSMT(string vPlant, string vSapPlant, string vDateType, string vSDate, string vEDate, string vType, string vTypeCond, string vType2, string vTypeCond2, string vType3, string vTypeCond3)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sql3 = "", sqlType1 = "", sqlType2 = "";
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            sql3 = " and a.work_date between :qcond and :qcond2 ";
            if (vDateType == "Daily")
            {
                sqlType1 = " a.work_date ";
                sqlType2 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType1 = " to_char(to_date(a.work_date,'YYYYMMDD'),'IYYYIW') ";
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
            }
            else
            {
                sqlType1 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
                sqlType2 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
            }
            if (strShift != "ALL")
            {
                sql1 += " and a.shift_period = :shift ";
                sql3 += " and a.shift_period = :shift ";
            }
            if (vTypeCond != "")
            {
                if (vType == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond ";
                    if (vTypeCond.IndexOf("PCB") > -1)
                        strMProcess = "PCB";
                }
                else if (vType == "LOB")
                    sql1 += @" and a.model_serial =:typecond ";
                else if (vType == "MODEL")
                    sql1 += @" and a.model_name =:typecond  ";
                else if (vType == "STATION")
                    sql1 += @" and d.data_value =:typecond  ";
            }
            if (vTypeCond2 != "")
            {
                if (vType2 == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond2 ";
                    if (vTypeCond2.IndexOf("PCB") > -1)
                        strMProcess = "PCB";
                }
                else if (vType2 == "LOB")
                    sql1 += @" and a.model_serial =:typecond2 ";
                else if (vType2 == "MODEL")
                    sql1 += @" and a.model_name =:typecond2 ";
            }
            if (vTypeCond3 != "")
            {
                if (vType3 == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond3 ";
                    if (vTypeCond2.IndexOf("PCB") > -1)
                        strMProcess = "PCB";
                }
                else if (vType3 == "LOB")
                    sql1 += @" and a.model_serial =:typecond3 ";
                else if (vType3 == "MODEL")
                    sql1 += @" and a.model_name =:typecond3 ";
            }
            if (vPlant == "KSP2")
                sql2 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
                sql2 += @" and a.line_name like '3%' ";
            else if (vPlant == "KSP4")
                sql2 += @" and a.line_name like '4%' ";
            string sql = "";
            if (vType == "LINE")
                sql = @" select " + sqlType2 + @" as catalogy,  
                                     NVL(sum(a.output_qty), 0) as input,
                                    case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end fpy ," + sqlType1 + @" as orderlogy 
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                                 where  a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code   
                                    " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap 
                                 group by " + sqlType2 + "," + sqlType1 + @" order by orderlogy ";
            else if (vType == "LOB" || vType == "MODEL" || vType == "")
                sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy ,x.orderlogy 
                                from                             
                                (select " + sqlType2 + @" as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) as error_input ," + sqlType1 + @" as orderlogy 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a
                                 where a.bu_code='PCBG' " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and a.process='SMT'                                         
                                 group by " + sqlType2 + "," + sqlType1 + @" ) x,
                                (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a
                                where a.bu_code='PCBG' " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"      
                                      group by " + sqlType2 + "," + sqlType1 + @" ) y                                       
                                where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            else if (vType == "STATION")
                sql = @"select * from 
                             (select
                                x.catalogy,
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end fpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty)+sum(a.refail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty)+sum(a.refail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t d, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a ,sfis1.c_line_def_t c
                                    where a.plant_code like :sap                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db like '%SMT%' 
                                          and a.line_name=c.mes_line
                                          and c.main_process='SMT' " + sql1 + strExSql + @"        
                                         and a.group_name = d.data_code
                                         and d.data_type = 'FPY_GROUP_SMT'                                          
                                         and a.wo_master='YES'
                                         and a.group_name not like '%_BR'
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         AND a.GROUP_NAME NOT LIKE 'TNB%'
                                         AND a.GROUP_NAME NOT LIKE 'VE%'
                                         AND a.GROUP_NAME NOT LIKE 'VI%'
                                         AND a.GROUP_NAME NOT LIKE 'AI%'
                                         AND a.GROUP_NAME NOT LIKE 'SMT_VI%'
                                         AND a.GROUP_NAME NOT LIKE 'SUB%'  
                                         AND a.GROUP_NAME NOT LIKE 'SPI%' 
                                         AND a.GROUP_NAME NOT LIKE 'PRE_A%'                                        
                                         and a.line_name not like '%TNB%'                                         
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like:sap
                                              and a.bu_code = 'PCBG' " + sql3 + strExSql + @"
                                              and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"                                
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            ht.Add("qcond", vSDate);
            ht.Add("qcond2", vEDate);

            if (vTypeCond != "")
                ht.Add("typecond", vTypeCond);
            if (vTypeCond2 != "")
                ht.Add("typecond2", vTypeCond2);
            if (vTypeCond3 != "")
                ht.Add("typecond3", vTypeCond3);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataTrendInsightSMT(string vPlant, string vSapPlant, string vDateType, string vSDate, string vEDate, string vType, string vTypeCond, string vType2, string vTypeCond2, string vType3, string vTypeCond3)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sql3 = "", sqlType1 = "", sqlType2 = "";
            string strShift = "", strCust = "", strMProcess = "SMT";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            if (vDateType == "Daily")
            {
                sqlType1 = " a.work_date ";
                sqlType2 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType1 = " to_char(to_date(a.work_date,'YYYYMMDD'),'IYYYIW') ";
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
            }
            else
            {
                sqlType1 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
                sqlType2 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
            }
            if (strShift != "ALL")
            {
                sql1 += " and a.shift_period = :shift ";
            }
            if (vTypeCond != "")
            {
                if (vType == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond ";
                    if (vTypeCond.IndexOf("PCB") > -1)
                        strMProcess = "PCB";
                }
                else if (vType == "LOB")
                    sql1 += @" and a.model_serial =:typecond ";
                else if (vType == "MODEL")
                    sql1 += @" and a.model_name =:typecond  ";
                else if (vType == "STATION" || vType == "STATIONGAP")
                    sql3 += @" and e.data_code =:typecond  ";
            }
            if (vTypeCond2 != "")
            {
                if (vType2 == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond2 ";
                    if (vTypeCond2.IndexOf("PCB") > -1)
                        strMProcess = "PCB";
                }
                else if (vType2 == "LOB")
                    sql1 += @" and a.model_serial =:typecond2 ";
                else if (vType2 == "MODEL")
                    sql1 += @" and a.model_name =:typecond2 ";
            }
            if (vTypeCond3 != "")
            {
                if (vType3 == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond3 ";
                    if (vTypeCond3.IndexOf("PCB") > -1)
                        strMProcess = "PCB";
                }
                else if (vType3 == "LOB")
                    sql1 += @" and a.model_serial =:typecond3 ";
                else if (vType3 == "MODEL")
                    sql1 += @" and a.model_name =:typecond3 ";
            }
            if (vPlant == "KSP2")
                sql1 += @" and a.line_name like '2%' ";
            else if (vPlant == "KSP3")
            {
                sql1 += " AND a.from_db='KS_SMT' ";
                sql1 += @" and a.line_name like '3%' ";
            }
            else if (vPlant == "KSP4")
                sql1 += @" and a.line_name like '4%' ";
            else if (vPlant == "VNP1")
            {
                sql1 += " AND a.from_db='CHV_SMT' ";
            }
            else if (vPlant == "CDP1")
            {
                sql1 += " AND a.from_db='CD_SMT' ";
            }
            string sql = "";
            if (vType == "LINE")
                sql = @" select " + sqlType2 + @" as catalogy,  
                                     NVL(sum(a.output_qty), 0) as input,
                                    case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.gap_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.gap_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end Insightfpy ," + sqlType1 + @" as orderlogy 
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                                 where  a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code   
                                    " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap 
                                 group by " + sqlType2 + "," + sqlType1 + @" order by orderlogy ";
            else if (vType == "LOB" || vType == "MODEL" || vType == "")
                sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end Insightfpy ,x.orderlogy 
                                from                             
                                (select " + sqlType2 + @" as catalogy,  
                                   NVL(sum(a.gap_qty), 0) as error_input ," + sqlType1 + @" as orderlogy 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code='PCBG' " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and a.process='SMT'                                      
                                 group by " + sqlType2 + "," + sqlType1 + @" ) x,
                                (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.bu_code='PCBG' " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"  
                                      group by " + sqlType2 + "," + sqlType1 + @" ) y                                       
                                where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            else if (vType == "STATION")
                sql = @"select * from 
                             (select
                                x.catalogy,
                                nvl(y.input, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t e,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where d.model_name=substr(a.model_name,0,5) and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a,sfis1.c_line_def_t c 
                                    where a.plant_code like :sap                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db like '%SMT%' 
                                          and a.line_name=c.mes_line
                                          and c.main_process='SMT' " + sql1 + strExSql + sql3 + @"        
                                          and a.group_name = e.data_value                                           
                                          and e.data_type = 'FPY_GROUP_INSIGHT_SMT'                                          
                                          and a.wo_master='YES'                                  
                                          and a.line_name not like '%TNB%'                                    
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like:sap
                                              and a.bu_code = 'PCBG' " + sql1 + strExSql + sql2 + @"
                                              and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"                
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            else if (vType == "STATIONGAP")
                sql = @"select t1.catalogy,nvl(t1.insightfpy,0) as insightfpy,nvl(t2.fpy,0) as fpy,(nvl(t2.fpy,0)-nvl(t1.insightfpy,0)) as gap from 
                             (select
                                x.catalogy,
                                nvl(y.input, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a ,sfis1.c_line_def_t c 
                                    where a.plant_code like :sap                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db like '%SMT%' 
                                          and a.line_name=c.mes_line
                                          and c.main_process='SMT' " + sql1 + strExSql + sql3 + @"        
                                          and a.group_name = e.data_value                                          
                                          and e.data_type = 'FPY_GROUP_INSIGHT_SMT'                                          
                                          and a.wo_master='YES'                                  
                                          and a.line_name not like '%TNB%'                                         
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like:sap
                                              and a.bu_code = 'PCBG' " + sql1 + strExSql + sql2 + @"
                                              and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"              
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) t1
                            left outer join
                                    (select * from 
                             (select
                                x.catalogy,
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end fpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty)+sum(a.refail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a ,sfis1.c_line_def_t c
                                    where a.plant_code like :sap                          
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db like '%SMT%' 
                                          and a.line_name=c.mes_line
                                          and c.main_process='SMT' " + sql1 + strExSql + sql3 + @"        
                                   and a.group_name = e.data_code
                                         and e.data_type = 'FPY_GROUP_SMT'                                          
                                         and a.wo_master='YES'
                                         and a.group_name not like '%_BR'
                                         and a.group_name not like 'REPAIR%'
                                         and a.group_name not like 'OFFLINE%'
                                         AND a.GROUP_NAME NOT LIKE 'TNB%'
                                         AND a.GROUP_NAME NOT LIKE 'VE%'
                                         AND a.GROUP_NAME NOT LIKE 'VI%'
                                         AND a.GROUP_NAME NOT LIKE 'AI%'
                                         AND a.GROUP_NAME NOT LIKE 'SMT_VI%'
                                         AND a.GROUP_NAME NOT LIKE 'SUB%'  
                                         AND a.GROUP_NAME NOT LIKE 'SPI%' 
                                         AND a.GROUP_NAME NOT LIKE 'PRE_A%'                                        
                                         and a.line_name not like '%TNB%'                                         
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap
                                              and a.bu_code = 'PCBG' " + sql1 + strExSql + sql2 + @"
                                              and a.process='SMT' " + getSubProcess(strMProcess, strCust) + @"                           
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) ) t2                                     
                                    on t1.catalogy=t2.catalogy and t1.orderlogy=t2.orderlogy  order by t1.orderlogy";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            ht.Add("qcond", vSDate);
            ht.Add("qcond2", vEDate);

            if (vTypeCond != "")
                ht.Add("typecond", vTypeCond);
            if (vTypeCond2 != "")
                ht.Add("typecond2", vTypeCond2);
            if (vTypeCond3 != "")
                ht.Add("typecond3", vTypeCond3);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataTrendInsight(string vPlant, string vSapPlant, string vDateType, string vSDate, string vEDate, string vType, string vTypeCond, string vType2, string vTypeCond2, string vType3, string vTypeCond3)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sql3 = "", sqlType1 = "", sqlType2 = "";
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            if (vDateType == "Daily")
            {
                sqlType1 = " a.work_date ";
                sqlType2 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType1 = " to_char(to_date(a.work_date,'YYYYMMDD'),'IYYYIW') ";
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
            }
            else
            {
                sqlType1 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
                sqlType2 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
            }
            if (strShift != "ALL")
            {
                sql1 += " and a.shift_period = :shift ";
            }
            if (vTypeCond != "")
            {
                if (vType == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond ";
                    if (vTypeCond.IndexOf("PACK") > -1)
                        strMProcess = "PACK";
                }
                else if (vType == "LOB")
                    sql1 += @" and a.model_serial =:typecond ";
                else if (vType == "MODEL")
                    sql1 += @" and a.model_name =:typecond  ";
                else if (vType == "STATION" || vType == "STATIONGAP")
                    sql3 += @" and e.data_code =:typecond  ";
            }
            if (vTypeCond2 != "")
            {
                if (vType2 == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond2 ";
                    if (vTypeCond2.IndexOf("PACK") > -1)
                        strMProcess = "PACK";
                }
                else if (vType2 == "LOB")
                    sql1 += @" and a.model_serial =:typecond2 ";
                else if (vType2 == "MODEL")
                    sql1 += @" and a.model_name =:typecond2 ";
            }
            if (vTypeCond3 != "")
            {
                if (vType3 == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond3 ";
                    if (vTypeCond3.IndexOf("PACK") > -1)
                        strMProcess = "PACK";
                }
                else if (vType3 == "LOB")
                    sql1 += @" and a.model_serial =:typecond3 ";
                else if (vType3 == "MODEL")
                    sql1 += @" and a.model_name =:typecond3 ";
            }
            string sql = "";
            if (vType == "LINE")
                sql = @" select " + sqlType2 + @" as catalogy,  
                                     NVL(sum(a.output_qty), 0) as input,
                                    case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.gap_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end Insightfpy ," + sqlType1 + @" as orderlogy 
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                                 where  a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code   
                                    " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and instr(:cust,a.cust_no ) > 0       
                                 group by " + sqlType2 + "," + sqlType1 + @" order by orderlogy ";
            else if (vType == "LOB" || vType == "MODEL" || vType == "")
                sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end Insightfpy ,x.orderlogy 
                                from                             
                                (select " + sqlType2 + @" as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) as error_input ," + sqlType1 + @" as orderlogy 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code='PCBG' " + sql1 + strExSql + sql2 + @" and instr(:cust,a.cust_no ) > 0            
                                   and a.plant_code like :sap and a.process='FATP'                                      
                                 group by " + sqlType2 + "," + sqlType1 + @" ) x,
                                (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.bu_code='PCBG' " + sql1 + strExSql + sql2 + @" and instr(:cust,a.cust_no ) > 0                    
                                   and a.plant_code like :sap and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"  
                                      group by " + sqlType2 + "," + sqlType1 + @" ) y                                       
                                where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            else if (vType == "STATION")
                sql = @"select * from 
                             (select
                                x.catalogy,
                                nvl(y.input, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t e,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where d.model_name=substr(a.model_name,0,5) and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap   
                                          and instr(:cust,a.cust_no ) > 0                              
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + sql3 + @"    
                                          and a.group_name = e.data_value                                           
                                          and e.data_type = 'FPY_GROUP_INSIGHT'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU_BR', 'STRU2_BR', 'AFT_BR', 'TFF_BR', 'TPDL_BR', 'TPDL_IN_BR')))                                     
                                          and a.line_name not like '%TNB%'                                             
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like:sap and instr(:cust,a.cust_no ) > 0                     
                                              and a.bu_code = 'PCBG' " + sql1 + strExSql + sql2 + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            else if (vType == "STATIONGAP")
                sql = @"select t1.catalogy,nvl(t1.insightfpy,0) as insightfpy,nvl(t2.fpy,0) as fpy,CASE
                         WHEN t1.input = 0 THEN
                          0
                         ELSE
                          ROUND(ABS(nvl(t3.gap_qty,0)) / t1.input * 100,2)
                       END AS gap,t1.input,nvl(t3.gap_qty,0) as gap_qty from 
                             (select
                                x.catalogy,
                                nvl(y.input, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                               
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + sql3 + @"    
                                          and a.group_name = e.data_value                                           
                                          and e.data_type = 'FPY_GROUP_INSIGHT'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                          and a.line_name not like '%TNB%'                                           
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like:sap and instr(:cust,a.cust_no ) > 0   
                                              and a.bu_code = 'PCBG' " + sql1 + strExSql + sql2 + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"              
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) t1
                            left outer join
                                    (select * from 
                             (select
                                x.catalogy,
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end fpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty)+sum(a.refail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap  and instr(:cust,a.cust_no ) > 0                            
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + sql3 + @"        
                                          and a.group_name = e.data_value
                                          and e.data_type = 'FPY_GROUP_INSIGHT_FPY'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR'))) 
                                          and a.line_name not like '%TNB%'                                             
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0   
                                              and a.bu_code = 'PCBG' " + sql1 + strExSql + sql2 + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                           
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) ) t2                                     
                                    on t1.catalogy=t2.catalogy and t1.orderlogy=t2.orderlogy
                            left outer join
                             (select
                                x.catalogy,
                                nvl(x.fail_qty,0)-nvl(y.fail_qty,0) as gap_qty,
                                x.orderlogy from 
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                               
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + sql3 + @"    
                                          and a.group_name = e.data_value and e.data_desc=:plant                                                              
                                          and e.data_type = 'FPY_GROUP_GAP_PASS'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                          and a.line_name not like '%TNB%'                                           
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                               
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + sql3 + @"    
                                          and a.group_name = e.data_value  and e.data_desc=:plant                                                        
                                          and e.data_type = 'FPY_GROUP_GAP_FAIL'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                          and a.line_name not like '%TNB%'                                           
                                      group by " + sqlType2 + "," + sqlType1 + @"                                       
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) t3    
                             on t1.catalogy=t3.catalogy and t1.orderlogy=t3.orderlogy
                            order by t1.orderlogy";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            ht.Add("qcond", vSDate);
            ht.Add("qcond2", vEDate);

            if (vTypeCond != "")
                ht.Add("typecond", vTypeCond);
            if (vTypeCond2 != "")
                ht.Add("typecond2", vTypeCond2);
            if (vTypeCond3 != "")
                ht.Add("typecond3", vTypeCond3);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }
        public DataTable GetFpyDataTrendPcbLrr(string vPlant, string vSapPlant, string vDateType, string vSDate, string vEDate, string vType, string vTypeCond, string vType2 = "", string vTypeCond2 = "", string vType3 = "", string vTypeCond3 = "")
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string strFloorSql1 = "", strFloorSql2 = "", strFloor = "";
            string sql1 = "", sql2 = "", sql3 = "", sql4 = "", sqlType1 = "", sqlType2 = "";
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            sql4 = " and a.work_date between :qcond and :qcond2 ";
            if (vDateType == "Daily")
            {
                sqlType1 = " a.work_date ";
                sqlType2 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType1 = " to_char(to_date(a.work_date,'YYYYMMDD'),'IYYYIW') ";
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
            }
            else
            {
                sqlType1 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
                sqlType2 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
            }
            if (strShift != "ALL")
            {
                sql1 += " and a.shift_period = :shift ";
                sql4 += " and a.shift_period = :shift ";
            }
            if (vTypeCond != "")
            {
                if (vType == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond ";
                }
                else if (vType == "LOB")
                {
                    sql1 += @" and a.model_serial =:typecond ";
                    if (vTypeCond.IndexOf("-2F") > -1 || vTypeCond.IndexOf("-3F") > -1)
                    {
                        string[] bb = vTypeCond.Split('-');
                        for (int i = 0; i < bb.Length; i++)
                        {
                            if (i != bb.Length - 1)
                            {
                                if (i != 0)
                                    vTypeCond += "-" + bb[i];
                                else
                                    vTypeCond = bb[i];
                            }
                            else
                                strFloor = bb[i];
                        }
                        strFloorSql1 = " WHERE a.test_line IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                        strFloorSql2 = " WHERE a.line_name IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                    }
                }
                else if (vType == "MODEL")
                    sql1 += @" and a.model_name =:typecond ";
                else if (vType == "STATION")
                    sql2 += @" and a.test_group =:typecond  ";
                else if (vType == "DUTY")
                    sql2 += @" and a.duty_party =:typecond  ";
            }
            if (vTypeCond2 != "")
            {
                if (vType2 == "LINE")
                    sql1 += @" and a.line_name=:typecond2 ";
                else if (vType2 == "LOB")
                {
                    sql1 += @" and a.model_serial =:typecond2 ";
                    if (vTypeCond2.IndexOf("-2F") > -1 || vTypeCond2.IndexOf("-3F") > -1)
                    {
                        string[] bb = vTypeCond2.Split('-');
                        for (int i = 0; i < bb.Length; i++)
                        {
                            if (i != bb.Length - 1)
                            {
                                if (i != 0)
                                    vTypeCond2 += "-" + bb[i];
                                else
                                    vTypeCond2 = bb[i];
                            }
                            else
                                strFloor = bb[i];
                        }
                        strFloorSql1 = " WHERE a.test_line IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                        strFloorSql2 = " WHERE a.line_name IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                    }
                }
                else if (vType2 == "MODEL")
                    sql1 += @" and a.model_name =:typecond2 ";
            }
            if (vTypeCond3 != "")
            {
                if (vType3 == "LINE")
                    sql1 += @" and a.line_name=:typecond3 ";
                else if (vType3 == "LOB")
                {
                    sql1 += @" and a.model_serial =:typecond3 ";
                    if (vTypeCond3.IndexOf("-2F") > -1 || vTypeCond3.IndexOf("-3F") > -1)
                    {
                        string[] bb = vTypeCond3.Split('-');
                        for (int i = 0; i < bb.Length; i++)
                        {
                            if (i != bb.Length - 1)
                            {
                                if (i != 0)
                                    vTypeCond3 += "-" + bb[i];
                                else
                                    vTypeCond3 = bb[i];
                            }
                            else
                                strFloor = bb[i];
                        }
                        strFloorSql1 = " WHERE a.test_line IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                        strFloorSql2 = " WHERE a.line_name IN (SELECT mes_line FROM SFIS1.C_LINE_DEF_T WHERE DISPLAY_LINE=:floor) ";
                    }
                }
                else if (vType3 == "MODEL")
                    sql1 += @" and a.model_name =:typecond3 ";
            }
            if (vType == "ERROR")
            {
                if (vTypeCond == "ME")
                    sql3 = " and b.error_type in ('A','C','F') ";
                else if (vTypeCond == "EE")
                    sql3 = " and b.error_type in ('E') ";
                if (vType2 == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond2 ";
                    if (vTypeCond2.IndexOf("PACK") > -1)
                        strMProcess = "PACK";
                }
                else if (vType2 == "LOB")
                    sql1 += @" and a.model_serial =:typecond2 ";
            }
            string sql = "";
            if (vType == "LOB" || vType == "MODEL" || vType == "LINE" || vType == "STATION" || vType == "DUTY")
                sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 100, 2)
                                   end fpy  ,x.orderlogy 
                                from                             
                                (select " + sqlType2 + @" as catalogy,                                     
                                   NVL(sum(a.qty), 0) as error_input," + sqlType1 + @" as orderlogy  
                                 from (select a.*,a.test_line as line_name,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from sfism4.R_DAILY_PCBALRR_T a " + strFloorSql1 + @")a 
                                 where a.plant_code = (select p.mes_plant from sfis1.c_plant_def_t p where p.bu_code = 'PCBG' and p.rms_plant=:plant and rownum<=1) 
                                         and instr(:cust, a.cust_no ) > 0  " + sql1 + sql2 + @"       
                                 group by " + sqlType2 + "," + sqlType1 + @" ) x,
                                (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input ," + sqlType1 + @" as orderlogy  
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a " + strFloorSql2 + @")a  
                                where a.bu_code='PCBG' and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + @"        
                                   and a.plant_code like :sap  and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"     
                                      group by " + sqlType2 + "," + sqlType1 + @" ) y                                       
                                where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            else if (vType == "ERROR")
                sql = @"select * from 
                            (select x.catalogy,
                                   x.error_input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end fpy  ,x.orderlogy 
                                from                             
                                (select " + sqlType2 + @" as catalogy,  
                                   NVL(count(0),0) as error_input," + sqlType1 + @" as orderlogy  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_error_info_t a)a ,sfis1.c_error_desc_t b 
                                 where a.process='FATP' and a.test_code=b.error_code and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + sql3 + @"        
                                   and a.plant_code like :sap and a.fpy_flag='Y'                                         
                                 group by " + sqlType2 + "," + sqlType1 + @" ) x,
                                (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input ," + sqlType1 + @" as orderlogy  
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.bu_code='PCBG' and instr(:cust, a.cust_no ) > 0 " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"     
                                      group by " + sqlType2 + "," + sqlType1 + @" ) y                                       
                                where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            ht.Add("cust", strCust);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            ht.Add("qcond", vSDate);
            ht.Add("qcond2", vEDate);
            if (vTypeCond != "" && vType != "ERROR")
                ht.Add("typecond", vTypeCond);
            if (vTypeCond2 != "")
                ht.Add("typecond2", vTypeCond2);
            if (vTypeCond3 != "")
                ht.Add("typecond3", vTypeCond3);
            if (strFloor != "")
                ht.Add("floor", strFloor);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetFpyDataTrendGapInsight(string vPlant, string vSapPlant, string vDateType, string vSDate, string vEDate, string vType, string vTypeCond, string vType2, string vTypeCond2, string vType3, string vTypeCond3)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1 = "", sql2 = "", sql3 = "", sqlType1 = "", sqlType2 = "";
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "", strExType = "";
            if (vPlant.IndexOf("-") > -1)
            {
                string[] bb = vPlant.Split('-');
                vPlant = bb[0];
                strExType = bb[1];
                //strExSql = " and a.model_serial like :ex1 ";
                if (strExType == "DOCK")
                    strExSql = " and (a.prod_type in ('DOCKING') or a.cust_no='A76')";
                else
                    strExSql = " and (a.prod_type IN ('PAD', 'NB', 'AIO') or a.cust_no='A76')";
            }
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            sql1 = " and a.work_date between :qcond and :qcond2 ";
            if (vDateType == "Daily")
            {
                sqlType1 = " a.work_date ";
                sqlType2 = " a.work_date ";
            }
            else if (vDateType == "Weekly")
            {
                sqlType1 = " to_char(to_date(a.work_date,'YYYYMMDD'),'IYYYIW') ";
                sqlType2 = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
            }
            else
            {
                sqlType1 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
                sqlType2 = "substr(a.work_date,1,4)|| 'M'|| substr(a.work_date,5,2) ";
            }
            if (strShift != "ALL")
            {
                sql1 += " and a.shift_period = :shift ";
            }
            if (vTypeCond != "")
            {
                if (vType == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond ";
                    if (vTypeCond.IndexOf("PACK") > -1)
                        strMProcess = "PACK";
                }
                else if (vType == "LOB")
                    sql1 += @" and a.model_serial =:typecond ";
                else if (vType == "MODEL")
                    sql1 += @" and a.model_name =:typecond  ";
                else if (vType == "STATION")
                    sql3 += @" and a.group_name =:typecond  ";
                else if (vType == "STATIONGAP")
                    sql3 += @" and e.data_code =:typecond  ";
                // sql3 += @" and a.group_name =:typecond  ";
            }
            if (vTypeCond2 != "")
            {
                if (vType2 == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond2 ";
                    if (vTypeCond2.IndexOf("PACK") > -1)
                        strMProcess = "PACK";
                }
                else if (vType2 == "LOB")
                    sql1 += @" and a.model_serial =:typecond2 ";
                else if (vType2 == "MODEL")
                    sql1 += @" and a.model_name =:typecond2 ";
            }
            if (vTypeCond3 != "")
            {
                if (vType3 == "LINE")
                {
                    sql1 += @" and a.line_name=:typecond3 ";
                    if (vTypeCond3.IndexOf("PACK") > -1)
                        strMProcess = "PACK";
                }
                else if (vType3 == "LOB")
                    sql1 += @" and a.model_serial =:typecond3 ";
                else if (vType3 == "MODEL")
                    sql1 += @" and a.model_name =:typecond3 ";
            }
            string sql = "";
            if (vType == "LINE")
                sql = @" select " + sqlType2 + @" as catalogy,
                                     case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.gap_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end fpy , 
                                    case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.gap_qty), 0) then
                                      0
                                     else
                                      round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2)
                                   end Insightfpy ,  
                                     case
                                     when NVL(sum(a.output_qty), 0) = 0 then
                                      0
                                     when NVL(sum(a.output_qty), 0) < NVL(sum(a.gap_qty), 0) then
                                      0
                                     else
                                     round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2) - round((1 - NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) / NVL(sum(a.output_qty), 0)) * 100, 2) 
                                   end gap , 
                                     NVL(sum(a.output_qty), 0) as input," + sqlType1 + @" as orderlogy 
                                  from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a,sfis1.c_line_def_t b,sfis1.c_plant_def_t c 
                                 where  a.line_name=b.mes_line and b.site_id=c.site_id and a.bu_code='PCBG' and a.bu_code=c.bu_code   
                                    " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and instr(:cust,a.cust_no ) > 0       
                                 group by " + sqlType2 + "," + sqlType1 + @" order by orderlogy ";
            else if (vType == "LOB" || vType == "MODEL")
                sql = @"select * from 
                            (select x.catalogy,
                                   y.input as input,                                   
                                   case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((1 - x.error_input / y.input) * 100, 2)
                                   end Insightfpy ,x.orderlogy 
                                from                             
                                (select " + sqlType2 + @" as catalogy,  
                                   NVL(sum(a.fail_qty + a.refail_qty + a.sp_fail_qty+a.gap_qty), 0) as error_input ," + sqlType1 + @" as orderlogy 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                 where a.bu_code='PCBG' " + sql1 + strExSql + sql2 + @" and instr(:cust,a.cust_no ) > 0            
                                   and a.plant_code like :sap and a.process='FATP'                                      
                                 group by " + sqlType2 + "," + sqlType1 + @" ) x,
                                (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                where a.bu_code='PCBG' " + sql1 + strExSql + sql2 + @"        
                                   and a.plant_code like :sap and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"  
                                      group by " + sqlType2 + "," + sqlType1 + @" ) y                                       
                                where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            else if (vType == "STATION")
                //sql = @"select * from 
                //             (select
                //                x.catalogy,
                //                nvl(y.input, 0) as input,
                //               case
                //                 when nvl(y.input, 0) = 0 then
                //                  0
                //                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                //                  0
                //                 else
                //                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                //               end Insightfpy,x.orderlogy from
                //                  (select " + sqlType2 + @" as catalogy,  
                //                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty) as output_qty,
                //                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                //                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                //                    from sfis1.c_data_dictionary_t e,(select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where d.model_name=substr(a.model_name,0,5) and d.plant_code=:plant and d.bu_code='PCBG'
                //                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a,sfis1.c_line_def_t c 
                //                    where a.plant_code like :sap   
                //                          and instr(:cust,a.cust_no ) > 0                              
                //                          and a.date_type='D'    
                //                          and a.mo_type = 'ZP01'        
                //                          and a.from_db not like '%SMT%' 
                //                          and a.line_name=c.mes_line
                //                          and c.main_process='FATP' " + sql1 + strExSql + sql3 + @"    
                //                          and a.group_name = e.data_value                                           
                //                          and e.data_type = 'FPY_GROUP_INSIGHT'                                          
                //                          and((a.line_name not like '%REP%') or
                //                            (a.line_name like '%REP%' and
                //                            TRIM(a.group_name) not in
                //                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                //                          and a.line_name not like '%TNB%'                                             
                //                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                //                      (select " + sqlType2 + @" as catalogy,  
                //                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                //                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                //                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                //                        where a.plant_code like:sap and instr(:cust,a.cust_no ) > 0                     
                //                              and a.bu_code = 'PCBG' " + sql1 + strExSql + sql2 + @"
                //                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                
                //                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                //                       ) y  
                //                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
                sql = @"select * from 
                             (select
                                x.catalogy,
                                nvl(y.input, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where d.model_name=substr(a.model_name,0,5) and d.plant_code=:plant and d.bu_code='PCBG'
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a,sfis1.c_line_def_t c 
                                    where a.plant_code like :sap   
                                          and instr(:cust,a.cust_no ) > 0                              
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' 
                                          and a.line_name=c.mes_line
                                          and c.main_process='FATP' " + sql1 + strExSql + sql3 + @"   
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                          and a.line_name not like '%TNB%'                                             
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like:sap and instr(:cust,a.cust_no ) > 0                     
                                              and a.bu_code = 'PCBG' " + sql1 + strExSql + sql2 + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) order by orderlogy";
            else if (vType == "STATIONGAP")
                sql = @"select t1.catalogy,nvl(t2.fpy,0) as fpy,nvl(t1.insightfpy,0) as insightfpy,CASE
                         WHEN t1.input = 0 THEN
                          0
                         ELSE
                          ROUND(ABS(nvl(t3.gap_qty,0)) / t1.input * 100,2)
                       END AS gap,t1.input from 
                             (select
                                x.catalogy,
                                nvl(y.input, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end Insightfpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                               
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + sql3 + @"    
                                          and a.group_name = e.data_value                                           
                                          and e.data_type = 'FPY_GROUP_INSIGHT'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                          and a.line_name not like '%TNB%'                                           
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like:sap and instr(:cust,a.cust_no ) > 0   
                                              and a.bu_code = 'PCBG' " + sql1 + strExSql + sql2 + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"              
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) t1
                            left outer join
                                    (select * from 
                             (select
                                x.catalogy,
                                nvl(x.fail_qty, 0) as input,
                               case
                                 when nvl(y.input, 0) = 0 then
                                  0
                                 when nvl(y.input, 0) < nvl(x.fail_qty, 0) then
                                  0
                                 else
                                  round((1 - NVL(x.fail_qty, 0) / nvl(y.input, 0)) * 100, 2)
                               end fpy,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty)+sum(a.refail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap  and instr(:cust,a.cust_no ) > 0                            
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + sql3 + @"        
                                          and a.group_name = e.data_value
                                          and e.data_type = 'FPY_GROUP_INSIGHT_FPY'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR'))) 
                                          and a.line_name not like '%TNB%'                                             
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input," + sqlType1 + @" as orderlogy 
                                        from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a)a 
                                        where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0   
                                              and a.bu_code = 'PCBG' " + sql1 + strExSql + sql2 + @"
                                              and a.process='FATP' " + getSubProcess(strMProcess, strCust) + @"                           
                                      group by " + sqlType2 + "," + sqlType1 + @"                                           
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) ) t2                                     
                                    on t1.catalogy=t2.catalogy and t1.orderlogy=t2.orderlogy  
                                left outer join
                                    (select
                                x.catalogy, nvl(x.fail_qty,0)-nvl(y.fail_qty,0) as gap_qty,x.orderlogy from
                                  (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a 
                                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                               
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + sql3 + @"    
                                          and a.group_name = e.data_value and e.data_desc=:plant                                      
                                          and e.data_type = 'FPY_GROUP_GAP_PASS'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                          and a.line_name not like '%TNB%'                                           
                                      group by " + sqlType2 + "," + sqlType1 + @" ) x,  
                                      (select " + sqlType2 + @" as catalogy,  
                                   sum(a.pass_qty+a.repass_qty)+sum(a.fail_qty) as output_qty,
                                         sum(a.pass_qty+a.repass_qty) as pass_qty,
                                         sum(a.fail_qty) as fail_qty ," + sqlType1 + @" as orderlogy                 
                                    from sfis1.c_data_dictionary_t e, (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name = d.model_name and d.plant_code=:plant and d.bu_code='PCBG'            
                                          ),a.model_name) as model_serial from sfism4.r_station_summary_t a)a  
                                    where a.plant_code like :sap and instr(:cust,a.cust_no ) > 0                                               
                                          and a.date_type='D'    
                                          and a.mo_type = 'ZP01'        
                                          and a.from_db not like '%SMT%' " + sql1 + strExSql + sql3 + @"    
                                          and a.group_name = e.data_value and e.data_desc=:plant                                             
                                          and e.data_type = 'FPY_GROUP_GAP_FAIL'                                          
                                          and((a.line_name not like '%REP%') or
                                            (a.line_name like '%REP%' and
                                            TRIM(a.group_name) not in
                                            ('STRU', 'STRU2', 'AFT', 'TFF', 'TPDL','TPDL_IN','STRU2_BR','AFT_BR','TPDL_BR')))                                     
                                          and a.line_name not like '%TNB%'                                           
                                      group by " + sqlType2 + "," + sqlType1 + @"                                         
                                       ) y  
                                    where x.catalogy=y.catalogy and x.orderlogy=y.orderlogy) t3
                                    on t1.catalogy=t3.catalogy and t1.orderlogy=t3.orderlogy  
                        order by t1.orderlogy";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            ht.Add("qcond", vSDate);
            ht.Add("qcond2", vEDate);

            if (vTypeCond != "")
            {
                if (vType == "STATIONGAP")
                    ht.Add("typecond", vTypeCond.Replace("_BR", ""));
                else
                    ht.Add("typecond", vTypeCond);
            }
            if (vTypeCond2 != "")
                ht.Add("typecond2", vTypeCond2);
            if (vTypeCond3 != "")
                ht.Add("typecond3", vTypeCond3);
            //if (strExType != "")
            //{
            //    if (strExType == "DOCK")
            //        ht.Add("ex1", "DOCK-%");
            //    else if (strExType == "NB")
            //        ht.Add("ex1", "NB-%");
            //}
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetHsrDataLV1(string vPlant, string vSapPlant, string vDateType, string vQCond, string vType, string vMprocess, string vProcess, string vOrderBy, string vOrderAsc, int vRows = 10)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1, sql2;
            string strShift = "", strCust = "", strMProcess = "FATP";
            string strExSql = "";

            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vType == "Tre" || vType == "TreExcel" || vDateType == "Weekly" || vDateType == "Range"||vType=="Dab"||vType=="DabExcel")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            string sql = "";
            string strTrend = "", strShowTrend, strShow = "";
            if (vOrderBy == "CASE")
                strShow = "nvl(z.caseqty,0) ";
            else
                strShow = "nvl(x.error_input,0) ";
            if (vType == "Tre" || vType == "TreExcel")
            {
                #region trend
                if (vDateType == "Daily" || vDateType == "Range")
                {
                    strTrend = " a.work_date ";
                    strShowTrend = " a.work_date ";
                }
                else if (vDateType == "Weekly")
                {
                    strShowTrend = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
                    strTrend = " to_char(to_date(a.work_date,'YYYYMMDD'),'YYYYIW') ";
                }
                else
                {
                    strShowTrend = "substr(a.work_date,1,4)||  'M'|| substr(a.work_date,5,2) ";
                    strTrend = "substr(a.work_date,1,4)||  'M'|| substr(a.work_date,5,2) ";
                }
                sql = @"select * from 
                            (select x.catalogy,  
                                    " + strShow + @" as input,                           
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 1000000)
                                   end DPPM  
                                from                             
                                (select " + strTrend + @" as catalogy,  
                                   NVL(sum(a.hold_qty), 0) as error_input,
                                   " + strShowTrend + @" as orderlogy  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                 where a.plant_code like :sap 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                     @"  group by " + strTrend + "," + strShowTrend + @") x
                            left outer join  
                                (select catalogy,count(error_input) as caseqty from 
                                    (select " + strTrend + @" as catalogy,  
                                   NVL(sum(a.hold_qty), 0) as error_input,
                                   " + strShowTrend + @" as orderlogy  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                 where a.plant_code like :sap 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                     @"  group by " + strTrend + "," + strShowTrend + @",a.control_id having NVL(sum(a.hold_qty), 0) >=30
                                         ) group by catalogy) z  
                                on x.catalogy=z.catalogy ,
                                (select " + strTrend + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input,
                                   " + strShowTrend + @" as orderlogy  
                                from (";

                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a";
                sql += @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 + strExSql +
                                     @"   and a.process=:process " + getSubProcess(strMProcess, strCust) +
                                     @"   group by " + strTrend + "," + strShowTrend + @") y                                   
                                where x.catalogy=y.catalogy order by x.orderlogy ";
                #endregion
            }
            else if (vType == "Lin" || vType == "Lob" || vType == "LobExcel" || vType == "LinExcel")
            {
                #region Line & Lob   
                if ((vType == "Lin" || vType == "LinExcel") && vProcess != "ALL")
                    sql2 = @" and a.sub_process=:sub ";
                else
                    sql2 = "";
                if (vType == "Lin" || vType == "LinExcel")
                    strTrend = "a.line_name";
                else if (vType == "Lob" || vType == "LobExcel")
                    strTrend = "a.model_serial";
                sql = @"select * from 
                            (select x.catalogy,  
                                    " + strShow + @" as input,                           
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 1000000)
                                   end DPPM  
                                from                             
                                (select " + strTrend + @" as catalogy,  
                                   NVL(sum(a.hold_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                 where a.plant_code like :sap 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 + sql2 +
                                     @"  group by " + strTrend + @") x
                                left outer join  
                                    (select catalogy,count(error_input) as caseqty from 
                                        (select " + strTrend + @" as catalogy,  
                                       NVL(sum(a.hold_qty), 0) as error_input 
                                     from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                              ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                     where a.plant_code like :sap 
                                            and instr(:cust,a.cust_no ) > 0 " + sql1 + sql2 +
                                     @"  group by " + strTrend + @",a.control_id having NVL(sum(a.hold_qty), 0) >=30
                                             ) group by catalogy) z  
                                        on  x.catalogy=z.catalogy  ,
                                (select " + strTrend + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input 
                                from (";

                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a";
                sql += @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 + strExSql +
                                     @"   and a.process=:process " + sql2;
                if (vType != "Lin" && vType != "LinExcel")
                    sql += getSubProcess(strMProcess, strCust);
                sql += @"           group by " + strTrend + @") y                                    
                                where x.catalogy=y.catalogy order by " + strShow;
                #endregion
            }
            else if (vType == "Hod" || vType == "HodExcel")
            {
                #region Hold Info       
                strTrend = "a.hold_info";
                sql = @"select * from 
                            (select x.catalogy,  
                                    " + strShow + @" as input,                           
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 1000000)
                                   end DPPM  
                                from                             
                                (select " + strTrend + @" as catalogy,  
                                   NVL(sum(a.hold_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                 where a.plant_code like :sap 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                     @"  group by " + strTrend + @") x
                                left outer join  
                                    (select catalogy,count(error_input) as caseqty from 
                                        (select " + strTrend + @" as catalogy,  
                                       NVL(sum(a.hold_qty), 0) as error_input 
                                     from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                              ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                     where a.plant_code like :sap 
                                            and instr(:cust,a.cust_no ) > 0 " + sql1 +
                                     @"  group by " + strTrend + @",a.control_id having NVL(sum(a.hold_qty), 0) >=30
                                             ) group by catalogy) z  
                                        on  x.catalogy=z.catalogy  ,
                                (select NVL(sum(a.output_qty),0) as input 
                                from (";

                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a";
                sql += @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 + strExSql +
                                     @"   and a.process=:process ";
                sql += @"          ) y                                    
                                 order by " + strShow;
                #endregion
            }
            else if (vType == "Dab" || vType == "DabExcel")
            {
                #region Dab Info
                sql = @"select  a.model_serial AS LOB,a.line_name,sum(a.hold_qty) as qty  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code='CDP1' 
                                          ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql+=@")a 
                                 where a.plant_code like :sap 
                                        and instr(:cust,a.cust_no ) > 0 "+sql1+@" 
                                    group by a.model_serial,a.line_name order by a.model_serial,a.line_Name
                        ";
                #endregion
            }
            if(!(vType=="Dab"||vType== "DabExcel"))
            {
                sql += vOrderAsc + @" ) a where dppm >0 ";
                if (vType.IndexOf("Excel") == -1)
                    sql += " and rownum <=:rowcount ";
            }
            

            ht.Clear();
            if (!(vType == "Dab" || vType == "DabExcel"))
            {
                ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
                ht.Add("process", vMprocess);
                if (vType.IndexOf("Excel") == -1)
                    ht.Add("rowcount", vRows);
            }

            ht.Add("cust", strCust);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vType == "Tre" || vType == "TreExcel")
            {
                DateTime dBaseDate;
                if (vDateType == "Daily")
                {
                    dBaseDate = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture);
                    ht.Add("qcond", dBaseDate.AddDays(-6).ToString("yyyyMMdd"));
                    ht.Add("qcond2", dBaseDate.ToString("yyyyMMdd"));
                }
                else if (vDateType == "Range")
                {
                    if (vQCond.IndexOf("-") > -1)
                    {
                        string[] cc = vQCond.Split('-');
                        ht.Add("qcond", cc[0]);
                        ht.Add("qcond2", cc[1]);
                    }
                    else
                    {
                        ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                        ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                    }
                }
                else if (vDateType == "Weekly")
                {
                    string strYear, strWeek;
                    string strCond = vQCond.Replace("W", "");
                    strYear = strCond.Substring(0, 4);
                    strWeek = strCond.Substring(4, 2);
                    DateTime sTime, eTime;
                    if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                    {
                        sTime = DateTime.Now.AddDays(-7);
                        eTime = DateTime.Now;
                    }
                    dBaseDate = sTime;
                    ht.Add("qcond", dBaseDate.AddDays(1 - Convert.ToInt32(dBaseDate.DayOfWeek.ToString("d"))).AddDays(-6 * 7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", dBaseDate.AddDays(1 - Convert.ToInt32(dBaseDate.DayOfWeek.ToString("d"))).AddDays(6).ToString("yyyyMMdd"));
                }
                else
                {
                    dBaseDate = DateTime.ParseExact(vQCond.Replace("M", "") + "01", "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture);
                    ht.Add("qcond", dBaseDate.AddMonths(-6).ToString("yyyyMM") + "01");
                    ht.Add("qcond2", DateTime.ParseExact(dBaseDate.AddMonths(1).ToString("yyyyMM") + "01", "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd"));
                }
            }
            else
            {
                if (vDateType == "Daily")
                    ht.Add("qcond", vQCond);
                else if (vDateType == "Weekly")
                {
                    string strYear, strWeek;
                    vQCond = vQCond.Replace("W", "");
                    strYear = vQCond.Substring(0, 4);
                    strWeek = vQCond.Substring(4, 2);
                    DateTime sTime, eTime;
                    if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                    {
                        sTime = DateTime.Now.AddDays(-7);
                        eTime = DateTime.Now;
                    }
                    ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                    ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
                }
                else if (vDateType == "Range")
                {
                    if (vQCond.IndexOf("-") > -1)
                    {
                        string[] cc = vQCond.Split('-');
                        ht.Add("qcond", cc[0]);
                        ht.Add("qcond2", cc[1]);
                    }
                    else
                    {
                        ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                        ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                    }
                }
                else
                    ht.Add("qcond", vQCond.Replace("M", "") + "%");
            }
            if ((vType == "Lin" || vType == "LinExcel") && vProcess != "ALL")
                ht.Add("sub", vProcess);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public DataTable GetHsrDetailData(string vPlant, string vSapPlant, string vDateType, string vQCond, string vType, string vMprocess, string vProcess, string qLv2Type, string qLv2Cond, string qLv3Type, string qLv3Cond, string vOrderBy, string vOrderAsc, int vRows = 10)
        {
            ExecutionResult exeRes = new ExecutionResult();
            exeRes.Status = true;
            exeRes.Message = string.Empty;
            Hashtable ht = new Hashtable();
            DataTable dtResult = new DataTable();
            string sql1, sql2 = "";
            string strShift = "", strCust = "", strMProcess = "FATP";
            string sql = "";
            string strTrend = "", strShowTrend = "", strShow = "";
            string[] aa = vDateType.Split('_');
            vDateType = aa[0];
            strShift = aa[1];
            strCust = getCust(vPlant);
            if (vType == "Tre" || vType == "TreExcel" || vDateType == "Weekly" || vDateType == "Range")
                sql1 = " and a.work_date between :qcond and :qcond2 ";
            else if (vDateType == "Daily")
                sql1 = " and a.work_date = :qcond ";
            else
                sql1 = " and a.work_date like :qcond ";
            if (strShift != "ALL")
                sql1 += " and a.shift_period = :shift ";
            if (qLv2Type == "LINE" || qLv3Type == "LINE")
                sql1 += " and a.line_name = :line ";
            if (qLv2Type == "MODEL" || qLv3Type == "MODEL")
                sql1 += " and a.model_name = :model ";
            if (qLv2Type == "HOLD" || qLv3Type == "HOLD")
                sql2 += " and a.hold_info = :hold ";
            if (qLv2Type == "LOB" || qLv3Type == "LOB")
                sql1 += " and a.model_serial = :lob ";
            if (vOrderBy == "CASE")
                strShow = "nvl(z.caseqty,0) ";
            else
                strShow = "nvl(x.error_input,0) ";
            if (vOrderAsc == "遞增")
                vOrderAsc = "ASC";
            else if (vOrderAsc == "遞減")
                vOrderAsc = "DESC";
            if (vType == "Tre" || vType == "TreExcel")
            {
                #region trend
                if (vDateType == "Daily" || vDateType == "Range")
                {
                    strTrend = " a.work_date ";
                    strShowTrend = " a.work_date ";
                }
                else if (vDateType == "Weekly")
                {
                    strShowTrend = " 'W'|| to_char(to_date(a.work_date,'YYYYMMDD'),'IW') ";
                    strTrend = " to_char(to_date(a.work_date,'YYYYMMDD'),'YYYYIW') ";
                }
                else
                {
                    strShowTrend = "substr(a.work_date,1,4)||  'M'|| substr(a.work_date,5,2) ";
                    strTrend = "substr(a.work_date,1,4)||  'M'|| substr(a.work_date,5,2) ";
                }
                sql = @"select * from 
                            (select x.catalogy,  
                                    " + strShow + @" as input,                           
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 1000000)
                                   end DPPM  
                                from                             
                                (select " + strTrend + @" as catalogy,  
                                   NVL(sum(a.hold_qty), 0) as error_input,
                                   " + strShowTrend + @" as orderlogy  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                 where a.plant_code like :sap 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 + sql2 +
                                     @"  group by " + strTrend + "," + strShowTrend + @") x
                            left outer join  
                                (select catalogy,count(error_input) as caseqty from 
                                    (select " + strTrend + @" as catalogy,  
                                   NVL(sum(a.hold_qty), 0) as error_input,
                                   " + strShowTrend + @" as orderlogy  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                 where a.plant_code like :sap 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 + sql2 +
                                     @"  group by " + strTrend + "," + strShowTrend + @",a.control_id having NVL(sum(a.hold_qty), 0) >=30
                                         ) group by catalogy) z  
                                on x.catalogy=z.catalogy ,
                                (select " + strTrend + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input,
                                   " + strShowTrend + @" as orderlogy  
                                from (";

                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a";
                sql += @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 +
                                     @"   and a.process=:process ";
                if (qLv2Type != "LINE" && qLv3Type != "LINE")
                    sql += getSubProcess(strMProcess, strCust);
                sql += @"   group by " + strTrend + "," + strShowTrend + @") y                                   
                                where x.catalogy=y.catalogy order by x.orderlogy ";
                #endregion
            }
            else if (vType == "Tab")
            {
                #region trend 
                sql = @"select a.control_id,a.hold_info,a.hold_desc,a.hold_qty,a.mntn_user as create_user,a.mntn_time as create_time,to_char(to_date(a.work_date,'yyyymmdd'),'yyyy/mm/dd')||' '|| a.shift_period as hold_date  
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                 where a.plant_code like :sap and a.process=:process 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 + sql2 + @"                                 
                                 order by a.hold_qty desc";
                #endregion
            }
            else if (vType == "Lin" || vType == "Lob" || vType == "Mod" || vType == "ModExcel" || vType == "LobExcel" || vType == "LinExcel")
            {
                #region Line & Lob   
                if ((vType == "Lin" || vType == "LinExcel") && vProcess != "ALL")
                    sql1 += @" and a.sub_process=:sub ";
                if (vType == "Lin" || vType == "LinExcel")
                    strTrend = "a.line_name";
                else if (vType == "Lob" || vType == "LobExcel")
                    strTrend = "a.model_serial";
                else if (vType == "Mod" || vType == "ModExcel")
                    strTrend = "a.model_name";
                sql = @"select * from 
                            (select x.catalogy,  
                                    " + strShow + @" as input,                           
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 1000000)
                                   end DPPM  
                                from                             
                                (select " + strTrend + @" as catalogy,  
                                   NVL(sum(a.hold_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                 where a.plant_code like :sap 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 + sql2 +
                                     @"  group by " + strTrend + @") x
                                left outer join  
                                    (select catalogy,count(error_input) as caseqty from 
                                        (select " + strTrend + @" as catalogy,  
                                       NVL(sum(a.hold_qty), 0) as error_input 
                                     from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                              ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                     where a.plant_code like :sap 
                                            and instr(:cust,a.cust_no ) > 0 " + sql1 + sql2 +
                                     @"  group by " + strTrend + @",a.control_id having NVL(sum(a.hold_qty), 0) >=30
                                             ) group by catalogy) z  
                                        on  x.catalogy=z.catalogy  ,
                                (select " + strTrend + @" as catalogy,  
                                    NVL(sum(a.output_qty),0) as input 
                                from (";

                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a";
                sql += @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 +
                                     @"   and a.process=:process ";
                if (vType != "Lin" && vType != "LinExcel" && qLv2Type != "LINE" && qLv3Type != "LINE")
                    sql += getSubProcess(strMProcess, strCust);
                sql += @"           group by " + strTrend + @") y                                    
                                where x.catalogy=y.catalogy order by " + strShow;
                #endregion
            }
            else if (vType == "Hod" || vType == "HodExcel")
            {
                #region Hold Info       
                strTrend = "a.hold_info";
                sql = @"select * from 
                            (select x.catalogy,  
                                    " + strShow + @" as input,                           
                                    case
                                     when y.input = 0 then
                                      0
                                     when y.input < x.error_input then
                                      0
                                     else
                                      round((x.error_input / y.input) * 1000000)
                                   end DPPM  
                                from                             
                                (select " + strTrend + @" as catalogy,  
                                   NVL(sum(a.hold_qty), 0) as error_input 
                                 from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                          ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                 where a.plant_code like :sap 
                                        and instr(:cust,a.cust_no ) > 0 " + sql1 + sql2 +
                                     @"  group by " + strTrend + @") x
                                left outer join  
                                    (select catalogy,count(error_input) as caseqty from 
                                        (select " + strTrend + @" as catalogy,  
                                       NVL(sum(a.hold_qty), 0) as error_input 
                                     from (select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant 
                                              ),a.model_name) as model_serial from SFISM4.R_HSR_HOLD_T a";
                sql += @")a 
                                     where a.plant_code like :sap 
                                            and instr(:cust,a.cust_no ) > 0 " + sql1 + sql2 +
                                     @"  group by " + strTrend + @",a.control_id having NVL(sum(a.hold_qty), 0) >=30
                                             ) group by catalogy) z  
                                        on  x.catalogy=z.catalogy  ,
                                (select NVL(sum(a.output_qty),0) as input 
                                from (";

                sql += @"select a.*,nvl((select d.model_serial from sfis1.c_model_serial_def_t d where a.model_name=d.model_name and d.plant_code=:plant and d.bu_code=a.bu_code
                                          ),a.model_name) as model_serial from sfism4.r_kpi_fpy_t a";
                sql += @")a 
                                where a.plant_code like :sap 
                                      and a.bu_code='PCBG' and instr(:cust,a.cust_no ) > 0  
                                      " + sql1 +
                                     @"   and a.process=:process ";
                sql += @"          ) y                                    
                                 order by " + strShow;
                #endregion
            }
            if (vType != "Tab")
                sql += vOrderAsc + @" ) a where dppm >0 ";
            if (vType.IndexOf("Excel") == -1 && vType != "Tab")
                sql += " and rownum <=10 ";
            ht.Clear();
            ht.Add("plant", vPlant.Replace("VN76", "VNP1"));
            ht.Add("cust", strCust);
            ht.Add("process", vMprocess);
            if (vSapPlant.IndexOf("CQ") > -1)
                ht.Add("sap", "CQ%");
            else if (vSapPlant.IndexOf("CD") > -1)
                ht.Add("sap", "CD%");
            else
                ht.Add("sap", vSapPlant);
            if (strShift != "ALL")
                ht.Add("shift", strShift);
            if (vType == "Tre" || vType == "TreExcel")
            {
                DateTime dBaseDate;
                if (vDateType == "Daily")
                {
                    dBaseDate = DateTime.ParseExact(vQCond, "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture);
                    ht.Add("qcond", dBaseDate.AddDays(-6).ToString("yyyyMMdd"));
                    ht.Add("qcond2", dBaseDate.ToString("yyyyMMdd"));
                }
                else if (vDateType == "Range")
                {
                    if (vQCond.IndexOf("-") > -1)
                    {
                        string[] cc = vQCond.Split('-');
                        ht.Add("qcond", cc[0]);
                        ht.Add("qcond2", cc[1]);
                    }
                    else
                    {
                        ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                        ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                    }
                }
                else if (vDateType == "Weekly")
                {
                    string strYear, strWeek;
                    string strCond = vQCond.Replace("W", "");
                    strYear = strCond.Substring(0, 4);
                    strWeek = strCond.Substring(4, 2);
                    DateTime sTime, eTime;
                    if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                    {
                        sTime = DateTime.Now.AddDays(-7);
                        eTime = DateTime.Now;
                    }
                    dBaseDate = sTime;
                    ht.Add("qcond", dBaseDate.AddDays(1 - Convert.ToInt32(dBaseDate.DayOfWeek.ToString("d"))).AddDays(-6 * 7).ToString("yyyyMMdd"));
                    ht.Add("qcond2", dBaseDate.AddDays(1 - Convert.ToInt32(dBaseDate.DayOfWeek.ToString("d"))).AddDays(6).ToString("yyyyMMdd"));
                }
                else
                {
                    dBaseDate = DateTime.ParseExact(vQCond.Replace("M", "") + "01", "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture);
                    ht.Add("qcond", dBaseDate.AddMonths(-6).ToString("yyyyMM") + "01");
                    ht.Add("qcond2", DateTime.ParseExact(dBaseDate.AddMonths(1).ToString("yyyyMM") + "01", "yyyyMMdd", System.Globalization.CultureInfo.CurrentCulture).AddDays(-1).ToString("yyyyMMdd"));
                }
            }
            else
            {
                if (vDateType == "Daily")
                    ht.Add("qcond", vQCond);
                else if (vDateType == "Weekly")
                {
                    string strYear, strWeek;
                    vQCond = vQCond.Replace("W", "");
                    strYear = vQCond.Substring(0, 4);
                    strWeek = vQCond.Substring(4, 2);
                    DateTime sTime, eTime;
                    if (!WorkDateConvert.GetDaysOfWeeks(Int32.Parse(strYear), Int32.Parse(strWeek), System.Globalization.CalendarWeekRule.FirstFourDayWeek, out sTime, out eTime, mClientInfo))
                    {
                        sTime = DateTime.Now.AddDays(-7);
                        eTime = DateTime.Now;
                    }
                    ht.Add("qcond", sTime.ToString("yyyyMMdd"));
                    ht.Add("qcond2", eTime.ToString("yyyyMMdd"));
                }
                else if (vDateType == "Range")
                {
                    if (vQCond.IndexOf("-") > -1)
                    {
                        string[] cc = vQCond.Split('-');
                        ht.Add("qcond", cc[0]);
                        ht.Add("qcond2", cc[1]);
                    }
                    else
                    {
                        ht.Add("qcond", DateTime.Now.AddDays(-7).ToString("yyyyMMdd"));
                        ht.Add("qcond2", DateTime.Now.ToString("yyyyMMdd"));
                    }
                }
                else
                    ht.Add("qcond", vQCond.Replace("M", "") + "%");
            }
            if ((vType == "Lin" || vType == "LinExcel") && vProcess != "ALL")
                ht.Add("sub", vProcess);
            if (qLv3Type == "LINE")
                ht.Add("line", qLv3Cond);
            if (qLv2Type == "LINE")
                ht.Add("line", qLv2Cond);
            if (qLv3Type == "MODEL")
                ht.Add("model", qLv3Cond);
            if (qLv2Type == "MODEL")
                ht.Add("model", qLv2Cond);
            if (qLv3Type == "HOLD")
                ht.Add("hold", qLv3Cond);
            if (qLv2Type == "HOLD")
                ht.Add("hold", qLv2Cond);
            if (qLv3Type == "LOB")
                ht.Add("lob", qLv3Cond);
            if (qLv2Type == "LOB")
                ht.Add("lob", qLv2Cond);
            try
            {
                exeRes = mDBTools.ExecuteQueryDSHt(sql, ht);
                if (exeRes.Status)
                {
                    DataSet ds = (DataSet)exeRes.Anything;
                    if (ds != null && ds.Tables.Count > 0 && ds.Tables[0] != null)
                    {
                        dtResult = ds.Tables[0];
                    }
                }
            }
            catch (Exception ex)
            {
                exeRes.Status = false;
                exeRes.Message = ex.Message;
            }
            return dtResult;
        }

        public string getSapPlant(string vPlant)
        {
            string res = "";
            Hashtable ht = new Hashtable();
            string sql = @"select b.sap_plant 
                            from sfis1.c_plant_def_t b 
                            where b.rms_plant=:plant and b.bu_code='PCBG'  ";
            ht.Clear();
            ht.Add("plant", vPlant);
            try
            {
                res = mDBTools.ExecuteQueryStrHt(sql, ht);
            }
            catch
            {
                res = "";
            }
            return res;
        }
    }
}